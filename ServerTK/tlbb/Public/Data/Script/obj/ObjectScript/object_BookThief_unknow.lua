--ÐÂÐþÎäµºÈë¿Ú¶Ô»°½Å±¾
--

x807003_g_scriptId = 807003

x807003_tipinbox = 1
x807003_g_limitMembers = 3        --ÈËÊýÏÞÖÆ
x807003_g_Low_Level = 85           --µÈ¼¶ÏÞÖÆ
x807003_g_Low_Level_xinfa = 50           --ÐÄ·¨ÏÞÖÆ
x807003_g_NoUserTime = 3              --¸±±¾ÖÐÃ»ÓÐÈËºó¿ÉÒÔ¼ÌÐø±£´æµÄÊ±¼ä£¨µ¥Î»: Ãë£©,²»ÖªµÀÕâ¸öÖµ¶Ô²»¶Ô£¿
x807003_g_tickDiffTime = 1              --»Øµ÷½Å±¾µÄÊ±ÖÓÊ±¼ä£¨µ¥Î»: Ãë/´Î£©
x807003_g_CopySceneType = FUBEN_XINSHENGSHOUSHAN        --¸±±¾ÀàÐÍ£¬¶¨ÒåÔÚScriptGlobal.luaÀïÃæ

x807003_g_FubenTbl =
{
	FubenName = "Tân Huy«n Vû Ðäo",
	MapFile = "petisland_3.nav",
	monsterId = 22130,
	bossId = 22190,  --Hµ Ðäo Th¥n Thú
	AreaFile = "petisland_3_area.ini", 
	MonsterFile = "petisland_3_monster.ini",
	Fuben_start_x = 94,
	Fuben_start_z = 77,
}

x807003_monster_chufeng = {ID = 22270, Aitype = 0, AiscriptId = 0, scriptId = 807003, name = "Lôi Lân Trß·ng Thành"}     --³û·ï
x807003_monster_leilin = {ID = 222480, Aitype = 0, AiscriptId = 0, scriptId = 807003, name = "S° Phøng Trß·ng Thành"}      --À×÷ë
x807003_monster_xudaoshenshou = {ID = 22648, Aitype = 0, AiscriptId = 136, scriptId = 807003, name = "Hµ Ðäo Th¥n Thú"}   --Hµ Ðäo Th¥n Thú
x807003_monster_feitianmao = {ID = 222718, Aitype = 0, AiscriptId = 270, scriptId = 807003, name = "Vô Ð¸ch Thiên Miêu"}   --Vô Ð¸ch Thiên Miêu
x807003_monster_xiaozhuzhu = {ID = 22788, Aitype = 0, AiscriptId = 212, scriptId = 807003, name = "Ti¬u Trß Trß"}   --Ð¡ÖíÖí
x807003_monster_xiaohuhu = {ID = 22858, Aitype = 0, AiscriptId = 215, scriptId = 807003, name = "Ti¬u Trß Trß"}   --Ti¬u Trß Trß
x807003_monster_xiaoyingying = {ID = 22928, Aitype = 0, AiscriptId = 214, scriptId = 807003, name = "Ti¬u H± H±"}   --Ti¬u H± H±
x807003_monster_xiaogougou = {ID = 23108, Aitype = 0, AiscriptId = 213, scriptId = 807003, name = "Ti¬u ¿ng ¿ng"}   --Ti¬u ¿ng ¿ng
x807003_monster_groupId = 1

x807003_monster_First_num = 15
x807003_monster_Second_num = 15
x807003_monster_Third_num = 15
x807003_monster_Fourth_num = 15
x807003_monster_boss_num = 6
 
x807003_gFirst_MonstersTbl =   --µÚÒ»Åú¹Ö×ø±ê
{
{x = 127, z = 85}, {x = 126, z = 90}, {x = 130, z = 90}, {x = 137, z = 77}, {x = 137, z = 81}, {x = 141, z = 80}, {x = 149, z = 86}, {x = 152, z = 82}, {x = 140, z = 101}, 
{x = 157, z = 101}, {x = 134, z = 107}, {x = 145, z = 103}, {x = 154, z = 106}, {x = 147, z = 108}, {x = 160, z = 88}
}
x807003_gSecond_MonstersTbl =   --µÚ¶þÅú¹Ö×ø±ê
{
{x = 179, z = 86}, {x = 176, z = 89}, {x = 183, z = 100}, {x = 177, z = 95}, {x = 183, z = 92}, {x = 191, z = 122}, {x = 194, z = 128}, {x = 161, z = 108}, {x = 176, z = 116}, 
{x = 152, z = 119}, {x = 162, z = 124}, {x = 163, z = 132}, {x = 175, z = 135}, {x = 178, z = 128}, {x = 170, z = 127}
}
x807003_gThird_MonstersTbl =    --µÚÈýÅú¹Ö×ø±ê
{
{x = 193, z = 153}, {x = 188, z = 163}, {x = 195, z = 163}, {x = 201, z = 163}, {x = 200, z = 170}, {x = 194, z = 171}, {x = 171, z = 146}, {x = 174, z = 150}, {x = 159, z = 156}, 
{x = 162, z = 159}, {x = 157, z = 162}, {x = 149, z = 153}, {x = 147, z = 147}, {x = 152, z = 157}, {x = 161, z = 145}
}
x807003_gFourth_MonstersTbl =    --µÚËÄÅú¹Ö×ø±ê
{
{x = 137, z = 157}, {x = 130, z = 158}, {x = 140, z = 163}, {x = 124, z = 144}, {x = 121, z = 137}, {x = 126, z = 129}, {x = 141, z = 137}, {x = 138, z = 141}, {x = 101, z = 155}, 
{x = 108, z = 161}, {x = 111, z = 163}, {x = 109, z = 173}, {x = 107, z = 169}, {x = 133, z = 146}, {x = 128, z = 136}
}
x807003_gFourth_hudaoshenshouTbl =
{startx = 153, startz = 182, PatrolId = 0}

x807003_gFourth_feitianmaoTbl =
{startx = 155, startz = 150, PatrolId = 1}

x807003_gFourth_xiaozuzuTbl =
{startx = 155, startz = 150, PatrolId = 2}
x807003_gFourth_xiaohuhuTbl =
{startx = 155, startz = 150, PatrolId = 3}
x807003_gFourth_xiaoyingyingTbl =
{startx = 155, startz = 150, PatrolId = 4}
x807003_gFourth_xiaogougouTbl =
{startx = 155, startz = 150, PatrolId = 5}

--µôÂä
 -- Ëæ»úÒò×Ó
x807003_g_RandNum = 10000

 -- ³èÎïµÄ´æ»îÊ±¼ä£¬3·ÖÖÓ
x807003_g_Lifecycle = 180000

--**********************************
--ÈÎÎñÈë¿Úº¯Êý....
--**********************************
function x807003_OnDefaultEvent( sceneId, selfId, targetId )

--**********************************
--NPC¶Ô»°
--**********************************
	BeginEvent( sceneId )
		AddText(sceneId, "R¤t nhi«u th¥n thú ðã ð¸nh cß tÕi Huy«n Vû Ðäo. Các hÕ có mu¯n ði xem qua?")
		AddNumText( sceneId, x807003_g_scriptId, "Thiên Hàng KÏ Thú", 6, 1 )
	EndEvent( sceneId )
	DispatchEventList( sceneId, selfId, targetId )

end


function x807003_OnEventRequest( sceneId, selfId, targetId, eventId )
	
	
	if GetNumText() == 1 then
		local nCheckRet = x807003_CheckCanEnterScene(sceneId, selfId, targetId, eventId)
		local strOutmsg = "";
		if (nCheckRet == 1) then
			strOutmsg = "Khiêu chiªn kÏ thú, ngß½i c¥n t± ðµi ít nh¤t 3 ngß¶i.";
		elseif (nCheckRet == 2) then
			strOutmsg = "Các hÕ không phäi ðµi trß·ng. Vui lòng g÷i ðµi trß·ng g£p ta.";
		elseif (nCheckRet == 3) then
			strOutmsg = "Khiêu chiªn kÏ thú, ngß½i c¥n t± ðµi ít nh¤t 3 ngß¶i."           --²»¹»ÈýÈË
		elseif (nCheckRet == 4) then
			strOutmsg = "Ðµi ngû có thành viên không · g¥n ðây.";
		elseif (nCheckRet == 5 or nCheckRet == 6) then
			strOutmsg = "Ðµi ngû có thành viên không ðü ði«u ki®n.\n"           --5,6Ò»¶¨ÊÇ¿òÏÔÊ¾
			
			local nearMemberCount = GetNearTeamCount(sceneId, selfId);
			local sceneMemId = 0;
			local memName = "";
			
			local strOutMsgTemp = {}
			for i = 0, nearMemberCount - 1 do
				sceneMemId = GetNearTeamMember(sceneId, selfId, i)
				memName = GetName(sceneId, sceneMemId);
				strOutMsgTemp[i] = "#c3c3cff"..memName.."#W"
				if sceneMemId and sceneMemId >= 0 then			
					if (GetLevel(sceneId, sceneMemId) < x807003_g_Low_Level) then
						strOutMsgTemp[i] = strOutMsgTemp[i]..":\n  C¤p ðµ yêu c¥u "..tostring(x807003_g_Low_Level).."    #cff0000, chßa ðü yêu c¥u.#W\n"
					else
						strOutMsgTemp[i] = strOutMsgTemp[i]..":\n  C¤p ðµ yêu c¥u "..tostring(x807003_g_Low_Level).."    #c00ff00, thöa mãn yêu c¥u.#W\n"
					end
					if (0 == x807003_CheckAllXinfaLevel(sceneId, sceneMemId)) then
						strOutMsgTemp[i] = strOutMsgTemp[i].."  Tâm pháp yêu c¥u "..tostring(x807003_g_Low_Level_xinfa).."    #cff0000, chßa ðü yêu c¥u.#W\n"
					else
						strOutMsgTemp[i] = strOutMsgTemp[i].."  Tâm pháp yêu c¥u "..tostring(x807003_g_Low_Level_xinfa).."    #c00ff00, thöa mãn yêu c¥u.#W\n"
					end
				else
					strOutMsgTemp[i] = strOutMsgTemp[i]..memName..": Ðµi ngû có thành viên chßa ðÕt yêu c¥u."
				end
			end
			
			BeginEvent( sceneId )
				AddText(sceneId, strOutmsg)
				for i = 0, nearMemberCount - 1 do
					AddText(sceneId, strOutMsgTemp[i])
				end
			EndEvent( sceneId )
			DispatchEventList( sceneId, selfId, targetId )	
			
			return
		end			

		if (nCheckRet > 0 and nCheckRet < 5) then
			if (x807003_tipinbox == 1) then
				BeginEvent( sceneId )
		   			AddText(sceneId, strOutmsg)
		   		EndEvent( sceneId )
		  		DispatchEventList( sceneId, selfId, targetId )	
			else
				x807003_NotifyFailTips(sceneId, selfId, strOutmsg);
			end
			return
		end
		
		--¿ÉÒÔ½øÈë¸±±¾ÁË
		local nearMemberCount = GetNearTeamCount(sceneId, selfId);
		x807003_MakeCopyScene(sceneId, selfId, targetId, nearMemberCount)	

	end

end


--**********************************
--¼ì²éÊÇ·ñ, thöa mãn yêu c¥u.½øÈë¸±±¾µÄÒªÇó

--¼ì²éÊÇ·ñ, thöa mãn yêu c¥u.½øÈë¸±±¾µÄÒªÇó
--·µ»ØÖµËµÃ÷: 1     Ã»×é¶Ó
--            2     ²»ÊÇ¶Ó³¤
--            3     ²»¹»ÈýÈË
--            4     ¶ÓÔ±²»ÔÚ¸½½ü
--            5     ¶Ó³¤µÈ¼¶ÐÄ·¨²»¹»
--            6     ¶ÓÔ±µÈ¼¶ÐÄ·¨²»¹»
--            7
--            0       , thöa mãn yêu c¥u.
--**********************************
function x807003_CheckCanEnterScene(sceneId, selfId, targetId, eventId)
	
	if LuaFnHasTeam(sceneId, selfId) == 0 then
		return 1
	end
	
	if LuaFnIsTeamLeader(sceneId, selfId) == 0 then
		return  2
	end
	
	local teamMemberCount = GetTeamMemberCount(sceneId, selfId);
	if not teamMemberCount or teamMemberCount < x807003_g_limitMembers then
		return  3
	end
	
	local nearMemberCount = GetNearTeamCount(sceneId, selfId);
	if not nearMemberCount or teamMemberCount ~= nearMemberCount then
		return 4
	end
	
	
	-- ¼ì²â¶Ó³¤µÄµÈ¼¶ÊÇ·ñ, thöa mãn yêu c¥u.ÒªÇó
	if (GetLevel(sceneId, selfId) < x807003_g_Low_Level or 0 == x807003_CheckAllXinfaLevel(sceneId, selfId)) then
		return 5
	end
	
	-- Í³¼ÆÊÇ·ñÓÐ¶ÓÔ±, chßa ðü yêu c¥u.µÈ¼¶Tâm pháp yêu c¥u 
	local bHave = 0
	for i = 0, nearMemberCount - 1 do
		local sceneMemId = GetNearTeamMember(sceneId, selfId, i)
		if sceneMemId and sceneMemId >= 0 then			
			if (GetLevel(sceneId, sceneMemId) < x807003_g_Low_Level) then
				bHave = 1
			end
			if (0 == x807003_CheckAllXinfaLevel(sceneId, sceneMemId)) then
				bHave = 1
			end
		end
	end
	
	if(bHave == 1)then
		return 6;
	end
	 
--ÖÕÓÚ, thöa mãn yêu c¥u.ÁË~~~
	return 0;
end



--**********************************
--´´½¨¸±±¾
--nearmembercount: ¶ÓÔ±¸öÊý
--**********************************
function x807003_MakeCopyScene(sceneId, selfId, targetId, nearmembercount)

	local x
	local z
	x,z = LuaFnGetWorldPos(sceneId,selfId)
	local leaderguid = LuaFnObjId2Guid(sceneId, selfId);
	LuaFnSetSceneLoad_Map(sceneId, x807003_g_FubenTbl.MapFile);										--µØÍ¼ÊÇ±ØÐëÑ¡È¡µÄ£¬¶øÇÒ±ØÐëÔÚConfig/SceneInfo.iniÀïÅäÖÃºÃ
	LuaFnSetCopySceneData_TeamLeader(sceneId, leaderguid);
	LuaFnSetCopySceneData_NoUserCloseTime(sceneId, x807003_g_NoUserTime * 1000);
	LuaFnSetCopySceneData_Timer(sceneId, x807003_g_tickDiffTime * 1000);
	
	--³õÊ¼»¯ËùÓÐ¸±±¾²ÎÊý
	for i=0, 31 do
		LuaFnSetCopySceneData_Param(sceneId, i, 0)
	end
	
	LuaFnSetCopySceneData_Param(sceneId, 0, x807003_g_CopySceneType);					--ÉèÖÃ¸±±¾Êý¾Ý£¬ÕâÀï½«0ºÅË÷ÒýµÄÊý¾ÝÉèÖÃÎª999£¬ÓÃÓÚ±íÊ¾¸±±¾ºÅ999(Êý×Ö×Ô¶¨Òå)
	LuaFnSetCopySceneData_Param(sceneId, 1, x807003_g_scriptId);						--½«1ºÅÊý¾ÝÉèÖÃÎª¸±±¾³¡¾°ÊÂ¼þ½Å±¾ºÅ
	LuaFnSetCopySceneData_Param(sceneId, 2, 0);											--ÉèÖÃ¶¨Ê±Æ÷µ÷ÓÃ´ÎÊý
	LuaFnSetCopySceneData_Param(sceneId, 3, -1);										--ÉèÖÃ¸±±¾Èë¿Ú³¡¾°ºÅ, ³õÊ¼»¯
	LuaFnSetCopySceneData_Param(sceneId, 4, x);											--Èë¿ÚµØÖ·
	LuaFnSetCopySceneData_Param(sceneId, 5, z);											
	LuaFnSetCopySceneData_Param(sceneId, 6, GetTeamId(sceneId, selfId));				--±£´æ¶ÓÎéºÅ
	LuaFnSetCopySceneData_Param(sceneId, 7, 0);											--É±ËÀÁú÷ëµÄÊýÁ¿
	LuaFnSetCopySceneData_Param(sceneId, 8, x807003_g_FubenTbl.monsterId )	--Ð¡¹ÖID....
	LuaFnSetCopySceneData_Param(sceneId, 9, x807003_g_FubenTbl.bossId )		--BOSSID....
	LuaFnSetCopySceneData_Param(sceneId, 11, 0 )				--É±·ï³û¹ÖÊý....
	LuaFnSetCopySceneData_Param(sceneId, 12, 0 )				--step....
	LuaFnSetCopySceneData_Param(sceneId, 13, 0 )				--É±bossÊýÁ¿
	
	LuaFnSetSceneLoad_Area( sceneId, x807003_g_FubenTbl.AreaFile )
	LuaFnSetSceneLoad_Monster( sceneId, x807003_g_FubenTbl.MonsterFile )

	local bRetSceneID = LuaFnCreateCopyScene(sceneId)
	BeginEvent(sceneId)
		if bRetSceneID>0 then
			AddText(sceneId,"M· phó bän thành công.");
			--É¾³ýNPC
			LuaFnDeleteMonster(sceneId, targetId)
		else
			AddText(sceneId,"S¯ lßþng phó bän ðÕt thßþng hÕn, hãy ðþi thêm mµt lúc.");
		end
	EndEvent(sceneId)
	DispatchMissionTips(sceneId,selfId)
end

--**********************************
--Íæ¼ÒÍË³ö¸±±¾
--**********************************
function x807003_PlayerExit(sceneId, selfId)

	if selfId then
		local oldsceneId = LuaFnGetCopySceneData_Param(sceneId, 3);		--È¡µÃ¸±±¾Èë¿Ú³¡¾°ºÅ
		local x = LuaFnGetCopySceneData_Param(sceneId, 4);
		local z = LuaFnGetCopySceneData_Param(sceneId, 5);
		
		--½«µ±Ç°¸±±¾³¡¾°ÀïµÄËùÓÐÈË´«ËÍ»ØÔ­À´½øÈëÊ±ºòµÄ³¡¾°
		local membercount = LuaFnGetCopyScene_HumanCount(sceneId);
		local memId;
		for	i = 0, membercount - 1 do
			memId = LuaFnGetCopyScene_HumanObjId(sceneId, i);
			if LuaFnIsObjValid(sceneId, memId) == 1 and LuaFnIsCanDoScriptLogic(sceneId, memId) == 1 then
				if memId == selfId then
					NewWorld(sceneId, memId, oldsceneId, x, z);
				end
			end
		end
	end
end

--**********************************
--¸±±¾ÊÂ¼þ
--**********************************
function x807003_OnCopySceneReady(sceneId, destsceneId)
	LuaFnSetCopySceneData_Param(destsceneId, 3, sceneId);		--ÉèÖÃ¸±±¾Èë¿Ú³¡¾°ºÅ
	local leaderguid  = LuaFnGetCopySceneData_TeamLeader(destsceneId);
	local leaderObjId = LuaFnGuid2ObjId(sceneId,leaderguid);
	local day = GetDayTime();

	if LuaFnIsCanDoScriptLogic(sceneId, leaderObjId) ~= 1 then
		return 
	end

	--È¡µÃÍæ¼Ò¸½½üµÄ¶ÓÓÑÊýÁ¿£¨°üÀ¨×Ô¼º£©
	local nearMemberCount = GetNearTeamCount(sceneId, leaderObjId) ;
	local memId;
	for	i = 0, nearMemberCount - 1 do
		memId = GetNearTeamMember(sceneId, leaderObjId, i);
		if LuaFnIsObjValid(sceneId, memId) == 1 and LuaFnIsCanDoScriptLogic(sceneId, memId) == 1 then
			NewWorld(sceneId, memId, destsceneId, x807003_g_FubenTbl.Fuben_start_x, x807003_g_FubenTbl.Fuben_start_z);
		end
		--»î¶¯Í³¼ÆÏÖÔÚ»¹²»ÐèÒª
	end
	
	--Í³¼Æ£¬¶Ó³¤´øÁË¶àÉÙÈË½øÈ¥(ÈËÊýÖÐ°üÀ¨¶Ó³¤)
	CreateCopySceneAudit(sceneId, leaderObjId, nearMemberCount)
end

--**********************************
--ÓÐÍæ¼Ò½øÈë¸±±¾ÊÂ¼þ
--**********************************
function x807003_OnPlayerEnter(sceneId, selfId)
	--ÉèÖÃËÀÍöºó¸´»îµãÎ»ÖÃ	
	SetPlayerDefaultReliveInfo(sceneId, selfId, "%10", -1, "0", sceneId, x807003_g_FubenTbl.Fuben_start_x, x807003_g_FubenTbl.Fuben_start_z);  --¸´»îµãÉèÖÃÔÚ¸Õ½øÈëµÄµØ·½
	local teamLeaderFlag = LuaFnIsTeamLeader(sceneId, selfId);
	if teamLeaderFlag and teamLeaderFlag == 1 then
		LuaFnSetTeamExpAllotMode(sceneId, selfId, 0);      --Æ½¾ù·ÖÅäÄ£Ê½
	end
end

--**********************************
--ÓÐÍæ¼ÒÔÚ¸±±¾ÖÐËÀÍöÊÂ¼þ
--**********************************
function x807003_OnHumanDie(sceneId, selfId, killerId)
end

--**********************************
--¸±±¾³¡¾°¶¨Ê±Æ÷ÊÂ¼þ
--**********************************
function x807003_OnCopySceneTimer(sceneId, nowTime)

	--¸±±¾Ê±ÖÓ¶ÁÈ¡¼°ÉèÖÃ
	local nStep = LuaFnGetCopySceneData_Param(sceneId, 12 )
	local curTickCount = LuaFnGetCopySceneData_Param(sceneId, 2);		--È¡µÃÒÑ¾­Ö´ÐÐµÄ¶¨Ê±´ÎÊý
	
	--½×¶Î¿ØÖÆ
	if (nStep == 0) then        --¸±±¾¸Õ¸Õ¿ªÊ¼
		LuaFnSetCopySceneData_Param(sceneId, 12, 1 )	
		
		LuaFnSetSceneWeather(sceneId, 19, 39*60*1000 );   --ÏÂÓê
		
		--ÌáÊ¾ÐÅÏ¢
		local membercount = LuaFnGetCopyScene_HumanCount(sceneId);
		local memId;
		for	i = 0, membercount - 1 do
			memId = LuaFnGetCopyScene_HumanObjId(sceneId, i);
			if LuaFnIsObjValid(sceneId, memId) == 1 then
 				x807003_NotifyFailTips(sceneId, memId, "Thiên Niên KÏ Thú: Lôi Lân th¥n bí ðã xu¤t hi®n tÕi Huy«n Vû Ðäo.");
 			end
		end		
		
		--³öÏÖµÚÒ»Åú¹Ö
		for i, MonsterPos in x807003_gFirst_MonstersTbl do
			objId = LuaFnCreateMonster( sceneId, x807003_monster_leilin.ID, MonsterPos.x, MonsterPos.z, x807003_monster_leilin.Aitype, x807003_monster_leilin.AiscriptId , x807003_monster_leilin.scriptId )			
		end
		
		--½¨Á¢´óboss£¬Hµ Ðäo Th¥n Thú£¬
		objId = LuaFnCreateMonster( sceneId, x807003_monster_xudaoshenshou.ID, x807003_gFourth_hudaoshenshouTbl.startx, x807003_gFourth_hudaoshenshouTbl.startz, x807003_monster_xudaoshenshou.Aitype, x807003_monster_xudaoshenshou.AiscriptId , x807003_monster_xudaoshenshou.scriptId )			
		SetPatrolId(sceneId, objId, x807003_gFourth_hudaoshenshouTbl.PatrolId )
		--Vô Ð¸ch Thiên Miêu
		objId = LuaFnCreateMonster( sceneId, x807003_monster_feitianmao.ID, x807003_gFourth_feitianmaoTbl.startx, x807003_gFourth_feitianmaoTbl.startz, x807003_monster_feitianmao.Aitype, x807003_monster_feitianmao.AiscriptId , x807003_monster_feitianmao.scriptId )			
		SetCharacterTitle(sceneId, objId, "Huy­n Vû Ðäo Trinh T§p Ðµi Trß·ng")
		SetMonsterGroupID(sceneId, objId, x807003_monster_groupId);	--Ã¿×é¹ÖÎïÊôÓÚÍ¬Ò»¸öGroupID£¬ÕâÑù¹ÖÎïÃÇ¿ÉÒÔ»¥ÏàÔöÔ®
		SetPatrolId(sceneId, objId, x807003_gFourth_feitianmaoTbl.PatrolId )
		objId = LuaFnCreateMonster( sceneId, x807003_monster_xiaozhuzhu.ID, x807003_gFourth_xiaozuzuTbl.startx, x807003_gFourth_xiaozuzuTbl.startz, x807003_monster_xiaozhuzhu.Aitype, x807003_monster_xiaozhuzhu.AiscriptId , x807003_monster_xiaozhuzhu.scriptId )			
		SetMonsterGroupID(sceneId, objId, x807003_monster_groupId);
		SetPatrolId(sceneId, objId, x807003_gFourth_xiaozuzuTbl.PatrolId )
		objId = LuaFnCreateMonster( sceneId, x807003_monster_xiaohuhu.ID, x807003_gFourth_xiaohuhuTbl.startx, x807003_gFourth_xiaohuhuTbl.startz, x807003_monster_xiaohuhu.Aitype, x807003_monster_xiaohuhu.AiscriptId , x807003_monster_xiaohuhu.scriptId )			
		SetMonsterGroupID(sceneId, objId, x807003_monster_groupId);
		SetPatrolId(sceneId, objId, x807003_gFourth_xiaohuhuTbl.PatrolId )
		objId = LuaFnCreateMonster( sceneId, x807003_monster_xiaoyingying.ID, x807003_gFourth_xiaoyingyingTbl.startx, x807003_gFourth_xiaoyingyingTbl.startz, x807003_monster_xiaoyingying.Aitype, x807003_monster_xiaoyingying.AiscriptId , x807003_monster_xiaoyingying.scriptId )			
		SetMonsterGroupID(sceneId, objId, x807003_monster_groupId);
		SetPatrolId(sceneId, objId, x807003_gFourth_xiaoyingyingTbl.PatrolId )
		objId = LuaFnCreateMonster( sceneId, x807003_monster_xiaogougou.ID, x807003_gFourth_xiaogougouTbl.startx, x807003_gFourth_xiaogougouTbl.startz, x807003_monster_xiaogougou.Aitype, x807003_monster_xiaogougou.AiscriptId , x807003_monster_xiaogougou.scriptId )			
		SetMonsterGroupID(sceneId, objId, x807003_monster_groupId);
		SetPatrolId(sceneId, objId, x807003_gFourth_xiaogougouTbl.PatrolId )
		
	elseif (nStep == 4) then     --¹ÖËÀ¹âÁË
		curTickCount	= 2340
		LuaFnSetCopySceneData_Param(sceneId, 2, curTickCount);--ÉèÖÃÐÂµÄ¶¨Ê±Æ÷µ÷ÓÃ´ÎÊý
		LuaFnSetCopySceneData_Param(sceneId, 12, 5 )   --½øÈëµ¹¼ÆÊ±ÁË	
	end
	
	--Ê±¼ä¿ØÖÆ
	local strOutMsg = ""
	--µÚ¶þÅú¹ÖÂß¼­
	if (curTickCount >=20 and curTickCount <= 30) then
		local membercount = LuaFnGetCopyScene_HumanCount(sceneId);
		local memId;
		
		if(curTickCount == 20) then
			strOutMsg = "Thiên Niên KÏ Thú: Linh thú S° Phßþng 60 giây sau s¨ giáng tr¥n."
		elseif(curTickCount == 23) then
			strOutMsg = "Thiên Niên KÏ Thú: Linh thú S° Phßþng 30 giây sau s¨ giáng tr¥n."
		elseif(curTickCount == 25) then
			strOutMsg = "Thiên Niên KÏ Thú: Linh thú S° Phßþng 10 giây sau s¨ giáng tr¥n."
		elseif(curTickCount == 28) then
			strOutMsg = "Thiên Niên KÏ Thú: Linh thú S° Phßþng 5 giây sau s¨ giáng tr¥n."
		elseif(curTickCount == 30) then
			strOutMsg = "Thiên Niên KÏ Thú: Linh thú S° Phßþng ðã xu¤t hi®n tÕi Huy«n Vû Ðäo."
			--³öÏÖµÚ¶þÅú¹Ö
			for i, MonsterPos in x807003_gSecond_MonstersTbl do
				objId = LuaFnCreateMonster( sceneId, x807003_monster_chufeng.ID, MonsterPos.x, MonsterPos.z, x807003_monster_chufeng.Aitype, x807003_monster_chufeng.AiscriptId , x807003_monster_chufeng.scriptId )			
			end
		end
		
		for	i = 0, membercount - 1 do
			memId = LuaFnGetCopyScene_HumanObjId(sceneId, i);
			if LuaFnIsObjValid(sceneId, memId) == 1 then
 				x807003_NotifyFailTips(sceneId, memId, strOutMsg);
 			end
		end		
	
		--µÚÈýÅú¹ÖÂß¼­
	elseif (curTickCount >=540 and curTickCount <= 600) then
		local membercount = LuaFnGetCopyScene_HumanCount(sceneId);
		local memId;
		
		if(curTickCount == 54) then
			strOutMsg = "Thiên Niên KÏ Thú: Th¥n thú Lôi Lân 60 giây sau s¨ giáng tr¥n."
		elseif(curTickCount == 57) then
			strOutMsg = "Thiên Niên KÏ Thú: Th¥n thú Lôi Lân 30 giây sau s¨ giáng tr¥n."
		elseif(curTickCount == 59) then
			strOutMsg = "Thiên Niên KÏ Thú: Th¥n thú Lôi Lân 10 giây sau s¨ giáng tr¥n."
		elseif(curTickCount == 59) then
			strOutMsg = "Thiên Niên KÏ Thú: Th¥n thú Lôi Lân 5 giây sau s¨ giáng tr¥n."
		elseif(curTickCount == 60) then
			strOutMsg = "Thiên Niên KÏ Thú: Th¥n thú Lôi Lân ðã xu¤t hi®n tÕi Huy«n Vû Ðäo"
			--³öÏÖµÚÈýÅú¹Ö
			for i, MonsterPos in x807003_gThird_MonstersTbl do
				objId = LuaFnCreateMonster( sceneId, x807003_monster_leilin.ID, MonsterPos.x, MonsterPos.z, x807003_monster_leilin.Aitype, x807003_monster_leilin.AiscriptId , x807003_monster_leilin.scriptId )			
			end
		end
		
		for	i = 0, membercount - 1 do
			memId = LuaFnGetCopyScene_HumanObjId(sceneId, i);
			if LuaFnIsObjValid(sceneId, memId) == 1 then
 				x807003_NotifyFailTips(sceneId, memId, strOutMsg);
 			end
		end		

	
	--µÚËÄÅú¹ÖÂß¼­
	elseif (curTickCount >=84 and curTickCount <= 90) then
		local membercount = LuaFnGetCopyScene_HumanCount(sceneId);
		local memId;
		
		if(curTickCount == 84) then
			strOutMsg = "Thiên Niên KÏ Thú: Linh thú S° Phßþng 60 giây sau s¨ giáng tr¥n."
		elseif(curTickCount == 87) then
			strOutMsg = "Thiên Niên KÏ Thú: Linh thú S° Phßþng 30 giây sau s¨ giáng tr¥n."
		elseif(curTickCount == 89) then
			strOutMsg = "Thiên Niên KÏ Thú: Linh thú S° Phßþng 10 giây sau s¨ giáng tr¥n."
		elseif(curTickCount == 89) then
			strOutMsg = "Thiên Niên KÏ Thú: Linh thú S° Phßþng 5 giây sau s¨ giáng tr¥n."
		elseif(curTickCount == 90) then
			strOutMsg = "Thiên Niên KÏ Thú: Linh thú S° Phßþng ðã xu¤t hi®n tÕi Huy«n Vû Ðäo."
			--³öÏÖµÚËÄÅú¹Ö
			for i, MonsterPos in x807003_gFourth_MonstersTbl do
				objId = LuaFnCreateMonster( sceneId, x807003_monster_chufeng.ID, MonsterPos.x, MonsterPos.z, x807003_monster_chufeng.Aitype, x807003_monster_chufeng.AiscriptId , x807003_monster_chufeng.scriptId )			
			end
		end
		
		for	i = 0, membercount - 1 do
			memId = LuaFnGetCopyScene_HumanObjId(sceneId, i);
			if LuaFnIsObjValid(sceneId, memId) == 1 then
 				x807003_NotifyFailTips(sceneId, memId, strOutMsg);
 			end
		end		

	--40·ÖÖÓµ½ÁËcurTickCount == 2400)
	elseif (curTickCount >=2340) then
		local membercount = LuaFnGetCopyScene_HumanCount(sceneId);
		local memId;
		if (curTickCount == 2340) then
			strOutMsg = "Các hÕ s¨ r¶i khöi ðây sau 60 giây."
		elseif(curTickCount == 2370) then
			strOutMsg = "Các hÕ s¨ r¶i khöi ðây sau 30 giây."
		elseif(curTickCount == 2380) then
			strOutMsg = "Các hÕ s¨ r¶i khöi ðây sau 20 giây."
		elseif(curTickCount == 2390) then
			strOutMsg = "Các hÕ s¨ r¶i khöi ðây sau 10 giây."
		elseif(curTickCount == 2395) then
			strOutMsg = "Các hÕ s¨ r¶i khöi ðây sau 5 giây."
		elseif(curTickCount >= 2400) then
			local oldsceneId = LuaFnGetCopySceneData_Param(sceneId, 3);		--È¡µÃ¸±±¾Èë¿Ú³¡¾°ºÅ,×¼±¸°ÑÍæ¼Ò´«³öÈ¥
			local x = LuaFnGetCopySceneData_Param(sceneId, 4);
			local z = LuaFnGetCopySceneData_Param(sceneId, 5);
		
			--½«µ±Ç°¸±±¾³¡¾°ÀïµÄËùÓÐÈË´«ËÍ»ØÔ­À´½øÈëÊ±ºòµÄ³¡¾°
			local membercount = LuaFnGetCopyScene_HumanCount(sceneId);
			
			local memId;
			for	i = 0, membercount - 1 do
				memId = LuaFnGetCopyScene_HumanObjId(sceneId, i);
				if LuaFnIsObjValid(sceneId, memId) == 1 and LuaFnIsCanDoScriptLogic(sceneId, memId) == 1 then
					NewWorld(sceneId, memId, oldsceneId, x, z);
				end
			end
			return
		end
		
		for	i = 0, membercount - 1 do
			memId = LuaFnGetCopyScene_HumanObjId(sceneId, i);
			if LuaFnIsObjValid(sceneId, memId) == 1 then
 				x807003_NotifyFailTips(sceneId, memId, strOutMsg);
 			end
		end		
	end
	
	curTickCount = curTickCount + 1;
	LuaFnSetCopySceneData_Param(sceneId, 2, curTickCount);--ÉèÖÃÐÂµÄ¶¨Ê±Æ÷µ÷ÓÃ´ÎÊý
	
end

--**********************************
--¸±±¾³¡¾°ÖÐÉ±ÁË¹Ö
--**********************************
function x807003_OnDie(sceneId, selfId, killerId)						-- ³¡¾°ID, ±»É±µÄObjId, É±ÊÖObjId

	CallScriptFunction(501000, "OnDie", sceneId, selfId, killerId) 
	
	--ÏÂÃæÊÇÍ³¼Æ¹¦ÄÜ
	local szName = GetName(sceneId, selfId)

	local AllMonsterNum = 0;
	--ÏÂÃæÊÇµÚÒ»Åú£¬µÚ¶þÅú£¬µÚÈýÅú£¬µÚËÄÅú¹Ö£¬ºÍ6¸öboss(Á½¸ö´óboss£¬ËÄ¸öÐ¡..)
--	AllMonsterNum = x807003_gFirst_MonstersTbl.size + x807003_gSecond_MonstersTbl.size + x807003_gThird_MonstersTbl.size + x807003_gFourth_MonstersTbl.size  
	AllMonsterNum = x807003_monster_First_num + x807003_monster_Second_num + x807003_monster_Third_num + x807003_monster_Fourth_num + x807003_monster_boss_num
	
	local nKilledMonsterNum_feng = LuaFnGetCopySceneData_Param(sceneId, 7);											--É±ËÀ·ïµÄÊýÁ¿
	local nKilledMonsterNum_long = LuaFnGetCopySceneData_Param(sceneId, 11);											--É±ËÀÁúµÄÊýÁ¿
	local nKilledMonsterNum_boss = LuaFnGetCopySceneData_Param(sceneId, 13);											--É±ËÀbossµÄÊýÁ¿
	
	local strOutMsg = ""
	local AuditType = 0
	if (szName == x807003_monster_chufeng.name) then
		nKilledMonsterNum_feng = nKilledMonsterNum_feng + 1
		LuaFnSetCopySceneData_Param(sceneId, 7, nKilledMonsterNum_feng);
		strOutMsg = strOutMsg.."Ðã khiêu chiªn Thiên Niên KÏ Thú S° Phßþng "..tostring(nKilledMonsterNum_feng).."/"..tostring(x807003_monster_Second_num + x807003_monster_Fourth_num)
		AuditType = 1
	elseif (szName == x807003_monster_leilin.name) then
		nKilledMonsterNum_long = nKilledMonsterNum_long + 1
		LuaFnSetCopySceneData_Param(sceneId, 11, nKilledMonsterNum_long);
		strOutMsg = strOutMsg.."Ðã khiêu chiªn Thiên Niên KÏ Thú Lôi Lân "..tostring(nKilledMonsterNum_long).."/"..tostring(x807003_monster_Second_num + x807003_monster_Fourth_num)
		AuditType = 2
	elseif (szName == x807003_monster_xudaoshenshou.name) then
		nKilledMonsterNum_boss = nKilledMonsterNum_boss + 1
		LuaFnSetCopySceneData_Param(sceneId, 13, nKilledMonsterNum_boss);
		strOutMsg = strOutMsg.."Ðã giªt chªt Hµ Ðäo Th¥n Thú: 1/1."
		AuditType = 3
	elseif (szName == x807003_monster_feitianmao.name) then
		nKilledMonsterNum_boss = nKilledMonsterNum_boss + 1
		LuaFnSetCopySceneData_Param(sceneId, 13, nKilledMonsterNum_boss);
		strOutMsg = strOutMsg.."Ðã giªt chªt Vô Ð¸ch Thiên Miêu: 1/1."
		AuditType = 4
	elseif (szName == x807003_monster_xiaozhuzhu.name) then
		nKilledMonsterNum_boss = nKilledMonsterNum_boss + 1
		LuaFnSetCopySceneData_Param(sceneId, 13, nKilledMonsterNum_boss);
		strOutMsg = strOutMsg.."Ðã giªt chªt Ð¡ÖíÖí: 1/1."
		AuditType = 5
	elseif (szName == x807003_monster_xiaohuhu.name) then
		nKilledMonsterNum_boss = nKilledMonsterNum_boss + 1
		LuaFnSetCopySceneData_Param(sceneId, 13, nKilledMonsterNum_boss);
		strOutMsg = strOutMsg.."Ðã giªt chªt Ti¬u Trß Trß: 1/1."
		AuditType = 5
	elseif (szName == x807003_monster_xiaoyingying.name) then
		nKilledMonsterNum_boss = nKilledMonsterNum_boss + 1
		LuaFnSetCopySceneData_Param(sceneId, 13, nKilledMonsterNum_boss);
		strOutMsg = strOutMsg.."Ðã giªt chªt Ti¬u H± H±: 1/1."
		AuditType = 5
	elseif (szName == x807003_monster_xiaogougou.name) then
		nKilledMonsterNum_boss = nKilledMonsterNum_boss + 1
		LuaFnSetCopySceneData_Param(sceneId, 13, nKilledMonsterNum_boss);
		strOutMsg = strOutMsg.."Ðã giªt chªt Ti¬u ¿ng ¿ng: 1/1."
		AuditType = 5
	end
	
	local nAllKilled = nKilledMonsterNum_feng + nKilledMonsterNum_long + nKilledMonsterNum_boss
	local membercount = LuaFnGetCopyScene_HumanCount(sceneId);
	for	i = 0, membercount - 1 do
		memId = LuaFnGetCopyScene_HumanObjId(sceneId, i);
		if LuaFnIsObjValid(sceneId, memId) == 1 then
 			x807003_NotifyFailTips(sceneId, memId, strOutMsg);
 		end
	end		

	if (nAllKilled >= AllMonsterNum) then
		LuaFnSetCopySceneData_Param(sceneId, 12, 4 )        --¸Ã×ßÁË
	end
end

--Õ¾ÔÚÀë¿ª³¡¾°µÄ¹âÓ°ÀïÃæ£¬×¼±¸È¥ÍùÂ¥À¼
function x807003_OnEnterArea( sceneId, selfId )
		local oldsceneId = LuaFnGetCopySceneData_Param(sceneId, 3);		--È¡µÃ¸±±¾Èë¿Ú³¡¾°ºÅ
		local x = LuaFnGetCopySceneData_Param(sceneId, 4);
		local z = LuaFnGetCopySceneData_Param(sceneId, 5);
		NewWorld(sceneId, selfId, oldsceneId, x, z);
end

function x807003_OnLeaveArea( sceneId, selfId )
end

function x807003_NotifyFailTips(sceneId, selfId, Tip)
	BeginEvent(sceneId);
		AddText(sceneId, Tip);
	EndEvent(sceneId);
	DispatchMissionTips(sceneId, selfId);
end


function x807003_CheckAllXinfaLevel(sceneId, memId)
	local nMenpai = GetMenPai(sceneId, memId)
	if nMenpai<0 or nMenpai>8   then
		return 0
	end
	
	for i=1, 6 do
		local nXinfaLevel = LuaFnGetXinFaLevel(sceneId, memId, nMenpai*6 + i)
		if nXinfaLevel < x807003_g_Low_Level_xinfa    then
			return 0
		end
	end
	return 1
end

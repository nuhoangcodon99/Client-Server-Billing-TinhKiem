-- ½øÈëÒ¹¼ätoÕ ðµ ¾ÛÏÍ×¯

--200023
-- TÕi Cái Bang³¤ÀÏtoÕ ðµ °ï×éÏÂ,½øÈë¾ÛÏÍ×¯¸±±¾

--************************************************************************
--MisDescBegin
--½Å±¾ºÅ
x200023_g_ScriptId = 200023

--MisDescEnd
--************************************************************************

--¸±±¾Ãû³Æ
x200023_g_CopySceneName = "Tø Hi«n Trang"

x200023_g_CopySceneType = FUBEN_JUQING	--¸±±¾ÀàÐÍ,¶¨ÒåTÕi ScriptGlobal.luaÀïÃæ

x200023_g_CopySceneMap = "juxian.nav"
x200023_g_Exit = "juxian.ini"
x200023_g_LimitMembers = 1				--¿ÉÒÔ½ø¸±±¾toÕ ðµ ×îÐ¡¶ÓÎéÈËÊý
x200023_g_TickTime = 5					--»Øµ÷½Å±¾toÕ ðµ Ê±ÖÓÊ±¼ä(µ¥Î»:  giây/´Î)
x200023_g_LimitTotalHoldTime = 360		--¸±±¾¿ÉÒÔ´æ»îtoÕ ðµ Ê±¼ä(µ¥Î»: ´ÎÊý),Èç¹û´ËÊ±¼äµ½ÁË,ÔòÈÎÎñ½«»áth¤t bÕi
x200023_g_LimitTimeSuccess = 500		--¸±±¾Ê±¼äÏÞÖÆ(µ¥Î»: ´ÎÊý),Èç¹û´ËÊ±¼äµ½ÁË,ÈÎÎñÍê³É
x200023_g_CloseTick = 3					--¸±±¾¹Ø±ÕÇ°µ¹¼ÆÊ±(µ¥Î»: ´ÎÊý)
x200023_g_NoUserTime = 300				--¸±±¾ÖÐÃ»ÓÐÈËºó¿ÉÒÔ¼ÌÐø±£´ætoÕ ðµ Ê±¼ä(µ¥Î»:  giây)
x200023_g_DeadTrans = 0					--ËÀÍö×ªÒÆÄ£Ê½,0: ËÀÍöºó»¹¿ÉÒÔ¼ÌÐøTÕi ¸±±¾,1: ËÀÍöºó±»Ç¿ÖÆÒÆ³ö¸±±¾
x200023_g_Fuben_X = 61					--½øÈë¸±±¾toÕ ðµ Î»ÖÃX
x200023_g_Fuben_Z = 110					--½øÈë¸±±¾toÕ ðµ Î»ÖÃZ
x200023_g_Back_X = 66					--Ô´³¡¾°Î»ÖÃX
x200023_g_Back_Z = 56					--Ô´³¡¾°Î»ÖÃZ

--**********************************
--ÈÎÎñÈë¿Úº¯Êý
--**********************************
function x200023_OnDefaultEvent( sceneId, selfId, targetId )
	-- ¸ù¾ÝÍæ¼ÒtoÕ ðµ Çé¿ö,½«Íæ¼ÒËÍµ½²»Í¬toÕ ðµ ¸±±¾
	x200023_MakeCopyScene(sceneId, selfId)
end

--**********************************
--ÁÐ¾ÙÊÂ¼þ
--**********************************
function x200023_OnEnumerate( sceneId, selfId, targetId )
	-- Èç¹ûÍæ¼ÒÒÑ¾­Íê³ÉÁË20ÈÎÎñ,¾Í¿ÉÒÔ½øÈë
	if IsMissionHaveDone(sceneId, selfId, 23) > 0   then
		return 0
	end

	-- 1,ÒÑ¾­Íê³É22
	if IsMissionHaveDone( sceneId, selfId, 22 ) > 0 then
		AddNumText( sceneId, x200023_g_ScriptId, "Ðªn Tø Hi«n Trang (ngày)", 10 ,-1  )
		return 0
	end
	
	-- 2,ÓµÓÐÈÎÎñºÅÎª23toÕ ðµ ÈÎÎñ,
	if IsHaveMission( sceneId, selfId, 23 ) > 0 then
		AddNumText( sceneId, x200023_g_ScriptId, "Ðªn Tø Hi«n Trang (ngày)", 10 ,-1  )
		return 0
	end
end


--**********************************
--¼ì²âTiªp thøÌõ¼þ
--**********************************
function x200023_CheckAccept( sceneId, selfId )
	
end

--**********************************
--Ñ¯ÎÊÍæ¼ÒÐúng·ñÒª½øÈë¸±±¾
--**********************************
function x200023_AskEnterCopyScene( sceneId, selfId )
	
end

--**********************************
--Tiªp thø
--**********************************
function x200023_OnAccept( sceneId, selfId, targetId )
	
end

--**********************************
--Íæ¼ÒÍ¬Òâ½øÈë¸±±¾
--**********************************
function x200023_AcceptEnterCopyScene( sceneId, selfId )
	
end

--**********************************
--´´½¨¸±±¾
--**********************************
function x200023_MakeCopyScene( sceneId, selfId )

	leaderguid=LuaFnObjId2Guid(sceneId,selfId)
	LuaFnSetSceneLoad_Map(sceneId, "juxian.nav"); --µØÍ¼Ðúng±ØÐëÑ¡È¡toÕ ðµ ,¶øÇÒ±ØÐëTÕi Config/SceneInfo.iniÀïÅäÖÃºÃ
	LuaFnSetCopySceneData_TeamLeader(sceneId, leaderguid);
	LuaFnSetCopySceneData_NoUserCloseTime(sceneId, x200023_g_NoUserTime*1000);
	LuaFnSetCopySceneData_Timer(sceneId, x200023_g_TickTime*1000);
	LuaFnSetCopySceneData_Param(sceneId, 0, x200023_g_CopySceneType);--ÉèÖÃ¸±±¾Êý¾Ý,ÕâÀï½«0ºÅË÷ÒýtoÕ ðµ Êý¾ÝÉèÖÃÎª999,ÓÃÓÚ±íÊ¾¸±±¾ºÅ999(Êý×Ö×Ô¶¨Òå)
	LuaFnSetCopySceneData_Param(sceneId, 1, x200023_g_ScriptId);--½«1ºÅÊý¾ÝÉèÖÃÎª¸±±¾³¡¾°ÊÂ¼þ½Å±¾ºÅ
	LuaFnSetCopySceneData_Param(sceneId, 2, 0);--ÉèÖÃ¶¨Ê±Æ÷µ÷ÓÃ´ÎÊý
	LuaFnSetCopySceneData_Param(sceneId, 3, -1);--ÉèÖÃ¸±±¾Èë¿Ú³¡¾°ºÅ, ³õÊ¼»¯
	LuaFnSetCopySceneData_Param(sceneId, 4, 0);--ÉèÖÃ¸±±¾¹Ø±Õ±êÖ¾, 0¿ª·Å,1¹Ø±Õ
	LuaFnSetCopySceneData_Param(sceneId, 5, 0);--ÉèÖÃÀë¿ªµ¹¼ÆÊ±´ÎÊý
	LuaFnSetCopySceneData_Param(sceneId, 6, GetTeamId(sceneId,selfId)); --±£´æ¶ÓÎéºÅ
	LuaFnSetCopySceneData_Param(sceneId, 7, 0) ;--É±ËÀBosstoÕ ðµ ÊýÁ¿
	
	-- ¾çÇéÓÃµ½toÕ ðµ ±äÁ¿Çå¿Õ
	for i=8, 31 do
		LuaFnSetCopySceneData_Param(sceneId, i, 0)
	end

	--ÉèÖÃ³¡¾°ÖÐtoÕ ðµ ¸÷ÖÖNpcºÍÇøÓò
	LuaFnSetSceneLoad_Area( sceneId, "juxian_area.ini" )
	LuaFnSetSceneLoad_Monster( sceneId, "juxian_monster.ini" )

	local bRetSceneID = LuaFnCreateCopyScene(sceneId); --³õÊ¼»¯Íê³Éºóµ÷ÓÃ´´½¨¸±±¾º¯Êý
	BeginEvent(sceneId)
		if bRetSceneID>0 then
			AddText(sceneId,"D¸ch chuy¬n thành công!");
		else
			AddText(sceneId,"S¯ lßþng bän sao ðã ðªn gi¾i hÕn, ð« ngh¸ lát næa thØ lÕi!");
		end
	EndEvent(sceneId)
	DispatchMissionTips(sceneId,selfId)
	
end

--**********************************
--¸±±¾ÊÂ¼þ
--**********************************
function x200023_OnCopySceneReady( sceneId, destsceneId )

	--½øÈë¸±±¾toÕ ðµ ¹æÔò
	-- 1,Èç¹ûCái này ÎÄ¼þÃ»ÓÐ×é¶Ó,¾Í´«ËÍCái này ÎÄ¼þ×Ô¼º½øÈë¸±±¾
	-- 2, Èç¹ûÍæ¼ÒÓÐ¶ÓÎé,µ«ÐúngÍæ¼Ò²»Ðúng¶Ó³¤,¾Í´«ËÍ×Ô¼º½øÈë¸±±¾
	-- 3,Èç¹ûÍæ¼ÒÓÐ¶ÓÎé,²¢ÇÒCái này Íí¼äÐúng¶Ó³¤,¾Í´«ËÍ×Ô¼ººÍ¸½½ü¶ÓÓÑmµt Æð½øÈ¥

	LuaFnSetCopySceneData_Param(destsceneId, 3, sceneId) --ÉèÖÃ¸±±¾Èë¿Ú³¡¾°ºÅ
	leaderguid  = LuaFnGetCopySceneData_TeamLeader(destsceneId)
	leaderObjId = LuaFnGuid2ObjId(sceneId,leaderguid)
	
	if LuaFnIsCanDoScriptLogic( sceneId, leaderObjId ) ~= 1 then			-- ´¦ÓÚÎÞ·¨Ö´ÐÐÂß¼­toÕ ðµ ×´Ì¬
		return
	end
	
	-- ¼ì²âÍæ¼ÒÐúng²»ÐúngÓÐ¶ÓÎé
	if LuaFnHasTeam( sceneId, leaderObjId ) == 0  then   -- Ã»ÓÐ¶ÓÎé
		NewWorld( sceneId, leaderObjId, destsceneId, x200023_g_Fuben_X, x200023_g_Fuben_Z) ;
	else
		if IsCaptain(sceneId, leaderObjId) == 0  then
			NewWorld( sceneId, leaderObjId, destsceneId, x200023_g_Fuben_X, x200023_g_Fuben_Z) ;
		else
			local	nearteammembercount = GetNearTeamCount( sceneId, leaderObjId) 
			local mems = {}
			for	i=0,nearteammembercount-1 do
				mems[i] = GetNearTeamMember(sceneId, leaderObjId, i)
				--local misIndex = GetMissionIndexByID(sceneId,mems[i],x200023_g_MissionId)
				
				--½«ÈÎÎñtoÕ ðµ µÚ2ºÅÊý¾ÝÉèÖÃÎª¸±±¾toÕ ðµ ³¡¾°ºÅ
				--SetMissionByIndex(sceneId,mems[i],misIndex,x200023_g_Param_sceneid,destsceneId)
						
				NewWorld( sceneId, mems[i], destsceneId, x200023_g_Fuben_X, x200023_g_Fuben_Z) ;
			end
		end		
	end

end

--**********************************
--ÓÐÍæ¼Ò½øÈë¸±±¾ÊÂ¼þ
--**********************************
function x200023_OnPlayerEnter( sceneId, selfId )
	
end

--**********************************
--ÓÐÍæ¼ÒTÕi ¸±±¾ÖÐËÀÍöÊÂ¼þ
--**********************************
function x200023_OnHumanDie( sceneId, selfId, killerId )
	
end

--**********************************
--·ÅÆú
--**********************************
function x200023_OnAbandon( sceneId, selfId )
	
end

--**********************************
-- »Ø³Ç,Ö»ÓÐThành ph¯ ÈÎÎñ¸±±¾¿ÉÒÔµ÷ÓÃ´Ë½Ó¿Ú
--**********************************
function x200023_BackToCity( sceneId, selfId )
	
end

--**********************************
--¼ÌÐø
--**********************************
function x200023_OnContinue( sceneId, selfId, targetId )
	
end	

--**********************************
--¼ì²âÐúng·ñ¿ÉÒÔÌá½»
--**********************************
function x200023_CheckSubmit( sceneId, selfId, selectRadioId )
	
end

--**********************************
--Ìá½»
--**********************************
function x200023_OnSubmit( sceneId, selfId, targetId, selectRadioId )
	
end

--**********************************
--É±ËÀ¹ÖÎï»òÍæ¼Ò
--**********************************
function x200023_OnKillObject( sceneId, selfId, objdataId, objId )
	
end

--**********************************
--½øÈëÇøÓòÊÂ¼þ
--**********************************
function x200023_OnEnterZone( sceneId, selfId, zoneId )
	
end

--**********************************
--µÀ¾ß¸Ä±ä
--**********************************
function x200023_OnItemChanged( sceneId, selfId, itemdataId )
	
end

--**********************************
--¸±±¾³¡¾°¶¨Ê±Æ÷ÊÂ¼þ
--**********************************
function x200023_OnCopySceneTimer( sceneId, nowTime )


	local nHumanNum = LuaFnGetCopyScene_HumanCount(sceneId)
	
	-- Ã»ÓÐÈËtoÕ ðµ ³¡¾°,Ê²Ã´¶¼²»×ö
	if nHumanNum < 1 then
		return
	end
	
	local selfId = LuaFnGetCopyScene_HumanObjId(sceneId,0)
	
	local nStep1 = LuaFnGetCopySceneData_Param(sceneId, 10) --
	local nStartTime  = LuaFnGetCopySceneData_Param(sceneId, 11)	--Ê±¼ä
	local nPreTime = LuaFnGetCopySceneData_Param(sceneId, 12)	--Ê±¼ä
	local nNowTime = LuaFnGetCurrentTime()
	local nStep2 = LuaFnGetCopySceneData_Param(sceneId, 13) --
	local nStep5 = LuaFnGetCopySceneData_Param(sceneId, 20)
	
	if nStep1 == 1  then
	
		if nStep2 == 1 then
			-- ÉèÖÃ¿ªÕ½
			local nMonsterNum = GetMonsterCount(sceneId)
			local ii = 0
			local bHaveMonster = 0
			for ii=0, nMonsterNum-1 do
				local nMonsterId = GetMonsterObjID(sceneId,ii)
				
				if GetName(sceneId, nMonsterId)  == "Ki«u Phong"  then
					SetUnitReputationID(sceneId, selfId, nMonsterId, 0)
					SetMonsterFightWithNpcFlag(sceneId, nMonsterId, 1)
					SetNPCAIType(sceneId, nMonsterId, 5)
					
					--BroadMsgByChatPipe(sceneId,selfId,"#{JQ_DB_0011}",0)
					CallScriptFunction((200060), "Duibai",sceneId, "Ki«u Phong", "Tø Hi«n Trang", "#{JQ_DB_0011}" )
				end
			end
			
			LuaFnSetCopySceneData_Param(sceneId, 13, 2)
			LuaFnSetCopySceneData_Param(sceneId, 12, nNowTime)
		
		elseif nStep2 == 2 then
			if nNowTime - nPreTime > 3 then
				LuaFnSetCopySceneData_Param(sceneId, 13, 3)
				LuaFnSetCopySceneData_Param(sceneId, 12, nNowTime)
			end

		elseif nStep2 == 3 then
			--BroadMsgByChatPipe(sceneId,selfId,"#{JQ_DB_0012}",0)
			CallScriptFunction((200060), "Duibai",sceneId, "Ki«u Phong", "Tø Hi«n Trang", "#{JQ_DB_0012}" )
			LuaFnSetCopySceneData_Param(sceneId, 13, 4)
			
			LuaFnSetCopySceneData_Param(sceneId, 12, nNowTime-55)
			
		else
			-- ¸øÍæ¼ÒÌáÊ¾»¹ÓÐ¶àÉÙ²¨¹Ö
			
			if nStep2 < 16 and nStep2 > 4 then
					
				if nNowTime - nPreTime >= 30 and nStep5 == 0  then
					local str = "Hi®p sî Tø Hi«n Trang s¨ phát ðµng " .. 16 - nStep2   .. " l¥n t¤n công"
					x200023_TipToAllPlayerOnScene(sceneId, str)

					LuaFnSetCopySceneData_Param(sceneId, 20, 1)
				end
				if nNowTime - nPreTime >= 40 and nStep5 == 1  then
					local str = "Hi®p sî Tø Hi«n Trang s¨ phát ðµng " .. 16 - nStep2   .. " l¥n t¤n công"
					x200023_TipToAllPlayerOnScene(sceneId, str)
					
					LuaFnSetCopySceneData_Param(sceneId, 20, 2)
				end
				if nNowTime - nPreTime >= 50 and nStep5 == 2  then
					local str = "Hi®p sî Tø Hi«n Trang s¨ phát ðµng " .. 16 - nStep2   .. " l¥n t¤n công"
					x200023_TipToAllPlayerOnScene(sceneId, str)
					
					LuaFnSetCopySceneData_Param(sceneId, 20, 0)
				end
			end
			
			if nNowTime - nPreTime >= 60 and nStep2 < 16   then
				local nNpcId
				if nStep2 == 8 then
					nNpcId = LuaFnCreateMonster(sceneId, 416, 57, 33, 1, 0, -1)
					SetCharacterName(sceneId, nNpcId, "Ð½n Bách S½n")
					SetUnitReputationID(sceneId,selfId, nNpcId, 29)
					SetMonsterFightWithNpcFlag(sceneId, nNpcId, 1)
					SetNPCAIType(sceneId, nNpcId, 16)
		
					nNpcId = LuaFnCreateMonster(sceneId, 416, 58, 33, 1, 0, -1)
					SetCharacterName(sceneId, nNpcId, "Ð½n Trung S½n")
					SetUnitReputationID(sceneId,selfId, nNpcId, 29)
					SetMonsterFightWithNpcFlag(sceneId, nNpcId, 1)
					SetNPCAIType(sceneId, nNpcId, 16)
		
					nNpcId = LuaFnCreateMonster(sceneId, 416, 59, 33, 1, 0, -1)
					SetCharacterName(sceneId, nNpcId, "Ð½n Thúc S½n")
					SetUnitReputationID(sceneId,selfId, nNpcId, 29)
					SetMonsterFightWithNpcFlag(sceneId, nNpcId, 1)
					SetNPCAIType(sceneId, nNpcId, 16)
		
					nNpcId = LuaFnCreateMonster(sceneId, 416, 60, 33, 1, 0, -1)
					SetCharacterName(sceneId, nNpcId, "Ð½n Lý S½n")
					SetUnitReputationID(sceneId,selfId, nNpcId, 29)
					SetMonsterFightWithNpcFlag(sceneId, nNpcId, 1)
					SetNPCAIType(sceneId, nNpcId, 16)
		
					nNpcId = LuaFnCreateMonster(sceneId, 416, 61, 33, 1, 0, -1)
					SetCharacterName(sceneId, nNpcId, "Ð½n Ti¬u S½n")
					SetUnitReputationID(sceneId,selfId, nNpcId, 29)
					SetMonsterFightWithNpcFlag(sceneId, nNpcId, 1)
					SetNPCAIType(sceneId, nNpcId, 16)
				
				elseif nStep2 == 11 then
					nNpcId = LuaFnCreateMonster(sceneId, 429, 58, 33, 1, 0, -1)
					SetCharacterName(sceneId, nNpcId, "Du Câu")
					SetUnitReputationID(sceneId,selfId, nNpcId, 29)
					SetMonsterFightWithNpcFlag(sceneId, nNpcId, 1)
					SetNPCAIType(sceneId, nNpcId, 16)
					
					nNpcId = LuaFnCreateMonster(sceneId, 429, 60, 33, 1, 0, -1)
					SetCharacterName(sceneId, nNpcId, "Du Ký")
					SetUnitReputationID(sceneId,selfId, nNpcId, 29)
					SetMonsterFightWithNpcFlag(sceneId, nNpcId, 1)
					SetNPCAIType(sceneId, nNpcId, 16)
				
				elseif nStep2 == 15 then
					nNpcId = LuaFnCreateMonster(sceneId, 427, 58, 33, 1, 0, -1)
					SetCharacterName(sceneId, nNpcId, "Huy«n NÕn ")
					SetUnitReputationID(sceneId,selfId, nNpcId, 29)
					SetMonsterFightWithNpcFlag(sceneId, nNpcId, 1)
					SetNPCAIType(sceneId, nNpcId, 16)
					
					nNpcId = LuaFnCreateMonster(sceneId, 427, 60, 33, 1, 0, -1)
					SetCharacterName(sceneId, nNpcId, "Huy«n T¸ch")
					SetUnitReputationID(sceneId,selfId, nNpcId, 29)
					SetMonsterFightWithNpcFlag(sceneId, nNpcId, 1)
					SetNPCAIType(sceneId, nNpcId, 16)
					
				else
					for j=0, 9  do
						--415,417,418,425,426,428,431,432,433
						local nNpcModelList={415,417,418,425,426,428,431,432,433}
						local nNpcMode = random( getn(nNpcModelList) )
						local nNpc1 = LuaFnCreateMonster(sceneId, nNpcModelList[nNpcMode], 55+j, 31, 1, 0, -1)
						SetCharacterName(sceneId, nNpc1, "Hi®p sî giang h°")
						SetUnitReputationID(sceneId,selfId, nNpc1, 29)
						SetMonsterFightWithNpcFlag(sceneId, nNpc1, 1)
						SetNPCAIType(sceneId, nNpc1, 16)
					end
				end
				
				LuaFnSetCopySceneData_Param(sceneId, 13, nStep2+1)
				LuaFnSetCopySceneData_Param(sceneId, 12, nNowTime)
				
			end
			if nStep2 == 16 then
				--¿´Á½cáiºÍÉÐËÀÁËÃ»ÓÐ
				local nMonsterNum = GetMonsterCount(sceneId)
				local ii = 0
				local bHaveMonster = 0
				local bOk =1
				for ii=0, nMonsterNum-1 do
					local nMonsterId = GetMonsterObjID(sceneId,ii)
					if GetName(sceneId, nMonsterId)=="Huy«n NÕn" or GetName(sceneId, nMonsterId)=="Huy«n T¸ch"  then
						bOk = 0	
					end
				end
				
				if bOk == 1  then
					-- É¾³ýËùÓÐtoÕ ðµ Ð¡¹Ö
					local nMonsterNum = GetMonsterCount(sceneId)
					local ii = 0
					local bHaveMonster = 0
					local bOk =1
					for ii=0, nMonsterNum-1 do
						local nMonsterId = GetMonsterObjID(sceneId,ii)
						if GetName(sceneId, nMonsterId)== "Du Câu" then
							LuaFnDeleteMonster(sceneId, nMonsterId)
						end
						if GetName(sceneId, nMonsterId)== "Du Ký" then
							LuaFnDeleteMonster(sceneId, nMonsterId)
						end
						if GetName(sceneId, nMonsterId)== "Ð½n Bách S½n" then
							LuaFnDeleteMonster(sceneId, nMonsterId)
						end
						if GetName(sceneId, nMonsterId)== "Ð½n Trung S½n" then
							LuaFnDeleteMonster(sceneId, nMonsterId)
						end
						if GetName(sceneId, nMonsterId)== "Ð½n Thúc S½n" then
							LuaFnDeleteMonster(sceneId, nMonsterId)
						end
						if GetName(sceneId, nMonsterId)== "Ð½n Lý S½n" then
							LuaFnDeleteMonster(sceneId, nMonsterId)
						end
						if GetName(sceneId, nMonsterId)== "Ð½n Ti¬u S½n" then
							LuaFnDeleteMonster(sceneId, nMonsterId)
						end
						if GetName(sceneId, nMonsterId)== "Hi®p sî giang h°" then
							LuaFnDeleteMonster(sceneId, nMonsterId)
						end
					end
					
					LuaFnSetCopySceneData_Param(sceneId, 13, nStep2+1)
				end
			end	
					
			if nStep2 == 17 then
				-- ÇÇ·å¿ªÊ¼Ñ²Âß
				local nMonsterNum = GetMonsterCount(sceneId)
				local ii = 0
				local bHaveMonster = 0
				local bOk =1
				for ii=0, nMonsterNum-1 do
					local nMonsterId = GetMonsterObjID(sceneId,ii)
					if GetName(sceneId, nMonsterId)== "Ki«u Phong" then
						SetPatrolId(sceneId, nMonsterId, 0)
						LuaFnSetCopySceneData_Param(sceneId, 13, nStep2+1)
					end
				end	
			end
			
			if nStep2 == 18 then
				local nMonsterNum = GetMonsterCount(sceneId)
				local ii = 0
				local bHaveMonster = 0
				local bOk =1
				for ii=0, nMonsterNum-1 do
					local nMonsterId = GetMonsterObjID(sceneId,ii)
					if GetName(sceneId, nMonsterId)== "Ki«u Phong" then
						--¿´ÇÇ·åÐúng²»Ðúng×ßµ½ÖÕ ði¬mÁË
						--PrintStr("µ½ÖÕ ði¬mÁË")
						local targetX, targetZ = GetWorldPos(sceneId, nMonsterId)
						local x, z = GetLastPatrolPoint(sceneId, 0)
						local distance2 = floor(sqrt((targetX-x)*(targetX-x)+(targetZ-z)*(targetZ-z)))
						if distance2 <= 1 then
							--BroadMsgByChatPipe(sceneId,selfId,"A Châu: ÎÒ²»ÐÐÁË",0)
							CallScriptFunction((200060), "Duibai",sceneId, "A Châu", "Tø Hi«n Trang", "Ta không xong r°i" )
							LuaFnSetCopySceneData_Param(sceneId, 13, nStep2+1)
							LuaFnSetCopySceneData_Param(sceneId, 12, nNowTime)
						end
					end
				end	
			end
			
			if nStep2 == 19 then
				--BroadMsgByChatPipe(sceneId,selfId,"Ñ¦ÉñÒ½: ÇÇ·å,ÄãÔõÃ´°ì°.¬»¹¾ÈCái này Ñ¾Í·²»?",0)
				CallScriptFunction((200060), "Duibai",sceneId, "Tiªt Mµ Hoa", "Tø Hi«n Trang", "Ki«u Phong, ngß½i sao thª r°i. Còn cÑu con a ð¥u này à ?" )
				LuaFnSetCopySceneData_Param(sceneId, 13, nStep2+1)
				LuaFnSetCopySceneData_Param(sceneId, 12, nNowTime)
			end

			if nStep2 == 20 then	
				if nNowTime - nPreTime > 3  then
					LuaFnSetCopySceneData_Param(sceneId, 13, nStep2+1)
					LuaFnSetCopySceneData_Param(sceneId, 12, nNowTime)
					
					--ÇÇ·åÑ£ÔÎtoÕ ðµ ÌØÐ§
					local nMonsterNum = GetMonsterCount(sceneId)
					local ii = 0
					local bHaveMonster = 0
					for ii=0, nMonsterNum-1 do
						local nMonsterId = GetMonsterObjID(sceneId,ii)
						if GetName(sceneId, nMonsterId)== "Ki«u Phong" then
							LuaFnSendSpecificImpactToUnit(sceneId,selfId,nMonsterId,nMonsterId,45,10)
						end
					end
				end
			end
			
			if nStep2 == 21 then
				--´´½¨10cái¹ÖÀ´Î§¹¥ÇÇ·å
				local nNpc1 = LuaFnCreateMonster(sceneId, 415, 61, 62, 1, 0, -1)
				SetCharacterName(sceneId, nNpc1, "Hi®p sî giang h°")
				SetUnitReputationID(sceneId,selfId, nNpc1, 29)
				SetMonsterFightWithNpcFlag(sceneId, nNpc1, 1)
				SetNPCAIType(sceneId, nNpc1, 0)
				nNpc1 = LuaFnCreateMonster(sceneId, 415, 59, 62, 1, 0, -1)
				SetCharacterName(sceneId, nNpc1, "Hi®p sî giang h°")
				SetUnitReputationID(sceneId,selfId, nNpc1, 29)
				SetMonsterFightWithNpcFlag(sceneId, nNpc1, 1)
				SetNPCAIType(sceneId, nNpc1, 0)
				nNpc1 = LuaFnCreateMonster(sceneId, 415, 58, 63, 1, 0, -1)
				SetCharacterName(sceneId, nNpc1, "Hi®p sî giang h°")
				SetUnitReputationID(sceneId,selfId, nNpc1, 29)
				SetMonsterFightWithNpcFlag(sceneId, nNpc1, 1)
				SetNPCAIType(sceneId, nNpc1, 0)
				nNpc1 = LuaFnCreateMonster(sceneId, 415, 58, 65, 1, 0, -1)
				SetCharacterName(sceneId, nNpc1, "Hi®p sî giang h°")
				SetUnitReputationID(sceneId,selfId, nNpc1, 29)
				SetMonsterFightWithNpcFlag(sceneId, nNpc1, 1)
				SetNPCAIType(sceneId, nNpc1, 0)
				nNpc1 = LuaFnCreateMonster(sceneId, 415, 58, 66, 1, 0, -1)
				SetCharacterName(sceneId, nNpc1, "Hi®p sî giang h°")
				SetUnitReputationID(sceneId,selfId, nNpc1, 29)
				SetMonsterFightWithNpcFlag(sceneId, nNpc1, 1)
				SetNPCAIType(sceneId, nNpc1, 0)
				nNpc1 = LuaFnCreateMonster(sceneId, 415, 59, 66, 1, 0, -1)
				SetCharacterName(sceneId, nNpc1, "Hi®p sî giang h°")
				SetUnitReputationID(sceneId,selfId, nNpc1, 29)
				SetMonsterFightWithNpcFlag(sceneId, nNpc1, 1)
				SetNPCAIType(sceneId, nNpc1, 0)
				nNpc1 = LuaFnCreateMonster(sceneId, 415, 60, 66, 1, 0, -1)
				SetCharacterName(sceneId, nNpc1, "Hi®p sî giang h°")
				SetUnitReputationID(sceneId,selfId, nNpc1, 29)
				SetMonsterFightWithNpcFlag(sceneId, nNpc1, 1)
				SetNPCAIType(sceneId, nNpc1, 0)
				nNpc1 = LuaFnCreateMonster(sceneId, 415, 61, 65, 1, 0, -1)
				SetCharacterName(sceneId, nNpc1, "Hi®p sî giang h°")
				SetUnitReputationID(sceneId,selfId, nNpc1, 29)
				SetMonsterFightWithNpcFlag(sceneId, nNpc1, 1)
				SetNPCAIType(sceneId, nNpc1, 0)
				nNpc1 = LuaFnCreateMonster(sceneId, 415, 61, 64, 1, 0, -1)
				SetCharacterName(sceneId, nNpc1, "Hi®p sî giang h°")
				SetUnitReputationID(sceneId,selfId, nNpc1, 29)
				SetMonsterFightWithNpcFlag(sceneId, nNpc1, 1)
				SetNPCAIType(sceneId, nNpc1, 0)
				nNpc1 = LuaFnCreateMonster(sceneId, 415, 61, 63, 1, 0, -1)
				SetCharacterName(sceneId, nNpc1, "Hi®p sî giang h°")
				SetUnitReputationID(sceneId,selfId, nNpc1, 29)
				SetMonsterFightWithNpcFlag(sceneId, nNpc1, 1)
				SetNPCAIType(sceneId, nNpc1, 0)

				LuaFnSetCopySceneData_Param(sceneId, 13, nStep2+1)
				LuaFnSetCopySceneData_Param(sceneId, 12, nNowTime)
				
			end
			
			-- ´ò5 giâyÖÓ
			if nStep2 == 22 then
				if nNowTime - nPreTime > 3  then
					LuaFnSetCopySceneData_Param(sceneId, 13, nStep2+1)
					LuaFnSetCopySceneData_Param(sceneId, 12, nNowTime)
				end
			end
			
			if nStep2 == 23 then
				--BroadMsgByChatPipe(sceneId,selfId,"ÇÇ·å:ÇÇÄ³×ÔÐÐÁË¶Ï",0)
				CallScriptFunction((200060), "Duibai",sceneId, "Ki«u Phong", "Tø Hi«n Trang", "Tiêu m² tñ mình kªt li­u" )
				LuaFnSetCopySceneData_Param(sceneId, 13, nStep2+1)
				LuaFnSetCopySceneData_Param(sceneId, 12, nNowTime)
			end
			
			-- À´ºÚÒÂÈË
			if nStep2 == 24 then
				local nNpc1 = LuaFnCreateMonster(sceneId, 24, 61, 67, 1, 0, -1)
				SetCharacterName(sceneId, nNpc1, "H¡c Y ðÕi hán")
				
				-- ²¥·Åmµt cáiÌØÐ§
				LuaFnSendSpecificImpactToUnit(sceneId,selfId,nNpc1,nNpc1,43,5)
				
				CallScriptFunction((200060), "Duibai",sceneId, "H¡c Y ðÕi hán", "Tø Hi«n Trang", "Ð° ng¯c, ði theo ta" )
				
				--É±µôËùÓÐtoÕ ðµ ¹Ö
				local nMonsterNum = GetMonsterCount(sceneId)
				local ii = 0
				local bHaveMonster = 0
				local bOk =1
				for ii=0, nMonsterNum-1 do
					local nMonsterId = GetMonsterObjID(sceneId,ii)
					if GetName(sceneId, nMonsterId)== "Hi®p sî giang h°" then
						LuaFnDeleteMonster(sceneId, nMonsterId)
					end
				end
				
				LuaFnSetCopySceneData_Param(sceneId, 13, nStep2+1)
				LuaFnSetCopySceneData_Param(sceneId, 12, nNowTime)

			end
			
			if nStep2 == 25 then
				if nNowTime - nPreTime > 3  then
					LuaFnSetCopySceneData_Param(sceneId, 13, nStep2+1)
					LuaFnSetCopySceneData_Param(sceneId, 12, nNowTime)
					CallScriptFunction((200060), "Duibai",sceneId, "Ki«u Phong", "Tø Hi«n Trang", "$N, Ta giao A Châu cho ngß½i ð¤y! Ði tìm Tiªt Th¥n Y cÑu m®nh cüa cô ta, ði mau!" )
				end
			end
			
			if nStep2 == 26 then
				if nNowTime - nPreTime > 3  then
					LuaFnSetCopySceneData_Param(sceneId, 13, nStep2+1)
					LuaFnSetCopySceneData_Param(sceneId, 12, nNowTime)
				end
			end
			
			if nStep2 == 27 then
				local nMonsterNum = GetMonsterCount(sceneId)
				local ii = 0
				local bHaveMonster = 0
				local bOk =1
				for ii=0, nMonsterNum-1 do
					local nMonsterId = GetMonsterObjID(sceneId,ii)
					if GetName(sceneId, nMonsterId)== "H¡c Y ðÕi hán" then
						LuaFnDeleteMonster(sceneId, nMonsterId)
						LuaFnSendSpecificImpactToUnit(sceneId,selfId,nMonsterId,nMonsterId,44,5)
					end
					if GetName(sceneId, nMonsterId)== "Ki«u Phong" then
						LuaFnDeleteMonster(sceneId, nMonsterId)
						LuaFnSendSpecificImpactToUnit(sceneId,selfId,nMonsterId,nMonsterId,44,5)
					end
				end
				LuaFnSetCopySceneData_Param(sceneId, 13, nStep2+1)
				LuaFnSetCopySceneData_Param(sceneId, 12, nNowTime)
				
				-- ÉèÖÃÈÎÎñÍê³É
				LuaFnSetCopySceneData_Param(sceneId, 15, 1)
				
				--  ðÕt ðßþcÓÐCái này ÈÎÎñtoÕ ðµ ¸±±¾ÄÚtoÕ ðµ ËùÓÐÈË,¸øÉèÖÃÍê³É±êÖ¾ºÍÆÁÄ»ÌáÊ¾
				--PrintNum(nHumanNum)
				for i=0, nHumanNum-1  do
					local nPlayerId = LuaFnGetCopyScene_HumanObjId(sceneId,i)
					-- ÌáÊ¾Íæ¼Ò¾çÇéÍê³É
					BeginEvent(sceneId)
						AddText(sceneId, "Ðã bäo hµ Ki«u Phong thoát nguy: 1/1")
					EndEvent(sceneId)
					DispatchMissionTips(sceneId, nPlayerId)
										
					-- ²âÊÔCái này PlayerÐúng²»ÐúngÓÐCái này ÈÎÎñ
					if IsHaveMission(sceneId,nPlayerId,23) > 0 then
						local misIndex = GetMissionIndexByID(sceneId,nPlayerId,23)
						SetMissionByIndex( sceneId, nPlayerId, misIndex, 0, 1)
						SetMissionByIndex( sceneId, nPlayerId, misIndex, 1, 1)
					end
				end
			end
		end
	end
end

function x200023_TipToAllPlayerOnScene(sceneId, str)
	--  ðÕt ðßþc³¡¾°ÀïÍ·toÕ ðµ ËùÓÐÈË
	local nHumanNum = LuaFnGetCopyScene_HumanCount(sceneId)
	
	-- Ã»ÓÐÈËtoÕ ðµ ³¡¾°,Ê²Ã´¶¼²»×ö
	if nHumanNum < 1 then
		return
	end
	
	for i=0, nHumanNum-1  do
		local PlayerId = LuaFnGetCopyScene_HumanObjId(sceneId, i)
		
		BeginEvent(sceneId)
				AddText(sceneId, str)
		EndEvent(sceneId)
		DispatchMissionTips(sceneId, PlayerId)
	end
	
end

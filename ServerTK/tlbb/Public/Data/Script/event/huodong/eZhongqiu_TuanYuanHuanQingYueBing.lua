--»î¶¯¡ª¡ª
--ÖÐÇï»î¶¯-ÍÅÔ²»¶ÇìÔÂ±ý»î¶¯

--½Å±¾ºÅ
x808064_g_ScriptId = 808064
--»î¶¯Ê±¼ä--ÐèÒªÃ¿ÄêÎ¬»¤
--x808064_g_StartDayTime = 7267   --»î¶¯½áÊøÊ±¼ä 2007-9-25
--x808064_g_EndDayTime = 7283   --»î¶¯½áÊøÊ±¼ä 2007-10-11
x808064_g_StartDayTime = 8257   --»î¶¯½áÊøÊ±¼ä 2008-9-14,°üº¬µ±ÈÕ
x808064_g_EndDayTime = 8282   --»î¶¯½áÊøÊ±¼ä 2008-10-09,°üº¬µ±ÈÕ

x808064_g_TuanYuanPieSn = 30505130	--ÍÅÔ²»¶ÇìÔÂ±ýID
x808064_g_GuiHuaPieSn = 38000000		--¹ð»¨ÔÂ±ýID

--x808064_g_strPieInfo1 = "ÖÐÇïÍÅÔ²£¬Ê®Ò»»¶Çì£¬#c00ff00¡¶ÌìÁú°Ë²¿¡·#WÌØ±ðÎªÌìÁúÍæ¼Ò×¼±¸ÁËÍÅÔ²ºÃÀñ£¬´ÓÏÖÔÚÆðµ½10ÔÂ11ÈÕÎªÖ¹£¬10¼¶ÒÔÉÏµÄÍæ¼ÒÃ¿Ìì¶¼¿ÉÒÔÀ´ÎÒÕâÁìÈ¡Ò»´Î#c00ff00ÍÅÔ²»¶ÇìÔÂ±ý#WºÍ#c00ff00¹ð»¨ÔÂ±ý#W¡£Í¬Ê±·òÆÞ¹ØÏµ£¬½á°Ý¹ØÏµºÍÊ¦Í½¹ØÏµ»¹¿ÉÒÔ¶îÍâÔÙÁìÈ¡Ò»´Î¡£#r"
--x808064_g_strPieInfo2 = "Õâ¸ö½éÉÜÌ«³¤ÁË²ðµô·Å×ÖµäÀï°É£¡£¡£¡£¡£¡"
--x808064_g_strPlayerLvErr = "Ç×°®µÄÍæ¼Ò£¬Çë´ïµ½10¼¶ºóÔÙÀ´ÁìÈ¡¡£"
--x808064_g_strNotSpace = "ÄúµÄ°ü¹üÃ»ÓÐ×ã¹»¿Õ¼ä£¬ÇëÕûÀíºóÔÙÀ´ÁìÈ¡¡£"
--x808064_g_strTeamError2 = "ÇëÄúÓë°éÂÂµ¥¶À×é¶Ó£¬²¢È·ÈÏ¶Ô·½ÔÚÓÐÐ§·¶Î§ÄÚ²ÅÄÜÁìÈ¡¡£"
--x808064_g_strTeamError3 = "ÇëÓëÄúµÄ½á°Ý¹ØÏµÈË×é¶Ó£¬²¢È·ÈÏ¶Ô·½¶¼ÔÚÓÐÐ§·¶Î§ÄÚ²ÅÄÜÁìÈ¡¡£"
--x808064_g_strTeamError4 = "ÇëÈ·ÈÏ¶Ó³¤ÊÇÊ¦¸µ£¬²¢ÇÒ¶ÓÎéÖÐµÄÍ½µÜÈ«²¿ÊÇ¶Ó³¤µÄÍ½µÜ£¬Ê¦¸µ»òÍ½µÜÔÚÓÐÐ§·¶Î§ÄÚ²ÅÄÜÁìÈ¡¡£"
--x808064_g_strGetPieInfo = "ÖÐÇïÍÅÔ²£¬Ê®Ò»»¶Çì£¬×£ÄãÍòÊÂÈçÒâ£¬ÐÄÏëÊÂ³É¡£ÕâÁ½¿éÔÂ±ý¾ÍËÍ¸øÄãÁË¡£"
--x808064_g_strCannotToday1 = "²»ºÃÒâË¼£¬Äã½ñÌìÒÑ¾­ÁìÈ¡¹ý#c00ff00ÍÅÔ²»¶ÇìÔÂ±ý#WºÍ#c00ff00¹ð»¨ÔÂ±ý#WÁË¡£"
--x808064_g_strCannotToday2 = "²»ºÃÒâË¼£¬Äã½ñÌìÒÑ¾­ÁìÈ¡¹ý·òÆÞ#c00ff00ÍÅÔ²»¶ÇìÔÂ±ý#WºÍ#c00ff00¹ð»¨ÔÂ±ý#WÁË¡£"
--x808064_g_strCannotToday3 = "²»ºÃÒâË¼£¬Äã½ñÌìÒÑ¾­ÁìÈ¡¹ý½á°Ý#c00ff00ÍÅÔ²»¶ÇìÔÂ±ý#WºÍ#c00ff00¹ð»¨ÔÂ±ý#WÁË¡£"
--x808064_g_strCannotToday4a = "²»ºÃÒâË¼£¬×÷ÎªÊ¦¸µ£¬Äú½ñÌìÒÑ¾­ÁìÈ¡¹ýÊ¦Í½#c00ff00ÍÅÔ²»¶ÇìÔÂ±ý#WºÍ#c00ff00¹ð»¨ÔÂ±ý#WÁË¡£"
--x808064_g_strCannotToday4b = "²»ºÃÒâË¼£¬×÷ÎªÍ½µÜ£¬Äú½ñÌìÒÑ¾­ÁìÈ¡¹ýÊ¦Í½#c00ff00ÍÅÔ²»¶ÇìÔÂ±ý#WºÍ#c00ff00¹ð»¨ÔÂ±ý#WÁË¡£"


x808064_g_strPieInfo1 = "#{ZHONGQIUHUANQING_001}"
x808064_g_strPieInfo2 = "#{ZHONGQIUHUANQING_002}"
x808064_g_strPlayerLvErr = "#{ZHONGQIUHUANQING_003}"
x808064_g_strNotSpace = "#{ZHONGQIUHUANQING_004}"
x808064_g_strTeamError2 = "#{ZHONGQIUHUANQING_005}"
x808064_g_strTeamError3 = "#{ZHONGQIUHUANQING_006}"
x808064_g_strTeamError4 = "#{ZHONGQIUHUANQING_007}"
x808064_g_strGetPieInfo = "#{ZHONGQIUHUANQING_008}"
x808064_g_strCannotToday1 = "#{ZHONGQIUHUANQING_009}"
x808064_g_strCannotToday2 = "#{ZHONGQIUHUANQING_010}"
x808064_g_strCannotToday3 = "#{ZHONGQIUHUANQING_011}"
x808064_g_strCannotToday4a = "#{ZHONGQIUHUANQING_012}"
x808064_g_strCannotToday4b = "#{ZHONGQIUHUANQING_013}"


--**********************************
--ÈÎÎñÈë¿Úº¯Êý
--**********************************
function x808064_OnDefaultEvent( sceneId, selfId, targetId )

	local isTime = x808064_CheckRightTime()
	if 1 ~= isTime then
		return
	end
	
	local NumText = GetNumText()

	if NumText == 101 then

		BeginEvent(sceneId)
			AddText(sceneId, x808064_g_strPieInfo1)
			AddNumText(sceneId, x808064_g_ScriptId, "TÕi hÕ mu¯n nh§n thß·ng", 6, 701 )
			AddNumText(sceneId, x808064_g_ScriptId, "Quan h® Phu Thê nh§n thß·ng", 6, 702 )
			AddNumText(sceneId, x808064_g_ScriptId, "Quan h® Kªt Bái nh§n thß·ng", 6, 703 )
			AddNumText(sceneId, x808064_g_ScriptId, "Quan h® Sß Ð° nh§n thß·ng", 6, 704 )
			--AddNumText(sceneId, x808064_g_ScriptId, "Ê²Ã´ÊÇÍÅÔ²»¶Çì»î¶¯£¿", 11, 705 )
		EndEvent(sceneId)
		DispatchEventList(sceneId,selfId,targetId)

	elseif NumText == 701 then

		--Áì¸öÈËÔÂ±ý....
		x808064_GiveSelfPie( sceneId, selfId, targetId )

	elseif NumText == 702 then

		--Áì·òÆÞÔÂ±ý....
		x808064_GiveFuqiPie( sceneId, selfId, targetId )

	elseif NumText == 703 then

		--Áì½á°ÝÔÂ±ý....
		x808064_GiveJiebaiPie( sceneId, selfId, targetId )

	elseif NumText == 704 then

		--ÁìÊ¦Í½ÔÂ±ý....
		x808064_GiveShituPie( sceneId, selfId, targetId )

	elseif NumText == 705 then

		BeginEvent(sceneId)
			AddText( sceneId, x808064_g_strPieInfo2 )
		EndEvent(sceneId)
		DispatchEventList(sceneId,selfId,targetId)

	end

end

--**********************************
--ÁÐ¾ÙÊÂ¼þ
--**********************************
function x808064_OnEnumerate( sceneId, selfId, targetId )

    local isTime = x808064_CheckRightTime()
    if 1 == isTime then
			AddNumText(sceneId, x808064_g_ScriptId, "Lînh Bánh trung thu chào m×ng Ðoàn Viên", 6, 101 )													
    end

end

--**********************************
--¼ì²â»î¶¯ÊÇ·ñÒÑ½áÊø
--**********************************
function x808064_CheckRightTime()

	local curDayTime = GetDayTime()
	if curDayTime >= x808064_g_StartDayTime and curDayTime <= x808064_g_EndDayTime then
		return 1
	else
		return 0
	end

end

--**********************************
--Áì¸öÈËÔÂ±ý
--**********************************
function x808064_GiveSelfPie( sceneId, selfId, targetId )

	--¼ì²âÍæ¼ÒµÈ¼¶....
	if x808064_CheckPlayerLv( sceneId, selfId, targetId ) == 0 then
		return
	end

	--½ñÌìÊÇ·ñÒÑ¾­Áì¹ýÁË....
	local lastDayTime = GetMissionData( sceneId, selfId, MD_ZHONGQIU_TUANYUANPIE1_DAYTIME )
	local CurDayTime = GetDayTime()
	if CurDayTime <= lastDayTime then
		BeginEvent(sceneId)
			AddText( sceneId, x808064_g_strCannotToday1 )
		EndEvent(sceneId)
		DispatchEventList(sceneId,selfId,targetId)
		return
	end

	--¼ì²â±³°üÊÇ·ñÓÐµØ·½....
	if x808064_CheckPacketSpace( sceneId, selfId, targetId ) == 0 then
		return
	end

	--¸øÍæ¼ÒÔÂ±ý....
	BeginEvent(sceneId)
		AddText( sceneId, x808064_g_strGetPieInfo )
	EndEvent(sceneId)
	DispatchEventList(sceneId,selfId,targetId)

	x808064_GivePlayerPie( sceneId, selfId )
	SetMissionData( sceneId, selfId, MD_ZHONGQIU_TUANYUANPIE1_DAYTIME, CurDayTime )

end

--**********************************
--Áì·òÆÞÔÂ±ý
--**********************************
function x808064_GiveFuqiPie( sceneId, selfId, targetId )

	--¼ì²âÍæ¼ÒµÈ¼¶....
	if x808064_CheckPlayerLv( sceneId, selfId, targetId ) == 0 then
		return
	end

	--ÊÇ·ñ2ÈË¶ÓÎé....²¢ÇÒ¶ÓÔ±È«²¿ÔÚ¸½½ü....
	local TeamSize = LuaFnGetTeamSize( sceneId, selfId )
	local NearTeamSize = GetNearTeamCount( sceneId, selfId )
	if TeamSize ~= 2 or TeamSize ~= NearTeamSize then
		BeginEvent(sceneId)
			AddText( sceneId, x808064_g_strTeamError2 )
		EndEvent(sceneId)
		DispatchEventList(sceneId,selfId,targetId)
		return
	end

	--ÊÇ·ñ·òÆÞ....
	local	ObjID0		= GetNearTeamMember( sceneId, selfId, 0 )
	local	ObjID1		= GetNearTeamMember( sceneId, selfId, 1 )
	local	SelfGUID	= LuaFnObjId2Guid( sceneId, ObjID0 )
	local	SpouGUID	= LuaFnGetSpouseGUID( sceneId, ObjID1 )
	if LuaFnIsMarried( sceneId, ObjID0 ) == 0 or LuaFnIsMarried( sceneId, ObjID1 ) == 0 or SelfGUID ~= SpouGUID then
		BeginEvent(sceneId)
			AddText( sceneId, x808064_g_strTeamError2 )
		EndEvent(sceneId)
		DispatchEventList(sceneId,selfId,targetId)
		return
	end

	--½ñÌìÊÇ·ñÒÑ¾­Áì¹ýÁË....
	local lastDayTime = GetMissionData( sceneId, selfId, MD_ZHONGQIU_TUANYUANPIE2_DAYTIME )
	local CurDayTime = GetDayTime()
	if CurDayTime <= lastDayTime then
		BeginEvent(sceneId)
			AddText( sceneId, x808064_g_strCannotToday2 )
		EndEvent(sceneId)
		DispatchEventList(sceneId,selfId,targetId)
		return
	end

	--¼ì²â±³°üÊÇ·ñÓÐµØ·½....
	if x808064_CheckPacketSpace( sceneId, selfId, targetId ) == 0 then
		return
	end

	--¸øÍæ¼ÒÔÂ±ý....
	BeginEvent(sceneId)
		AddText( sceneId, x808064_g_strGetPieInfo )
	EndEvent(sceneId)
	DispatchEventList(sceneId,selfId,targetId)

	x808064_GivePlayerPie( sceneId, selfId )
	SetMissionData( sceneId, selfId, MD_ZHONGQIU_TUANYUANPIE2_DAYTIME, CurDayTime )

end

--**********************************
--Áì½á°ÝÔÂ±ý
--**********************************
function x808064_GiveJiebaiPie( sceneId, selfId, targetId )

	--¼ì²âÍæ¼ÒµÈ¼¶....
	if x808064_CheckPlayerLv( sceneId, selfId, targetId ) == 0 then
		return
	end

	--ÊÇ·ñ2ÈË(º¬)ÒÔÉÏ¶ÓÎé....²¢ÇÒ¶ÓÔ±È«²¿ÔÚ¸½½ü....
	local TeamSize = LuaFnGetTeamSize( sceneId, selfId )
	local NearTeamSize = GetNearTeamCount( sceneId, selfId )
	if TeamSize < 2 or TeamSize ~= NearTeamSize then
		BeginEvent(sceneId)
			AddText( sceneId, x808064_g_strTeamError3 )
		EndEvent(sceneId)
		DispatchEventList(sceneId,selfId,targetId)
		return
	end

	--ÊÇ·ñÈ«²¿½á°Ý....
	local allJieBai = 1
	local firstPlayer = GetNearTeamMember( sceneId, selfId, 0 )
	local otherPlayer
	for i=1, NearTeamSize-1 do
		otherPlayer = GetNearTeamMember( sceneId, selfId, i )
		if LuaFnIsBrother(sceneId, firstPlayer, otherPlayer) ~= 1 then
			allJieBai = 0
		end
	end
	if allJieBai == 0 then
		BeginEvent(sceneId)
			AddText( sceneId, x808064_g_strTeamError3 )
		EndEvent(sceneId)
		DispatchEventList(sceneId,selfId,targetId)
		return
	end

	--½ñÌìÊÇ·ñÒÑ¾­Áì¹ýÁË....
	local lastDayTime = GetMissionData( sceneId, selfId, MD_ZHONGQIU_TUANYUANPIE3_DAYTIME )
	local CurDayTime = GetDayTime()
	if CurDayTime <= lastDayTime then
		BeginEvent(sceneId)
			AddText( sceneId, x808064_g_strCannotToday3 )
		EndEvent(sceneId)
		DispatchEventList(sceneId,selfId,targetId)
		return
	end

	--¼ì²â±³°üÊÇ·ñÓÐµØ·½....
	if x808064_CheckPacketSpace( sceneId, selfId, targetId ) == 0 then
		return
	end

	--¸øÍæ¼ÒÔÂ±ý....
	BeginEvent(sceneId)
		AddText( sceneId, x808064_g_strGetPieInfo )
	EndEvent(sceneId)
	DispatchEventList(sceneId,selfId,targetId)

	x808064_GivePlayerPie( sceneId, selfId )
	SetMissionData( sceneId, selfId, MD_ZHONGQIU_TUANYUANPIE3_DAYTIME, CurDayTime )

end

--**********************************
--ÁìÊ¦Í½ÔÂ±ý
--**********************************
function x808064_GiveShituPie( sceneId, selfId, targetId )

	--¼ì²âÍæ¼ÒµÈ¼¶....
	if x808064_CheckPlayerLv( sceneId, selfId, targetId ) == 0 then
		return
	end

	--ÊÇ·ñ2ÈË(º¬)ÒÔÉÏ¶ÓÎé....²¢ÇÒ¶ÓÔ±È«²¿ÔÚ¸½½ü....
	local TeamSize = LuaFnGetTeamSize( sceneId, selfId )
	local NearTeamSize = GetNearTeamCount( sceneId, selfId )
	if TeamSize < 2 or TeamSize ~= NearTeamSize then
		BeginEvent(sceneId)
			AddText( sceneId, x808064_g_strTeamError4 )
		EndEvent(sceneId)
		DispatchEventList(sceneId,selfId,targetId)
		return
	end

	--¶ÓÎéÊÇ·ñ¶ÓÔ±È«ÊÇ¶Ó³¤Í½µÜ....
	local OkTeam = 1
	local leaderID = GetTeamLeader( sceneId, selfId )
	local otherPlayer
	for i=0, NearTeamSize-1 do
		otherPlayer = GetNearTeamMember( sceneId, selfId, i )
		if leaderID ~= otherPlayer and LuaFnIsMaster(sceneId, otherPlayer, leaderID) ~= 1 then
			OkTeam = 0
		end
	end
	if OkTeam == 0 then
		BeginEvent(sceneId)
			AddText( sceneId, x808064_g_strTeamError4 )
		EndEvent(sceneId)
		DispatchEventList(sceneId,selfId,targetId)
		return
	end

	--½ñÌìÊÇ·ñÒÑ¾­Áì¹ýÁË....
	local lastDayTime
	if leaderID == selfId then
		lastDayTime = GetMissionData( sceneId, selfId, MD_ZHONGQIU_TUANYUANPIE4A_DAYTIME )
	else
		lastDayTime = GetMissionData( sceneId, selfId, MD_ZHONGQIU_TUANYUANPIE4B_DAYTIME )
	end
	local CurDayTime = GetDayTime()
	if CurDayTime <= lastDayTime then
		BeginEvent(sceneId)
			if leaderID == selfId then
				AddText( sceneId, x808064_g_strCannotToday4a )
			else
				AddText( sceneId, x808064_g_strCannotToday4b )
			end
		EndEvent(sceneId)
		DispatchEventList(sceneId,selfId,targetId)
		return
	end

	--¼ì²â±³°üÊÇ·ñÓÐµØ·½....
	if x808064_CheckPacketSpace( sceneId, selfId, targetId ) == 0 then
		return
	end

	--¸øÍæ¼ÒÔÂ±ý....
	BeginEvent(sceneId)
		AddText( sceneId, x808064_g_strGetPieInfo )
	EndEvent(sceneId)
	DispatchEventList(sceneId,selfId,targetId)

	x808064_GivePlayerPie( sceneId, selfId )
	if leaderID == selfId then
		SetMissionData( sceneId, selfId, MD_ZHONGQIU_TUANYUANPIE4A_DAYTIME, CurDayTime )
	else
		SetMissionData( sceneId, selfId, MD_ZHONGQIU_TUANYUANPIE4B_DAYTIME, CurDayTime )
	end

end

--**********************************
--¼ì²âÍæ¼ÒµÈ¼¶ÊÇ·ñ·ûºÏÒªÇó
--**********************************
function x808064_CheckPlayerLv( sceneId, selfId, targetId )

	if GetLevel( sceneId, selfId ) < 10 then
		BeginEvent(sceneId)
			AddText( sceneId, x808064_g_strPlayerLvErr )
		EndEvent(sceneId)
		DispatchEventList(sceneId,selfId,targetId)
		return 0
	else
		return 1
	end

end

--**********************************
--¼ì²âÍæ¼Ò±³°ü¿Õ¼äÊÇ·ñ×ã¹»
--**********************************
function x808064_CheckPacketSpace( sceneId, selfId, targetId )

	if LuaFnGetPropertyBagSpace( sceneId, selfId ) < 2 then
		BeginEvent(sceneId)
			AddText( sceneId, x808064_g_strNotSpace )
		EndEvent(sceneId)
		DispatchEventList(sceneId,selfId,targetId)
		return 0
	else
		return 1
	end

end

--**********************************
--¸øÍæ¼ÒÍÅÔ²»¶ÇìÔÂ±ýºÍ¹ð»¨ÔÂ±ý
--**********************************
function x808064_GivePlayerPie( sceneId, selfId )

	--¸øÍÅÔ²»¶ÇìÔÂ±ý....
	TryRecieveItem( sceneId, selfId, x808064_g_TuanYuanPieSn, QUALITY_MUST_BE_CHANGE )

	--¸ø¹ð»¨ÔÂ±ý....
	local BagIndex = TryRecieveItem( sceneId, selfId, x808064_g_GuiHuaPieSn, QUALITY_MUST_BE_CHANGE )
	if BagIndex ~= -1 then
		--ÉèÖÃÎïÆ·ËùÓÐÕß....¹ð»¨ÔÂ±ý×Ô¼º²»ÄÜÓÃ....Ö»ÄÜËÍ¸ø±ðÈËÓÃ....ËùÒÔÒª¼ÇÂ¼ËùÓÐÕßµÄGUID....
		local guid = LuaFnGetGUID( sceneId, selfId )
		SetBagItemParam( sceneId, selfId, BagIndex, 4, 2, guid-2147483648 )
		--ÉèÖÃÎïÆ·´´½¨Õß....ÓÃÓÚÀñÆ·ÀàÎïÆ·ÔÚtooltipsÉÏÏÔÊ¾"xxxµÄÀñÆ·"....
		LuaFnSetItemCreator( sceneId, selfId, BagIndex, GetName( sceneId, selfId ) )
		LuaFnRefreshItemInfo( sceneId, selfId, BagIndex )
	end

end

--**********************************
--¼ì²â½ÓÊÜÌõ¼þ
--**********************************
function x808064_CheckAccept( sceneId, selfId )
end

--**********************************
--½ÓÊÜ
--**********************************
function x808064_OnAccept( sceneId, selfId )
end

--**********************************
--·ÅÆú
--**********************************
function x808064_OnAbandon( sceneId, selfId )
end

--**********************************
--¼ÌÐø
--**********************************
function x808064_OnContinue( sceneId, selfId, targetId )
end

--**********************************
--¼ì²âÊÇ·ñ¿ÉÒÔÌá½»
--**********************************
function x808064_CheckSubmit( sceneId, selfId )
end

--**********************************
--Ìá½»
--**********************************
function x808064_OnSubmit( sceneId, selfId, targetId, selectRadioId )
end

--**********************************
--É±ËÀ¹ÖÎï»òÍæ¼Ò
--**********************************
function x808064_OnKillObject( sceneId, selfId, objdataId ,objId )
end

--**********************************
--½øÈëÇøÓòÊÂ¼þ
--**********************************
function x808064_OnEnterArea( sceneId, selfId, zoneId )
end

--**********************************
--µÀ¾ß¸Ä±ä
--**********************************
function x808064_OnItemChanged( sceneId, selfId, itemdataId )
end

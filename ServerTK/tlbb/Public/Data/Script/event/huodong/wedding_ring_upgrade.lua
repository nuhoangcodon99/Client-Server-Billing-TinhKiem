--½á»é½äÖ¸Éý¼¶
--Created by zchw
--ÂåÑô 

--ÈÎÎñÃû
--MisDescBegin
--½Å±¾ºÅ
x808010_g_ScriptId	= 808010
--½ÓÊÜÈÎÎñNPCÊôÐÔ
x808010_g_Position_X=47.0185
x808010_g_Position_Z=62.9575
x808010_g_SceneID=0
x808010_g_AccomplishNPC_Name="Nguy®t Lão "

--ÈÎÎñºÅ
x808010_g_MissionId			= 1144

--ÈÎÎñÄ¿±ênpc
x808010_g_Name 					= "Nguy®t Lão "
--ÈÎÎñ¹éÀà
x808010_g_MissionKind			= 11
--ÈÎÎñµÈ¼¶
x808010_g_MissionLevel		= 10000
--ÊÇ·ñÊÇ¾«Ó¢ÈÎÎñ
x808010_g_IfMissionElite	= 0
--ÈÎÎñÊÇ·ñÒÑ¾­Íê³É
x808010_g_IsMissionOkFail	= 0		--ÈÎÎñ²ÎÊýµÄµÚ0Î»

--ÈÎÎñÎÄ±¾ÃèÊö
x808010_g_MissionName			= "Vînh H¢ng Toàn Gi¾i"
--ÈÎÎñÃèÊö
x808010_g_MissionInfo			= ""
--ÈÎÎñÄ¿±ê
x808010_g_MissionTarget		= "%f"
--Î´Íê³ÉÈÎÎñµÄnpc¶Ô»°
x808010_g_ContinueInfo		= ""
--Íê³ÉÈÎÎñnpcËµµÄ»°
x808010_g_MissionComplete	= ""

x808010_g_StrForePart = 4

--ÓÃÀ´±£´æ×Ö·û´®¸ñÊ½»¯µÄÊý¾Ý
x808010_g_FormatList = {"T± ðµi phu thê ðªn g£p %s,%s,%s, Nguy®t Lão ð¬ thu th§p tiên khí",}
								
x808010_g_StrList = {
	"Vô Lßþng S½n - BÕch Viên ThÕch Tr§n#{_INFOAIM53,264,6,}",
	"Kiªm Các - Kiªm Môn Ði®p Thuý#{_INFOAIM130,135,7,}",
	"Ðôn Hoàng - Hãn Häi C¥u Ph¤t#{_INFOAIM260,260,8,}",
	"Kính H° - Ng÷c Ðái Lâm Phong#{_INFOAIM39,261,5,}",
	"Thái H° - Vû TÕ Ca Ðài#{_INFOAIM160,252,4,}",
	"Tung S½n - Giang S½n Ða Ki«u#{_INFOAIM275,85,3,}",
	"DÕ Tây H° - Nh¤t V÷ng H± Bào#{_INFOAIM170,235,30,}",
	"Nhî Häi - Bá Khä Tranh Lßu#{_INFOAIM260,270,24,}",
	"NhÕn Nam - Phong Ki«u T¸ch Chiªu#{_INFOAIM150,250,18,}",
	"Long Tuy«n - Phi Lßu Trñc HÕ#{_INFOAIM270,280,31,}",
	"Thß½ng S½n - Tñ ThuÖ Niên Hoa#{_INFOAIM258,73,25,}",
	"NhÕc B¡c - Bích L§p Hoàng Thiên Nhçn#{_INFOAIM283,179,19,}",
	"Võ Di - Yên Toä Nh¸ Ki«u#{_INFOAIM54,182,32,}",
	"ThÕch Lâm - Phong Loan Nh§p Tø#{_INFOAIM195,53,26,}",
	"Thäo Nguyên - Lang Vß½ng ThÕch Tr§n#{_INFOAIM143,254,20,}",
	"Mai Lînh - Mai Lînh Ph§t Quang#{_INFOAIM284,82,33,}",
	"Ng÷c Khê - Thanh My Nhß Ð§u#{_INFOAIM268,116,27,}",
	"Liêu Tây - Ngao Bang Tß½ng Hµi#{_INFOAIM277,117,21,}",
	"Nam Häi - Thiên Nam Nh¤t Trø#{_INFOAIM61,225,34,}",
	"Hoàng Long Phü - Thiên Trì Tuyªt Cänh#{_INFOAIM289,66,23,}",
}

x808010_g_MaxRound	= 3
--¿ØÖÆ½Å±¾
x808010_g_ControlScript		= 808010

--ÈÎÎñÍê³ÉÇé¿ö,ÄÚÈÝ¶¯Ì¬Ë¢ÐÂ,·Ö±ðÕ¼ÓÃÈÎÎñ²ÎÊýµÄµÚ1Î»
x808010_g_Custom	= { {id="Thu th§p linh khí ",num=3}}
--MisDescEnd

--¸øÓÀºã×ê½ä¿ÛÇ®
x808010_g_Price  	= 1000;
--Ó©»ð³æID
x808010_g_FlashInsect_id = 30501104;
--ÔÂ¹âºùÂ«ID
x808010_g_HuLu_id = 40004465;
--ÓÀºã×ê½äµÈ¼¶ID¶ÔÓ¦±í
x808010_g_Level2RingId =
{
	[1] = {Lvl = 30, RingId = 10422125},
	[2] = {Lvl = 50, RingId = 10422126},
	[3] = {Lvl = 70, RingId = 10422127},
	[4] = {Lvl = 90, RingId = 10422128},
	[5] = {Lvl = 100, RingId = 10422129},
	[6] = {Lvl = 105, RingId = 10422130},
	[7] = {Lvl = 110, RingId = 10422131},
	[8] = {Lvl = 115, RingId = 10422132},
	[9] = {Lvl = 120, RingId = 10422132}, -- add by zchw TT:41264
}
--ÓÀºã×ê½äÓë×£¸£½äÖ¸ID±í
x808010_g_RingId_Mapping =
{
	[1] = {10422125, 10422126, 10422127, 10422128, 10422129, 10422130, 10422131, 10422132}, 	--ÓÀºã×ê½ä
	[2] = {10422133, 10422134, 10422135, 10422136, 10422137, 10422138, 10422139, 10422140},		--×£¸£½äÖ¸	
}

--³¡¾°ÐÅÏ¢±í
x808010_g_select_sceneId = 
{
	[1]=  {6, 	"Vô Lßþng S½n - BÕch Viên ThÕch Tr§n", 	53,264, 612},
	[2]=  {7, 	"Kiªm Các - Kiªm Môn Ði®p Thuý",   	130,135, 711},
	[3]=  {8, 	"Ðôn Hoàng - Hãn Häi C¥u Ph¤t",			260,260, 813},
	[4]=  {5, 	"Kính H° - Ng÷c Ðái Lâm Phong",			39,261, 513},
	[5]=  {4, 	"Thái H° - Vû TÕ Ca Ðài",			160,252, 411},
	[6]=  {3, 	"Tung S½n - Giang S½n Ða Ki«u",			275,85, 311},
	[7]=  {30, 	"DÕ Tây H° - Nh¤t V÷ng H± Bào",     170,235, 3011},
	[8]=  {24, 	"Nhî Häi - Bá Khä Tranh Lßu",     260,270, 2411},
	[9]=  {18, 	"NhÕn Nam - Phong Ki«u T¸ch Chiªu",     150,250, 1811},
	[10]= {31, 	"Long Tuy«n - Phi Lßu Trñc HÕ",     270,280, 3111},
	[11]= {25, 	"Thß½ng S½n - Tñ ThuÖ Niên Hoa",     258,73, 2513},
	[12]= {19, 	"NhÕc B¡c - Bích L§p Hoàng Thiên Nhçn",     283,179, 1912},
	[13]= {32, 	"Võ Di - Yên Toä Nh¸ Ki«u",     54,182, 3211},
	[14]= {26, 	"ThÕch Lâm - Phong Loan Nh§p Tø",     195,53, 2614},
	[15]= {20, 	"Thäo Nguyên - Lang Vß½ng ThÕch Tr§n",     143,254, 2012},
	[16]= {33, 	"Mai Lînh - Mai Lînh Ph§t Quang",     284,82, 3313},
	[17]= {27, 	"Ng÷c Khê - Thanh My Nhß Ð§u",     268,116, 2713},
	[18]= {21, 	"Liêu Tây - Ngao Bang Tß½ng Hµi",     277,117, 2113},
	[19]= {34, 	"Nam Häi - Thiên Nam Nh¤t Trø",     61,225, 3411},
	[20]= {23,	"Hoàng Long Phü - Thiên Trì Tuyªt Cänh",   289,66, 2313},
}

--µÈ¼¶¶ÔÓ¦³¡¾°³éÈ¡Ô´ÊýÄ¿
x808010_g_level_num =
{
	{min = 30, max = 49, num = 10},
	{min = 50, max = 69, num = 15},
	{min = 70, max = 89, num = 18},
	{min = 90, max = 120, num = 20},
}

--ÕæÐÄÊ¯Id
x808010_g_TrueLoveStone_id = 30700204;

--**********************************
--ÈÎÎñÈë¿Úº¯Êý
--**********************************
function x808010_OnDefaultEvent( sceneId, selfId, targetId )
	local numText = GetNumText();
	--ÓÀºã×ê½ä
	if numText == 1 then
		x808010_OnClickTrueLoveRing(sceneId, selfId, targetId);
	--ÓÀºã×ê½ä°ïÖú
	elseif numText == 2 then
		x808010_ReturnDlg(sceneId, selfId, targetId, "#{YHJZ_081007_48}");
	--ÁìÈ¡ÓÀºã×ê½ä
	elseif numText == 11 then
		x808010_GetTrueLoveRing(sceneId, selfId, targetId);
	--Éý¼¶ÓÀºã×ê½ä
	elseif numText == 12 then
		x808010_UpgradeTrueLoveRing(sceneId, selfId, targetId);
	--×£¸£ÓÀºã×ê½ä
	elseif numText == 13 then
	 	BeginEvent(sceneId)
			AddText(sceneId, "#{YHJZ_081007_26}");
			AddNumText(sceneId, x808010_g_ScriptId, "Ch¤p nh§n", 6, 131);
			AddNumText(sceneId, x808010_g_ScriptId, "T× bö", 6, 132);
		EndEvent()
		DispatchEventList(sceneId, selfId, targetId);
	--Íê³ÉÈÎÎñ£¬Ñ¡Ôñ"ÊÇµÄ"
	elseif numText == 111 then
		x808010_ConfirmSubmitMission(sceneId, selfId, targetId);
	--È·¶¨ Éý¼¶×ê½ä
	elseif numText == 333 then
		x808010_ConfirmUpgrade(sceneId, selfId, targetId);
	--nothing
	elseif numText == 14 or numText == 444 or numText == 222 then
	 	BeginUICommand( sceneId )
		UICommand_AddInt( sceneId, targetId )
		EndUICommand( sceneId )
		DispatchUICommand( sceneId, selfId, 1000 )	
	--½ÓÊÜ ×£¸£×ê½ä
	elseif numText == 131 then
		x808010_BlessRing(sceneId, selfId, targetId);		
	--·µ»Ø ×£¸£×ê½ä
	elseif numText == 132 then
		x808010_ListOption(sceneId, selfId, targetId);
	end
end

--**********************************
--·òÆÞ×é¶ÓÅÐ¶Ï
--**********************************
function x808010_IsCoupleMakeTeam(sceneId,selfId,type)
	--1.ÊÇ·ñ×é¶Ó
	local teamId = GetTeamId(sceneId,selfId)
	if teamId<0 then
		if type == 1 then
			return 0, "#{YHJZ_081007_9}";
		elseif type == 2 then
			return 0, "#{YHJZ_081007_14}";
		else
			return 0, "#{YHJZ_081007_27}";
		end
	end	
	--2.ÊÇ·ñÁ©ÈË
	if GetTeamSize(sceneId,selfId)~=2 then
		if type == 1 then
			return 0, "#{YHJZ_081007_9}";
		elseif type == 2 then
			return 0, "#{YHJZ_081007_14}";
		else
			return 0, "#{YHJZ_081007_9}";
		end
	end	
	--3.ÊÇ·ñÔÚ¸½½ü
	if GetNearTeamCount(sceneId,selfId) ~= 2 then
		if type == 1 then
			return 0, "#{YHJZ_081007_9}";
		elseif type == 2 then
			return 0, "#{YHJZ_081007_15}";
		else
			return 0, "#{YHJZ_081007_28}";
		end
	end	
	--4.ÊÇ·ñÊÇ·òÆÞ
	local tid1 = GetNearTeamMember(sceneId,selfId,0)
	local tid2 = GetNearTeamMember(sceneId,selfId,1)
	if LuaFnIsMarried(sceneId,selfId)<=0 then
		if type == 1 then
			return 0, "#{YHJZ_081007_8}";
		elseif type == 2 then
			return 0, "#{YHJZ_081007_14}"
		else
			return 0, "#{YHJZ_081007_27}";
		end
	else
		if LuaFnGetSpouseGUID(sceneId,tid1) ~= LuaFnGetGUID(sceneId,tid2) or LuaFnGetSpouseGUID(sceneId,tid2) ~= LuaFnGetGUID(sceneId,tid1) then
			if type == 1 then
				return 0, "#{YHJZ_081007_9}";
			elseif type == 2 then
				return 0, "#{YHJZ_081007_14}";
			else
				return 0, "#{YHJZ_081007_27}";
			end
		end
	end	
	--ok
	return 1, "ok";
end

--**********************************
--ÁÐ¾ÙÑ¡Ïî
--**********************************
function x808010_ListOption(sceneId, selfId, targetId)
	BeginEvent(sceneId)
		AddText(sceneId, "#{YHJZ_081007_3}")
		AddNumText(sceneId, x808010_g_ScriptId, "#{YHJZ_081007_4}", 1, 11); 			--ÎÒÒªÁìÈ¡ÓÀºã×ê½ä
		AddNumText(sceneId, x808010_g_ScriptId, "#{YHJZ_081007_5}", 1, 12); 			--ÎÒÏëÉý¼¶ÓÀºã×ê½ä
		AddNumText(sceneId, x808010_g_ScriptId, "#{YHJZ_081007_6}", 1, 13); 			--ÎÒÏë×£¸£ÓÀºã×ê½ä
		AddNumText(sceneId, x808010_g_ScriptId, "#{YHJZ_081007_7}", 9, 14);	  		--ÎÒÃ»Ê²Ã´ÊÂ...
	EndEvent()
	DispatchEventList(sceneId, selfId, targetId);
end

--**********************************
--ÁÐ¾ÙÊÂ¼þ
--**********************************
function x808010_OnEnumerate( sceneId, selfId, targetId )
	AddNumText(sceneId, x808010_g_ScriptId, "#{YHJZ_081007_1}", 6, 1);				--ÓÀºã×ê½ä
	AddNumText(sceneId, x808010_g_ScriptId, "#{YHJZ_081007_2}", 11, 2);				--¹ØÓÚÓÀºã×ê½ä
end

--**********************************
--¼ì²â½ÓÊÜÌõ¼þ
--**********************************
function x808010_CheckAccept( sceneId, selfId, type )
  if type == 1 then 		--ÁìÈ¡
  	--µÈ¼¶´ïµ½30£¿
  	if GetLevel(sceneId, selfId) < 30 then
  		return 0, "#{YHJZ_081007_47}";
  	end
		--·òÆÞ2ÈË×é¶Ó£¿
		local ret, msg = x808010_IsCoupleMakeTeam(sceneId, selfId, 1);
		if ret == 0 then
			return 0, msg;
		end
	 	--ÓÐÓÀºã×ê½ä or ×£¸£×ê½ä£¿
	 	for i=1, 2 do
	 		for j, subTab in x808010_g_RingId_Mapping[i] do
		 		if LuaFnGetItemCount(sceneId, selfId, subTab) >= 1 then
		 			return 0, "#{YHJZ_081007_10}";
		 		end
	 		end
	 	end
	 	--ÓÐ10Òø£¿
	 	if GetMoney(sceneId, selfId) < x808010_g_Price then
	 		return 0, "#{YHJZ_081007_11}";
	 	end
	 	--±³°üµÀ¾ßÀ¸Âú£¿
	 	if LuaFnGetPropertyBagSpace(sceneId, selfId) < 1 then
	 		return 0, "#{YHJZ_081007_12}"
	 	end
	 	--¼ì²âÍ¨¹ý
	 	return 1, "ok";
	elseif type == 2 then  --Éý¼¶
		--·òÆÞ2ÈË×é¶Ó£¿
		local ret, msg = x808010_IsCoupleMakeTeam(sceneId, selfId, 2);
		if ret == 0 then
			return 0, msg;
		end	
	 	--ÓÐ40Ö»Ó©»ð³æ
	 	if LuaFnGetAvailableItemCount(sceneId, selfId, x808010_g_FlashInsect_id) < 40 then
	 		return 0, "#{YHJZ_081007_16}";
	 	end
	 	--´ïµ½30¼¶£¿
	 	if GetLevel(sceneId, selfId) < 30 then
	 		return 0, "#{YHJZ_081007_17}";
	 	end
	 	--×°±¸ÁËÓÀºã×ê½ä£¿
	 	local ringCount = 0;
	 	local ringAvailCount = 0;
	 	local tempRingId = 0;
	 	local tempIndex = 0;
	 	
	 	for i=1, 2 do
	 		for j, Ring_Id in x808010_g_RingId_Mapping[i] do
		 		ringCount = ringCount + LuaFnGetItemCount(sceneId, selfId, Ring_Id);
		 		local num = LuaFnGetAvailableItemCount(sceneId, selfId, Ring_Id);
		 		if num > 0 then
		 			ringAvailCount = ringAvailCount + num;
		 			tempRingId = Ring_Id;
		 			tempIndex = j;
		 		end	 			
	 		end
	 	end

	 	if ringCount < 1 then 							--ÎÞ½äÖ¸
	 		return 0, "#{YHJZ_081007_19}";
	 	end
		if ringAvailCount < ringCount then	--×°±¸ÉÏ or Ëø¶¨ÁË
			return 0, "#{YHJZ_081007_18}";
		end		
	 	--×ê½äÎ¨Ò»£¿
		if ringAvailCount > 1 then
			return 0, "#{YHJZ_081007_20}";
		end
	 	--»»ÈËÁË£¿
	 	local bagPos = GetBagPosByItemSn(sceneId, selfId, tempRingId);
	 	local _, name = LuaFnGetItemCreator(sceneId, selfId, bagPos);
	 	local spouseGuid = LuaFnGetSpouseGUID(sceneId, selfId);
	 	local spouseObjid = LuaFnGuid2ObjId(sceneId, spouseGuid);
	 	local spouseName = GetName(sceneId, spouseObjid);
	 	if name ~= spouseName then
	 		return 0, "#{YHJZ_081007_21}";
	 	end
	 	--ÒÑÓÐ¸ÃµÈ¼¶½äÖ¸£¿
	 	local myLvl = GetLevel(sceneId, selfId);
	 	local index = x808010_GetTblIdx(myLvl);
	 	if tempIndex == index then
	 		local msg = format("#{YHJZ_081007_22}%d#{YHJZ_081007_23}", x808010_g_Level2RingId[index+1].Lvl);
	 		return 0, msg;
	 	end
	 	--±³°üµÀ¾ßÀ¸Âú£¿
	 	if LuaFnGetPropertyBagSpace(sceneId, selfId) < 1 then
	 		return 0, "#{YHJZ_081007_24}";
	 	end
	 	--¼ì²âÍ¨¹ý
	 	return 1, "OK";
	elseif type == 3 then		--×£¸£
		--·òÆÞ×é¶Ó£¿
		local ret, msg = x808010_IsCoupleMakeTeam(sceneId, selfId, 3);
		if ret == 0 then
			return 0, msg;
		end
		--Íæ¼ÒÊÇ·ñÓÐÓÀºã½äÖ¸£¿
		local ret_Ring_id = 0;
		local sum = 0;
		local sumAvail = 0;
		for i=1, 2 do
			for j, Ring_Id in x808010_g_RingId_Mapping[i] do
				sum = sum + GetItemCount(sceneId, selfId, Ring_Id);
				local count = LuaFnGetAvailableItemCount(sceneId, selfId, Ring_Id);
				if count > 0 then
					ret_Ring_id = Ring_Id;
					sumAvail = sumAvail + count;
				end
			end				
		end
		if sum == 0 then
			return 0, "#{YHJZ_081007_29}"
		end
		--Åå´÷ ÉÏËø£¿
		if sum > sumAvail then
			return 0, "#{YHJZ_081007_18}";
		end
		--Î¨Ò»£¿
		if sumAvail > 1 then
			return 0, "#{YHJZ_081007_20}";
		end
		--ÊÇ·ñ×£¸£¹ý£¿
		for i, Ring_Id in x808010_g_RingId_Mapping[2] do
			if ret_Ring_id == Ring_Id then
				return 0, "#{YHJZ_081103_1}";
			end
		end
		--Íæ¼ÒÓÐÕæÐÄÊ¯£¿
		if LuaFnGetAvailableItemCount(sceneId, selfId, x808010_g_TrueLoveStone_id) < 1 then
			return 0, "#{YHJZ_081007_30}";
		end
		--ok
		return 1, ret_Ring_id;
	end
end

--**********************************
--È¡µÃÍæ¼ÒµÈ¼¶¶ÔÓ¦µ½x808010_g_Level2RingIdµÄË÷Òý
--**********************************
function x808010_GetTblIdx( level )
	for i, record in x808010_g_Level2RingId do
		if level >= record["Lvl"] and level < x808010_g_Level2RingId[i+1]["Lvl"] then
			return i;
		end
	end
	return 0;
end

--**********************************
--¼ì²âÊÇ·ñ¿ÉÒÔÌá½»
--**********************************
function x808010_CheckSubmit( sceneId, selfId )
	--·òÆÞ×é¶Ó ÔÚ¸½½ü 
	
	--1.ÊÇ·ñ×é¶Ó
	local teamId = GetTeamId(sceneId,selfId)
	if teamId<0 then
		return 0, "#{YHJZ_081007_27}";
	end	
	--2.ÊÇ·ñÁ©ÈË
	if GetTeamSize(sceneId,selfId)~=2 then
		return 0, "#{YHJZ_081007_27}";
	end	
	--3.ÊÇ·ñÔÚ¸½½ü
	if GetNearTeamCount(sceneId,selfId) ~= 2 then
		return 0, "#{YHJZ_081007_28}";
	end	
	--4.ÊÇ·ñÊÇ·òÆÞ
	local tid1 = GetNearTeamMember(sceneId,selfId,0)
	local tid2 = GetNearTeamMember(sceneId,selfId,1)
	if LuaFnIsMarried(sceneId,selfId)<=0 then
			return 0, "#{YHJZ_081007_27}";
	else
		if LuaFnGetSpouseGUID(sceneId,tid1) ~= LuaFnGetGUID(sceneId,tid2) or LuaFnGetSpouseGUID(sceneId,tid2) ~= LuaFnGetGUID(sceneId,tid1) then
				return 0, "#{YHJZ_081007_27}";
		end
	end	
		
 	local ringCount = 0;
 	local ringAvailCount = 0;
 	local tempRingId = 0;
	
	for i=1, 2 do
	 	for j, Ring_id in x808010_g_RingId_Mapping[i] do
	 		local count = LuaFnGetItemCount(sceneId, selfId, Ring_id);
	 		if count > 0 then
	 			ringCount = ringCount + count;
	 		end
	 		local num = LuaFnGetAvailableItemCount(sceneId, selfId, Ring_id);
	 		if num > 0 then
	 			ringAvailCount = ringAvailCount + num;
	 			tempRingId = Ring_id;
	 		end
	 	end
	end

 	if ringCount < 1 then 							--ÎÞÓÀºã×ê½ä
 		return 0, "#{YHJZ_081007_40}";
 	end
 	if ringCount ~= 1 then 							--×ê½äÎ¨Ò»
 		return 0, "#{YHJZ_081007_20}";
 	end
	if ringAvailCount < ringCount then	--×°±¸ or Ëø¶¨
		return 0, "#{YHJZ_081007_18}";
	end		
 	--»»ÈËÁË£¿
 	local bagPos = GetBagPosByItemSn(sceneId, selfId, tempRingId);
 	local _, name = LuaFnGetItemCreator(sceneId, selfId, bagPos);
 	local spouseGuid = LuaFnGetSpouseGUID(sceneId, selfId);
 	local spouseObjid = LuaFnGuid2ObjId(sceneId, spouseGuid);
 	local spouseName = GetName(sceneId, spouseObjid);
 	if name ~= spouseName then
 		return 0, "#{YHJZ_081007_21}";
 	end
 	return 1, tempRingId;
end

--**********************************
--Ìá½»
--**********************************
function x808010_OnSubmit( sceneId, selfId, targetId, selectRadioId )

end

--**********************************
--È·¶¨Íê³ÉÈÎÎñ
--**********************************
function x808010_ConfirmSubmitMission(sceneId, selfId, targetId)
	local ret, msg = x808010_CheckSubmit(sceneId, selfId);
	if ret == 0 then
		x808010_ReturnDlg(sceneId, selfId, targetId, msg);
		return 		
	end
	local bFlag = 0;
	--×£¸£ ÌáÊ¾
	for i, RingId in x808010_g_RingId_Mapping[2] do
		if msg == RingId then
			bFlag = 1;
		end
	end
	--´ò¿× ¿ÌÃú Ç¿»¯ ÌáÊ¾
	local bagPos = GetBagPosByItemSn(sceneId, selfId, msg);
	if bagPos >= 0 then
		if GetGemEmbededCount(sceneId, selfId, bagPos) > 0 or
				LuaFnIsMarkOrEnhance(sceneId, selfId, bagPos, 1) > 0 or
				LuaFnIsMarkOrEnhance(sceneId, selfId, bagPos, 2) > 0 then
			bFlag = 1;
		end
	end
	
	if bFlag == 1 then
		BeginEvent(sceneId)
			AddText(sceneId, "#{YHJZ_081007_41}");
			AddNumText(sceneId, x808010_g_ScriptId, "#{INTERFACE_XML_557}", 6, 333);
			AddNumText(sceneId, x808010_g_ScriptId, "#{INTERFACE_XML_542}", 6, 444);
		EndEvent()
		DispatchEventList(sceneId, selfId, targetId)	
		return
	end	
	x808010_ConfirmUpgrade(sceneId, selfId, targetId);
end

--**********************************
--·µ»Ø¶Ô»°
--**********************************
function x808010_ReturnDlg(sceneId, selfId, targetId, msg)
	BeginEvent(sceneId)
		AddText(sceneId, msg);
	EndEvent()
	DispatchEventList(sceneId, selfId, targetId)
end

--**********************************
--ReturnTips
--**********************************
function x808010_Tips(sceneId, selfId, msg)
	BeginEvent(sceneId)
		AddText(sceneId, msg);
	EndEvent()
	DispatchMissionTips(sceneId, selfId)
end

--**********************************
--ÁìÈ¡ÓÀºã×ê½ä
--**********************************
function x808010_GetTrueLoveRing(sceneId, selfId, targetId)
	local ret, msg = x808010_CheckAccept(sceneId, selfId, 1) ;
	--¼ì²âÊ§°Ü
	if ret == 0 then
		x808010_ReturnDlg(sceneId, selfId, targetId, msg);
		return 		
	end
	--Í¨¹ý		
	if CostMoney(sceneId, selfId, x808010_g_Price) == -1 then
		return
	end
	--¸øÓè³õ¼¶ÓÀºã½äÖ¸
	local bagPos = TryRecieveItem( sceneId, selfId, x808010_g_Level2RingId[1].RingId, QUALITY_MUST_BE_CHANGE);
	if bagPos == -1 then
		return
	end
	--¿ÌÃû×Ö
	local spouseGuid = LuaFnGetSpouseGUID(sceneId, selfId);
	local spouseObjId = LuaFnGuid2ObjId(sceneId, spouseGuid);
	local spouseName = GetName(sceneId, spouseObjId);
	LuaFnSetItemCreator(sceneId, selfId, bagPos, spouseName);
	--Í³¼Æ
	AuditUpgradeRing(sceneId, selfId, x808010_g_Level2RingId[1].RingId, 1);
 	--ÌáÊ¾ÐÅÏ¢
 	x808010_ReturnDlg(sceneId, selfId, targetId, "#{YHJZ_081007_13}"); 	
 	
end

--**********************************
--È·¶¨Éý¼¶ÓÀºã×ê½ä
--**********************************
function x808010_ConfirmUpgrade(sceneId, selfId, targetId)
	--ÔÙ´ÎÅÐ¶Ï
	local ret, msg = x808010_CheckSubmit(sceneId, selfId); --³É¹¦·µ»Ø1£¬ ½äÖ¸id£» Ê§°Ü·µ»Ø0£¬ ÏûÏ¢
	if ret == 0 then
		x808010_ReturnDlg(sceneId, selfId, targetId, msg);
		return 		
	end	
	--¿Û³ýºùÂ«
	if LuaFnDelAvailableItem(sceneId, selfId, x808010_g_HuLu_id, 1) == 0 then
		return
	end
	--¿Û³ý¾É½äÖ¸
	LuaFnDelAvailableItem(sceneId, selfId, msg, 1);
	--¸ù¾ÝÍæ¼ÒµÈ¼¶¼ÆËã½äÖ¸id	
	local index = x808010_GetTblIdx( GetLevel(sceneId, selfId) )
	if index == 0 then 
		return
	end
	--µÃÐÂ½äÖ¸
	local bagPos = TryRecieveItem( sceneId, selfId, x808010_g_Level2RingId[index]["RingId"], QUALITY_MUST_BE_CHANGE);
	--Ãú¿ÌÃû×Ö
	local spouseGuid = LuaFnGetSpouseGUID(sceneId, selfId);
	local spouseObjId = LuaFnGuid2ObjId(sceneId, spouseGuid);
	local spouseName = GetName(sceneId, spouseObjId);
	LuaFnSetItemCreator(sceneId, selfId, bagPos, spouseName);	
	--É¾³ýÈÎÎñ
  if IsHaveMission(sceneId, selfId, x808010_g_MissionId) == 1 then  	
  	DelMission( sceneId, selfId, x808010_g_MissionId );
  end	
  --Í³¼Æ
  AuditUpgradeRing(sceneId, selfId, x808010_g_Level2RingId[index]["RingId"], 2);
	--·µ»ØÐÅÏ¢
	x808010_ReturnDlg(sceneId, selfId, targetId, "#{YHJZ_081007_42}");
	--tips
	x808010_Tips(sceneId, selfId, "#{YHJZ_081007_43}");
	--²¥·Å¹«¸æ
	local myName = GetName(sceneId, selfId);
	local sTran	= GetBagItemTransfer( sceneId, selfId, bagPos );
	local str = format("#{_INFOUSR%s}#{YHJZ_081007_44}#{_INFOUSR%s}#{YHJZ_081007_45}#{_INFOMSG%s}#{YHJZ_081007_46}", myName, spouseName, sTran);
	AddGlobalCountNews(sceneId, str);
end

--**********************************
--×£¸£×ê½ä
--**********************************
function x808010_BlessRing(sceneId, selfId, targetId)
	local ret, msg = x808010_CheckAccept(sceneId, selfId, 3);
	if ret == 0 then
		x808010_ReturnDlg(sceneId, selfId, targetId, msg);
		return
	end 
	--Í¨¹ý¼ì²â£¬¿ÛÎïÆ·
	if LuaFnDelAvailableItem(sceneId, selfId, msg, 1) == 0 then			--¼ì²é³É¹¦msg·µ»Ø½äÖ¸Id
		x808010_Tips(sceneId, selfId, "Kh¤u tr× Vînh Ho¢ng Toàn Gi¾i th¤t bÕi !");
	  return
	end	
	local stone_pos = GetBagPosByItemSn(sceneId, selfId, x808010_g_TrueLoveStone_id);
	local stone_sTran	= GetBagItemTransfer( sceneId, selfId, stone_pos );
	if LuaFnDelAvailableItem(sceneId, selfId, x808010_g_TrueLoveStone_id, 1) == 0 then
		x808010_Tips(sceneId, selfId, "Kh¤u tr× Chân Tâm ThÕch th¤t bÕi !");
	  return
	end	
	--¸ø×£¸£½äÖ¸
	local index = 0;
	for i, subTab in x808010_g_RingId_Mapping[1] do
		if subTab == msg then
			index = i;
			break;
		end
	end
	if index == 0 then
		return
	end
	local bagPos = TryRecieveItem( sceneId, selfId, x808010_g_RingId_Mapping[2][index], QUALITY_MUST_BE_CHANGE);
	if bagPos == -1 then
		x808010_Tips(sceneId, selfId, "C¥u phúc gi¾i chï th¤t bÕi !");		
		return
	end
	--¿ÌÃû×Ö
	local spouseGuid = LuaFnGetSpouseGUID(sceneId, selfId);
	local spouseObjId = LuaFnGuid2ObjId(sceneId, spouseGuid);
	local spouseName = GetName(sceneId, spouseObjId);
	LuaFnSetItemCreator(sceneId, selfId, bagPos, spouseName);	
	--Í³¼Æ
	AuditUpgradeRing(sceneId, selfId, x808010_g_RingId_Mapping[2][index], 3);	
	x808010_Tips(sceneId, selfId, "Chúc phúc thành công !");

	local blessRing_sTran	= GetBagItemTransfer( sceneId, selfId, bagPos );
	local myName = GetName(sceneId, selfId);
	local msg = format("#{_INFOUSR%s}#{JZSJ_1}#{_INFOMSG%s}#{JZSJ_2}#{_INFOMSG%s}#{JZSJ_3}", myName, stone_sTran, blessRing_sTran);
	AddGlobalCountNews(sceneId, msg);
	--¹Ø±Õ¶Ô»°¿ò	
	BeginUICommand( sceneId )
	UICommand_AddInt( sceneId, targetId )
	EndUICommand( sceneId )
	DispatchUICommand( sceneId, selfId, 1000 )	
end

--**********************************
--Éý¼¶ÓÀºã×ê½ä
--**********************************
function x808010_UpgradeTrueLoveRing(sceneId, selfId, targetId)
 	local ret, msg = x808010_CheckAccept(sceneId, selfId, 2) ;
	--¼ì²âÊ§°Ü
	if ret == 0 then
		x808010_ReturnDlg(sceneId, selfId, targetId, msg);
		return 		
	end	 
	--³¡¾°Ñ¡Ôñ
	local i, j, k = x808010_SelectScene( GetLevel(sceneId, selfId) );
	if i == -1 then
		x808010_ReturnDlg(sceneId, selfId, targetId, "Sai sót !");
		return 		
	end		
	if IsMissionFull(sceneId, selfId) == 1 then
		x808010_ReturnDlg(sceneId, selfId, targetId, "nhi®m vø ðã ð¥y");
		return
	end
	--Ìí¼ÓÈÎÎñ
	AddMission( sceneId,selfId, x808010_g_MissionId, x808010_g_ScriptId, 0, 1, 0 );
	--¼ÇÂ¼³¡¾°
	local misIndex = GetMissionIndexByID(sceneId, selfId, x808010_g_MissionId);
	
	SetMissionByIndex(sceneId, selfId, misIndex, 4, 0);  --¶Áx808010_g_FormatListµÚÒ»ÐÐ
	
	SetMissionByIndex(sceneId, selfId, misIndex, 5, i-1);
	SetMissionByIndex(sceneId, selfId, misIndex, 6, j-1);
	SetMissionByIndex(sceneId, selfId, misIndex, 7, k-1);
	
	--¿ÛÓ©»ð³æ
	LuaFnDelAvailableItem(sceneId, selfId, x808010_g_FlashInsect_id, 40);
	--¸øºùÂ«
	TryRecieveItem( sceneId, selfId, x808010_g_HuLu_id, QUALITY_MUST_BE_CHANGE);
	--·µ»Ø¶Ô»°
	local text = format("#{YHJZ_081007_25}%s,%s,%s", x808010_g_StrList[i], x808010_g_StrList[j], x808010_g_StrList[k]);
	x808010_ReturnDlg(sceneId, selfId, targetId, text);
end

--**********************************
--³¡¾°³éÈ¡
--**********************************
function x808010_SelectScene(level)
	local num = 0;
	for i, subTab in x808010_g_level_num do
		if level >= subTab.min and level <= subTab.max then
			num = subTab.num;
			break;
		end
	end
	local i = 0; 
	local j = 0; 
	local k = 0;
	--Ã»ÕÒµ½µÈ¼¶¶ÔÓ¦µÄ³¡¾°Ô´ÊýÄ¿
	if num == 0 then
		return -1, -1, -1;
	end
	--µÃµ½µÚÒ»¸ö³¡¾°
	local temp = mod( floor(random(100000)), num )+1;
	i = temp;
	--µÃµ½µÚ¶þ¸ö³¡¾°
	while 1 do
		temp =  mod( floor(random(100000)), num )+1;
		if temp ~= i then
			j = temp;
			break;
		end
	end
	--µÃµ½µÚÈý¸ö³¡¾°
	while 1 do
		temp =  mod( floor(random(100000)), num )+1;
		if temp ~= i and temp ~= j then
			k = temp;
			break;
		end
	end	
	return i, j, k;
end

--**********************************
--µã»÷ÓÀºã×ê½ä
--**********************************
function x808010_OnClickTrueLoveRing(sceneId, selfId, targetId)
	if IsHaveMission(sceneId, selfId, x808010_g_MissionId) == 1 then
		local misIndex = GetMissionIndexByID(sceneId, selfId, x808010_g_MissionId);
		if GetMissionParam(sceneId, selfId, misIndex, 0) == 0 then
			x808010_ReturnDlg(sceneId, selfId, targetId, "#{YHJZ_081007_36}");
			return 
		else
			BeginEvent(sceneId)
				AddText(sceneId, "#{YHJZ_081007_37}")
				AddNumText(sceneId, x808010_g_ScriptId, "#{YHJZ_081007_38}", 6, 111);	--ÊÇµÄ
				AddNumText(sceneId, x808010_g_ScriptId, "#{YHJZ_081007_39}", 6, 222); --»¹Ã»×¼±¸ºÃ¡£¡£¡£
			EndEvent()
			DispatchEventList(sceneId, selfId, targetId);
			return
		end
	else
		x808010_ListOption(sceneId, selfId, targetId);
	end
end

--**********************************
--·ÅÆú
--**********************************
function x808010_OnAbandon( sceneId, selfId )
  if IsHaveMission(sceneId, selfId, x808010_g_MissionId) == 1 then  	
  	--¿Û³ýÔÂÀÏºùÂ«
  	local num = LuaFnGetItemCount(sceneId, selfId, x808010_g_HuLu_id);
  	local availNum = LuaFnGetAvailableItemCount(sceneId, selfId, x808010_g_HuLu_id)
  	if availNum < num then
  		x808010_Tips(sceneId, selfId, "Hãy m· khoá v§t ph¦m m¾i có th¬ hoán ð±i")
  		return
  	end
  	if availNum > 0 then
  		LuaFnDelAvailableItem(sceneId, selfId, x808010_g_HuLu_id, availNum);
  	end
  	--É¾³ýÈÎÎñ
  	DelMission( sceneId, selfId, x808010_g_MissionId );
  end
end

--**********************************
--É±ËÀ¹ÖÎï»òÍæ¼Ò
--**********************************
function x808010_OnKillObject( sceneId, selfId, objdataId )
end

--**********************************
--½øÈëÇøÓòÊÂ¼þ
--**********************************
function x808010_OnEnterArea( sceneId, selfId, zoneId )
	
	if IsHaveMission( sceneId, selfId, x808010_g_MissionId ) <= 0 then
		return 0;
	end
	local misIndex = GetMissionIndexByID(sceneId,selfId,x808010_g_MissionId)	
	local order = {};
	order[1] = GetMissionParam(sceneId, selfId, misIndex, 5)+1;
	order[2] = GetMissionParam(sceneId, selfId, misIndex, 6)+1;
	order[3] = GetMissionParam(sceneId, selfId, misIndex, 7)+1;
	local bCompleted = GetMissionParam(sceneId, selfId, misIndex, 0);
	local place1 = GetMissionParam(sceneId, selfId, misIndex, 2); --2,3²ÎÊýÓÃÓÚ¼ÇÂ¼ÊÕ¼¯¹ýÏÉÆøµÄ³¡¾°ºÅ
	local place2 = GetMissionParam(sceneId, selfId, misIndex, 3);
	local bFlag = 0;	
	for i=1, 3 do
		if sceneId == x808010_g_select_sceneId[order[i]][1] and zoneId == x808010_g_select_sceneId[order[i]][5] 
			 and place1 ~= sceneId and place2 ~= sceneId and bCompleted ~= 1 then
			bFlag = order[i];
		end		
	end	
	if bFlag == 0 then	
		return 0;
	end	
	local nposX = random(3)
	local nposY = random(3)
	CreateSpecialObjByDataIndex(sceneId, selfId, 67, x808010_g_select_sceneId[bFlag][3]+nposX, x808010_g_select_sceneId[bFlag][4]+nposY, 0)
end

--**********************************
--µÀ¾ß¸Ä±ä
--**********************************
function x808010_OnItemChanged( sceneId, selfId, itemdataId )
end

--**********************************
--½ÓÊÜ
--**********************************
function x808010_OnAccept( sceneId, selfId )
	--¼ÓÈëÈÎÎñµ½Íæ¼ÒÁÐ±í
	AddMission( sceneId,selfId, x808010_g_MissionId, x808010_g_ScriptId, 0, 0, 0 )
end

--**********************************
--¼ÌÐø
--**********************************
function x808010_OnContinue( sceneId, selfId, targetId )

end


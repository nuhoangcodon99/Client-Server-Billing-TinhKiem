
--ÃÅÅÉÒýµ¼ÈÎÎñ

--½Å±¾ºÅ

----------------
--MisDescBegin
--½Å±¾ºÅ
x600045_g_ScriptId	= 600045

--½ÓÊÜÈÎÎñNPCÊôÐÔ
x600045_g_Position_X=133
x600045_g_Position_Z=50

x600045_g_AccomplishNPC_Name="Võ ÐÕi Uy "

--ÈÎÎñºÅ
x600045_g_MissionId			= 1121

--ÈÎÎñÄ¿±ênpc
x600045_g_Name 					= "Võ ÐÕi Uy "
--ÈÎÎñ¹éÀà
x600045_g_MissionKind			= 50 --Íæ¼Ò³ÇÊÐ
--ÈÎÎñµÈ¼¶
x600045_g_MissionLevel		= 10000
--ÊÇ·ñÊÇ¾«Ó¢ÈÎÎñ
x600045_g_IfMissionElite	= 0
--ÈÎÎñÊÇ·ñÒÑ¾­Íê³É
x600045_g_IsMissionOkFail	= 0		--ÈÎÎñ²ÎÊýµÄµÚ0Î»

--ÈÎÎñÎÄ±¾ÃèÊö
x600045_g_MissionName			= "Dò thám tin tÑc"
--ÈÎÎñÃèÊö
x600045_g_MissionInfo			= "Tình báo nhi®m vø, sØ døng sách thông tin tình báo ð¬ dò tìm tin tÑc trong Bang hµi"
--ÈÎÎñÄ¿±ê
x600045_g_MissionTarget		= "    Thu th§p tin tÑc sau ðó ðªn g£p #GVõ ÐÕi Uy#B[133,50]#W ð¬ nh§n giäi thß·ng."
--Î´Íê³ÉÈÎÎñµÄnpc¶Ô»°
x600045_g_ContinueInfo		= "Các hÕ chßa hoàn thành nhi®m  vø à ?"
--Íê³ÉÈÎÎñnpcËµµÄ»°
x600045_g_MissionComplete	= "Làm t¯t l¡m, cám ½n các hÕ ðã giúp cho Bang Hµi !"

--ÈÎÎñÊÇ·ñÍê³É
--x600045_g_Mission_IsComplete = 0		--ÈÎÎñ²ÎÊýµÄµÚ0Î»
--´òÌ½µÚ¼¸¸ö³ÇÊÐ
x600045_g_city 				 	= 1		 --ÈÎÎñ²ÎÊýµÄµÚ1Î»

-- ÈÎÎñÍê³ÉÇé¿ö,ÄÚÈÝ¶¯Ì¬Ë¢ÐÂ,Õ¼ÓÃÈÎÎñ²ÎÊýµÄµÚ1Î»

x600045_g_Custom	= { {id="Do thám thành ph¯",num=3} }
--MisDescEnd
----------------

x600045_g_SpyBook_id = 40004461;
x600045_g_ExpPrize = {}
x600045_g_ExpPrize[1] =
{
2510,2651,2789,2927,3070,3210,3351,3497,3640,3788,
7710,8050,8402,8756,9112,9461,9822,10184,10549,10906,
18165,18763,19364,19953,20560,21172,21786,22389,23010,23635,
35387,36307,37217,38147,39082,40007,40952,41902,42841,43801,
44766,45719,46694,47674,48659,49632,50627,51627,52615,53624,
54639,55641,56666,57695,58713,59752,60796,61828,62883,63942,
65006,66058,67132,68211,69277,70366,71460,72541,73644,74753,
75849,76968,78091,79220,80335,81474,82617,83747,84900,86059,
87204,88372,89545,90704,91887,93075,94250,95448,96650,97858,
97858,97858,97858,97858,97858,97858,97858,97858,97858,97858,
97858,97858,97858,97858,97858,97858,97858,97858,97858,97858,
}
x600045_g_ExpPrize[2] =
{
2510,2651,2789,2927,3070,3210,3351,3497,3640,3788,
7710,8050,8402,8756,9112,9461,9822,10184,10549,10906,
18165,18763,19364,19953,20560,21172,21786,22389,23010,23635,
35387,36307,37217,38147,39082,40007,40952,41902,42841,43801,
44766,45719,46694,47674,48659,49632,50627,51627,52615,53624,
54639,55641,56666,57695,58713,59752,60796,61828,62883,63942,
65006,66058,67132,68211,69277,70366,71460,72541,73644,74753,
75849,76968,78091,79220,80335,81474,82617,83747,84900,86059,
87204,88372,89545,90704,91887,93075,94250,95448,96650,97858,
97858,97858,97858,97858,97858,97858,97858,97858,97858,97858,
97858,97858,97858,97858,97858,97858,97858,97858,97858,97858,
}
x600045_g_ExpPrize[3] =
{
2510,2651,2789,2927,3070,3210,3351,3497,3640,3788,
7710,8050,8402,8756,9112,9461,9822,10184,10549,10906,
18165,18763,19364,19953,20560,21172,21786,22389,23010,23635,
35387,36307,37217,38147,39082,40007,40952,41902,42841,43801,
44766,45719,46694,47674,48659,49632,50627,51627,52615,53624,
54639,55641,56666,57695,58713,59752,60796,61828,62883,63942,
65006,66058,67132,68211,69277,70366,71460,72541,73644,74753,
75849,76968,78091,79220,80335,81474,82617,83747,84900,86059,
87204,88372,89545,90704,91887,93075,94250,95448,96650,97858,
97858,97858,97858,97858,97858,97858,97858,97858,97858,97858,
97858,97858,97858,97858,97858,97858,97858,97858,97858,97858,
}

x600045_g_ExpPrize[4] =
{
2510,2651,2789,2927,3070,3210,3351,3497,3640,3788,
7710,8050,8402,8756,9112,9461,9822,10184,10549,10906,
18165,18763,19364,19953,20560,21172,21786,22389,23010,23635,
35387,36307,37217,38147,39082,40007,40952,41902,42841,43801,
44766,45719,46694,47674,48659,49632,50627,51627,52615,53624,
54639,55641,56666,57695,58713,59752,60796,61828,62883,63942,
65006,66058,67132,68211,69277,70366,71460,72541,73644,74753,
75849,76968,78091,79220,80335,81474,82617,83747,84900,86059,
87204,88372,89545,90704,91887,93075,94250,95448,96650,97858,
97858,97858,97858,97858,97858,97858,97858,97858,97858,97858,
97858,97858,97858,97858,97858,97858,97858,97858,97858,97858,
}
x600045_g_ExpPrize[5] =
{
2510,2651,2789,2927,3070,3210,3351,3497,3640,3788,
7710,8050,8402,8756,9112,9461,9822,10184,10549,10906,
18165,18763,19364,19953,20560,21172,21786,22389,23010,23635,
35387,36307,37217,38147,39082,40007,40952,41902,42841,43801,
44766,45719,46694,47674,48659,49632,50627,51627,52615,53624,
54639,55641,56666,57695,58713,59752,60796,61828,62883,63942,
65006,66058,67132,68211,69277,70366,71460,72541,73644,74753,
75849,76968,78091,79220,80335,81474,82617,83747,84900,86059,
87204,88372,89545,90704,91887,93075,94250,95448,96650,97858,
97858,97858,97858,97858,97858,97858,97858,97858,97858,97858,
97858,97858,97858,97858,97858,97858,97858,97858,97858,97858,
}

--**********************************
--ÈÎÎñÈë¿Úº¯Êý
--**********************************
function x600045_OnDefaultEvent( sceneId, selfId, targetId )
	local id = GetNumText();
	local msg = "";
	if id == 1 then
		BeginEvent(sceneId)
			msg = "#{DTGX_080822_1}";
			AddText(sceneId, msg);
		EndEvent()
		AddNumText(sceneId, x600045_g_ScriptId, "Nh§n nhi®m vø do thám", 6, 3);
		AddNumText(sceneId, x600045_g_ScriptId, "Nh§n ph¥n thß·ng hoàn thành nhi®m vø", 6, 4);
		AddNumText(sceneId, x600045_g_ScriptId, "Gi¾i thi®u nhi®m vø do thám", 11, 2);
		DispatchEventList(sceneId,selfId,targetId);		
	elseif id == 2 then  																									--´òÌ½ÈÎÎñ°ïÖú
		BeginEvent(sceneId)
			AddText(sceneId, "#{DTGX_080822_7}");
		EndEvent()
		DispatchEventList(sceneId, selfId, targetId);
	elseif id == 3 then																										--ÁìÈ¡´òÌ½ÈÎÎñ
		-- ´ïµ½30¼¶£¿
		if GetLevel(sceneId, selfId) < 30 then
			x600045_MessageBox(sceneId, selfId, targetId, "Xin l²i, các hÕ ðÕt c¤p 30 m¾i có th¬ nh§n nhi®m vø !");
			return					
		end
		-- Íê³ÉÁË5´Î£¿
		local ymd = GetTime2Day();
		local dayCount = 0;			
		dayCount = GetMissionData(sceneId, selfId, MD_SPY_DAYCOUNT);
		if mod(dayCount, 10) >= 5 and ymd == floor(dayCount/10) then
			x600045_MessageBox(sceneId, selfId, targetId, "#{DTGX_080822_3}");
			return									
		end
		-- ÒÑÓÐÈÎÎñ£¿
		if IsHaveMission(sceneId, selfId, x600045_g_MissionId) > 0 then
			x600045_MessageBox(sceneId, selfId, targetId, "#{DTGX_080822_4}");
			return				
		end
		-- µÀ¾ßÀ¸Âú£¿	
		if LuaFnGetTaskItemBagSpace(sceneId, selfId) < 1 then
			x600045_MessageBox(sceneId, selfId, targetId, "#{DTGX_080822_5}");
			return				
		end
		-- Ìí¼ÓÈÎÎñ
		local ret = AddMission( sceneId, selfId, x600045_g_MissionId, x600045_g_ScriptId, 0, 0, 0 ); --Ìí¼ÓÈÎÎñ
		if ret < 1 then
			return
		end
		-- Ìõ¼þÂú×ã£¬¸øÇé±¨²¾
		local ret = TryRecieveItem( sceneId, selfId, x600045_g_SpyBook_id, QUALITY_MUST_BE_CHANGE);
		if ret == -1 then
			return  -- ¸øµÀ¾ßÊ§°Ü	
		end		
		--MD_SPY_DAYCOUNT ¸öÎ»±£´æÒ»Ìì²ÎÓë´ÎÊý£¬ÆäÓàÎ»Êý±£´æÈÕÆÚ£¬Èç£º20080416´ú±í2008Äê4ÔÂ16ÈÕ
		local dayCount = GetMissionData(sceneId, selfId, MD_SPY_DAYCOUNT); 
		if floor(dayCount/10) ~= ymd then
			dayCount = 10 * ymd;
		end
		SetMissionData(sceneId, selfId, MD_SPY_DAYCOUNT, dayCount+1);  -- ±£´æ´ÎÊý
		-- ÈÕÖ¾
		AuditCitySpy(sceneId, selfId, 0);
		-- ¸øÐÅÏ¢
		BeginEvent(sceneId)
			AddText(sceneId, " #{DTGX_080822_6}");
		EndEvent()
		DispatchEventList(sceneId, selfId, targetId);
		
	elseif id == 4 then  								--ÁìÈ¡Íê³É½±Àø
		--ÁìÈ¡ÈÎÎñÁË£¿
		if IsHaveMission(sceneId, selfId, x600045_g_MissionId) == 0 then
			x600045_MessageBox(sceneId, selfId, targetId, "#{DTGX_080825_01}");
			return			
		end
		--ÈÎÎñÍê³É£¿
		local misIndex = GetMissionIndexByID(sceneId, selfId, x600045_g_MissionId);
		if misIndex > 10000 then			
			return
		end
		if GetMissionParam(sceneId, selfId, misIndex, 1) < 3 then
			x600045_MessageBox(sceneId, selfId, targetId, "#{DTGX_080822_17}");
			return
		end
		--¿Û³ýÇé±¨²¾
		local ret = LuaFnDelAvailableItem(sceneId, selfId, x600045_g_SpyBook_id, 1);
		if ret == 0 then
			msg = "C¥n m· khoá cu¯n sách tình báo. Các hÕ ðã khoá nó ?";
			x600045_MessageBox(sceneId, selfId, targetId, msg);
			return		
		end		
		--¸ø2µã°ï¹±
		CityChangeAttr( sceneId, selfId, GUILD_CONTRIB_POINT, 2 )
		local dayCount = GetMissionData(sceneId, selfId, MD_SPY_DAYCOUNT);
		local level = GetLevel(sceneId, selfId);
		local idx = mod(dayCount, 10);
		--¸ø¾­Ñé½±Àø
		local expPrize = x600045_g_ExpPrize[idx][level-9]
		LuaFnAddExp(sceneId, selfId, expPrize);
		--ÉèÖÃÈÎÎñÍê³ÉÐÅÏ¢
		DelMission(sceneId, selfId, x600045_g_MissionId);
		-- ÈÕÖ¾
		AuditCitySpy(sceneId, selfId, 1);
		--·µ»ØÐÅÏ¢
		msg = format("Nh§n ðßþc 2 ði¬m c¯ng hiªn Bang hµi");
		x600045_Tips(sceneId, selfId, msg);	
		local playerName = GetName(sceneId, selfId);
		msg = format("#{DTGX_080822_20}#{_INFOUSR%s}#{DTGX_080822_21}", playerName);
		BroadMsgByChatPipe(sceneId, selfId, msg, 6); --°ïÅÉÏûÏ¢
	end
end

--**********************************
--ÁÐ¾ÙÊÂ¼þ
--**********************************
function x600045_OnEnumerate( sceneId, selfId, targetId )

	--ÅÐ¶Ï¸ÃnpcÊÇ·ñÊÇ¶ÔÓ¦ÈÎÎñµÄnpc
	if LuaFnGetName( sceneId, targetId ) ~= x600045_g_Name then
		return 0;
	end
	AddNumText( sceneId, x600045_g_ScriptId, "#GNh§n nhi®m vø do thám", 1, 1 );
	AddNumText( sceneId, x600045_g_ScriptId, "Gi¾i thi®u nhi®m vø do thám", 11, 2 );
end

--**********************************
--¼ì²â½ÓÊÜÌõ¼þ£¬Ò²¹©×ÓÈÎÎñµ÷ÓÃ
--**********************************
function x600045_CheckAccept( sceneId, selfId, targetId )
end
--**********************************
--¼ì²âÊÇ·ñ¿ÉÒÔÌá½»
--**********************************
function x600045_CheckSubmit( sceneId, selfId, targetId )
end

--**********************************
--¼ÌÐø
--**********************************
function x600045_OnContinue( sceneId, selfId, targetId )
end

--**********************************
--½ÓÊÜ£¬½ö¹©×ÓÈÎÎñµ÷ÓÃÉèÖÃ¹«¹²²ÎÊý
--**********************************
function x600045_OnAccept( sceneId, selfId, targetId, scriptId )
end

--**********************************
--·ÅÆú£¬½ö¹©×ÓÈÎÎñµ÷ÓÃ
--**********************************
function x600045_OnAbandon( sceneId, selfId )
	local itemNum = LuaFnGetAvailableItemCount(sceneId, selfId, x600045_g_SpyBook_id);
	if itemNum >= 1 then
		LuaFnDelAvailableItem( sceneId, selfId, x600045_g_SpyBook_id, itemNum );
	end
  if IsHaveMission( sceneId, selfId, x600045_g_MissionId ) > 0 then
	 	DelMission( sceneId, selfId, x600045_g_MissionId )
	end	
	return 0
end

--**********************************
--Ìá½»£¬½ö¹©×ÓÈÎÎñµ÷ÓÃ
--**********************************
function x600045_OnSubmit( sceneId, selfId, targetId, selectRadioId )
end

--**********************************
--¿òÏÔÊ¾
--**********************************
function x600045_MessageBox( sceneId, selfId, targetId, msg )
	BeginEvent(sceneId)
		AddText(sceneId, msg);
	EndEvent()
	DispatchEventList(sceneId, selfId, targetId);
end

--**********************************
--TipÏÔÊ¾
--**********************************
function x600045_Tips(sceneId, selfId, msg)
	BeginEvent(sceneId)
		AddText(sceneId, msg);
	EndEvent()
	DispatchMissionTips(sceneId, selfId);
end

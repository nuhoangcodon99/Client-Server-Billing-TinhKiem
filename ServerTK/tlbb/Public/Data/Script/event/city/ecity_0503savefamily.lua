--∏±±æ»ŒŒÒ
--æ»‘Æ√≈≈…¥Ûƒ—

--************************************************************************
--MisDescBegin

--Ω≈±æ∫≈
x600026_g_ScriptId = 600026

--»ŒŒÒ∫≈
x600026_g_MissionId = 1110

--ƒø±ÍNPC
x600026_g_Name = "–Ùng Ph˘ Dung "

--»ŒŒÒµ»º∂
x600026_g_MissionLevel = 10000

--»ŒŒÒπÈ¿‡
x600026_g_MissionKind = 50

-- «∑Ò «æ´”¢»ŒŒÒ
x600026_g_IfMissionElite = 0

--********œ¬√Êº∏œÓ «∂ØÃ¨œ‘ æµƒƒ⁄»›£¨”√”⁄‘⁄»ŒŒÒ¡–±Ì÷–∂ØÃ¨œ‘ æ»ŒŒÒ«Èøˆ******
--Ω«…´Mission±‰¡øÀµ√˜

x600026_g_IsMissionOkFail			=0	--0 »ŒŒÒÕÍ≥…±Íº«
x600026_g_MissionParam_SubId		=1	--1 ◊”»ŒŒÒΩ≈±æ∫≈¥Ê∑≈Œª÷√
x600026_g_Param_sceneid				=2	--2 µ±«∞∏±±æ»ŒŒÒµƒ≥°æ∞∫≈
x600026_g_MissionParam_Phase		=3	--3 Ω◊∂Œ∫≈ ¥À∫≈”√”⁄«¯∑÷µ±«∞»ŒŒÒUIµƒ√Ë ˆ–≈œ¢
x600026_g_MissionParam_MasterId		=4	--4 √≈≈…’∆√≈µƒNPCId∫≈
x600026_g_MissionParam_MenpaiIndex	=5	--5 ƒ≥√≈≈…µƒÀ˜“˝£¨∑÷±”√”⁄≤È’“◊÷∑˚¥Æ¡–±Ì÷–ƒ≥√≈≈…µƒ√˚≥∆[øÕªß∂À]“‘º∞»ŒŒÒ”Î√≈≈…œ‡πÿµƒ–≈œ¢[∑˛ŒÒ∆˜∂À]

--—≠ª∑»ŒŒÒµƒ ˝æ›À˜“˝£¨¿Ô√Ê¥Ê◊≈“—◊ˆµƒª∑ ˝
x600026_g_MissionRound = 55
--**********************************“‘…œ «∂ØÃ¨****************************

--»ŒŒÒŒƒ±æ√Ë ˆ
x600026_g_MissionName = "NhiÆm v¯ khu™ch trﬂΩng"
x600026_g_MissionInfo = ""													--»ŒŒÒ√Ë ˆ
x600026_g_MissionTarget = "%f"												--»ŒŒÒƒø±Í
x600026_g_ContinueInfo = "    NhiÆm v¯ c¸a c·c h’ vÁn chﬂa ho‡n th‡nh ‡?"						--Œ¥ÕÍ≥…»ŒŒÒµƒnpc∂‘ª∞
x600026_g_SubmitInfo = "    SÒ tÏnh ti™n tri¨n nhﬂ th™ n‡o r∞i?"								--ÕÍ≥…Œ¥Ã·Ωª ±µƒnpc∂‘ª∞
x600026_g_MissionComplete = "    R§t tØt, L•n h‡nh µng giang h∞ n‡y ai ai c˚ng bi™t, khÙng h± danh bang ta ’i —c ’i nghÓa. "	--ÕÍ≥…»ŒŒÒnpcÀµª∞µƒª∞

x600026_g_StrForePart = 3

--”√¿¥±£¥Ê◊÷∑˚¥Æ∏Ò ΩªØµƒ ˝æ›
x600026_g_FormatList = {
	"",
	"    TÏm %1n ¨ c—u viÆn cho ’i n’n c¸a mÙn ph·i n‡y",
	"    Hµ tØng %2s Æ tÿ ra khˆi khu c§m ∏a",
}

x600026_g_StrList = {
	[0] = "Thi™u L‚m",
	[1] = "Minh Gi·o",
	[2] = "C·i Bang",
	[3] = "Vı –ang",
	[4] = "Nga My",
	[5] = "ThiÍn Long TÒ ",
	[6] = "Tinh T˙c",
	[7] = "ThiÍn SΩn",
	[8] = "TiÍu Dao",
}

x600026_g_MenpaiInfo = {
	[0] = { Name = "Thi™u L‚m",		NpcId = 1700008,	CopySceneName = "Th·p L‚m",		Type = FUBEN_TALIN1,		    Map = "tongrenxiang_2.nav",		Exit = "tongrenxiang_2_area.ini",	Monster = "tongrenxiang_2_monster_%d.ini", 	EntrancePos = { x = 28, z = 52 },	BackPos = { x = 38, z = 97 }, },
	[1] = { Name = "Minh Gi·o",		NpcId = 1700009,	CopySceneName = "Quang Minh µng",	Type = FUBEN_GUANGMINGDONG1,	Map = "guangmingdong_2.nav",	Exit = "guangmingdong_2_area.ini",	Monster = "guangmingdong_2_monster_%d.ini", EntrancePos = { x = 19, z = 42 },	BackPos = { x = 97, z = 55 }, },
	[2] = { Name = "C·i Bang",		NpcId = 1700010,	CopySceneName = "H•m rﬂ˛u",		Type = FUBEN_JIUJIAO1,			Map = "jiujiao_2.nav",			Exit = "jiujiao_2_area.ini",		Monster = "jiujiao_2_monster_%d.ini", 		EntrancePos = { x = 45, z = 47 },	BackPos = { x = 91, z = 99 }, },
	[3] = { Name = "Vı –ang",		NpcId = 1700011,	CopySceneName = "Linh TÌnh Phong",	Type = FUBEN_LINGXINGFENG1,		Map = "lingxingfeng_2.nav",		Exit = "lingxingfeng_2_area.ini",	Monster = "lingxingfeng_2_monster_%d.ini", 	EntrancePos = { x = 42, z = 46 },	BackPos = { x = 77, z = 86 }, },
	[4] = { Name = "Nga My",		NpcId = 1700012,	CopySceneName = "–‡o Hoa Trßn",	Type = FUBEN_TAOHUAZHEN1,		Map = "taohuazhen_2.nav",		Exit = "taohuazhen_2_area.ini",		Monster = "taohuazhen_2_monster_%d.ini", 	EntrancePos = { x = 26, z = 46 },	BackPos = { x = 96, z = 73 }, },
	[5] = { Name = "ThiÍn Long TÒ ",	NpcId = 1700013,	CopySceneName = "Ch‚n th·p",		Type = FUBEN_TADI1,				Map = "tadi_2.nav",				Exit = "tadi_2_area.ini",			Monster = "tadi_2_monster_%d.ini", 			EntrancePos = { x = 45, z = 48 },	BackPos = { x = 96, z = 67 }, },
	[6] = { Name = "Tinh T˙c",		NpcId = 1700014,	CopySceneName = "Ng˚ Th•n –µng",	Type = FUBEN_WUSHENDONG1,		Map = "wushendong_2.nav",		Exit = "wushendong_2_area.ini",		Monster = "wushendong_2_monster_%d.ini", 	EntrancePos = { x = 14, z = 40 },	BackPos = { x = 142, z = 56 }, },
	[7] = { Name = "ThiÍn SΩn",		NpcId = 1700015,	CopySceneName = "Chi™t Mai Phong",	Type = FUBEN_ZHEMEIFENG1,		Map = "zhemeifeng_2.nav",		Exit = "zhemeifeng_2_area.ini",		Monster = "zhemeifeng_2_monster_%d.ini", 	EntrancePos = { x = 29, z = 49 },	BackPos = { x = 90, z = 45 }, },
	[8] = { Name = "TiÍu Dao",		NpcId = 1700016,	CopySceneName = "CØc ∏a",		Type = FUBEN_GUDI1,				Map = "gudi_2.nav",				Exit = "gudi_2_area.ini",			Monster = "gudi_2_monster_%d.ini", 			EntrancePos = { x = 42, z = 47 },	BackPos = { x = 124, z = 145 }, },
}

-- Õ®”√≥« –»ŒŒÒΩ≈±æ
x600026_g_CityMissionScript = 600001
x600026_g_ExpandScript = 600023

--»ŒŒÒΩ±¿¯

--MisDescEnd
--************************************************************************


x600026_g_TickTime = 5					--ªÿµ˜Ω≈±æµƒ ±÷” ±º‰£®µ•Œª£∫√Î/¥Œ£©
x600026_g_CloseTick = 3					--∏±±æπÿ±’«∞µπº∆ ±£®µ•Œª£∫¥Œ ˝£©
x600026_g_NoUserTime = 120				--∏±±æ÷–√ª”–»À∫Ûø…“‘ºÃ–¯±£¥Êµƒ ±º‰£®µ•Œª£∫√Î£©

x600026_g_ProtegeGroup = 2				-- ±ªª§ÀÕµƒ NPC Group
x600026_g_PatrolId = 0					-- NPC —≤¬ﬂ¬∑æ∂

--**********************************
--»ŒŒÒ»Îø⁄∫Ø ˝
--**********************************
function x600026_OnDefaultEvent( sceneId, selfId, targetId )
--	if GetName( sceneId, targetId ) ~= x600026_g_Name then		--≈–∂œ∏√npc «∑Ò «∂‘”¶»ŒŒÒµƒnpc
--		return
--	end

	--»Áπ˚“—Ω”¥À»ŒŒÒ
	if IsHaveMission( sceneId, selfId, x600026_g_MissionId ) > 0 then
		local bDone = x600026_CheckSubmit( sceneId, selfId )
		local strText

		if bDone == 1 then
			strText = x600026_g_SubmitInfo
		else
			strText = x600026_g_ContinueInfo
		end

		local misIndex = GetMissionIndexByID( sceneId, selfId, x600026_g_MissionId )

		if bDone == 0 and GetMissionParam( sceneId, selfId, misIndex, x600026_g_IsMissionOkFail ) ~= 2 then		--»ŒŒÒŒ¥ÕÍ≥…
			if GetNumText() == 1 then	-- ’‚¿Ô «µ„ª˜√≈≈…’∆√≈
				x600026_AcceptEnterCopyScene( sceneId, selfId )
				return

--				BeginEvent( sceneId )
--					AddText( sceneId, x600026_g_MissionName )
--					AskEnterCopyScene( sceneId, selfId )
--				EndEvent( )
--				DispatchEventList( sceneId, selfId, targetId )
			end

			if GetNumText() == 2 then	-- ’‚¿Ô «µ„ª˜±ªæ»‘Æµ‹◊”
				x600026_StartPatrol( sceneId, selfId, targetId )
				return
			end
		end

		BeginEvent( sceneId )
			AddText( sceneId, x600026_g_MissionName )
			AddText( sceneId, strText )
		EndEvent( )
		DispatchMissionDemandInfo( sceneId, selfId, targetId, x600026_g_ScriptId, x600026_g_MissionId, bDone )

	--¬˙◊„»ŒŒÒΩ” ’Ãıº˛
	elseif x600026_CheckAccept( sceneId, selfId ) > 0 then
		local nTemp = CallScriptFunction( x600026_g_CityMissionScript, "CanDoMisToDay", sceneId, selfId )
		if nTemp == 1   then
			x600026_OnAccept( sceneId, selfId, targetId )
		end
	end
end

--**********************************
--¡–æŸ ¬º˛
--**********************************
function x600026_OnEnumerate( sceneId, selfId, targetId )
	if GetName( sceneId, targetId ) ~= x600026_g_Name then		--≈–∂œ∏√npc «∑Ò «∂‘”¶»ŒŒÒµƒnpc
		return
	end

   --»Áπ˚“—Ω”¥À»ŒŒÒ
	if IsHaveMission( sceneId, selfId, x600026_g_MissionId ) > 0 then
		AddNumText( sceneId, x600026_g_ScriptId, x600026_g_MissionName,3,-1 )
	end
end

--**********************************
--ºÏ≤‚Ω” ‹Ãıº˛
--**********************************
function x600026_CheckAccept( sceneId, selfId )
	local ret = CallScriptFunction( x600026_g_ExpandScript, "CheckAccept", sceneId, selfId )
	return ret
end

--**********************************
--Ω” ‹
--**********************************
function x600026_OnAccept( sceneId, selfId, targetId )
	if IsHaveMission( sceneId, selfId, x600026_g_MissionId ) == 0 then					--√ª”–»ŒŒÒ≤≈ø…“‘◊ﬂ’‚¿Ô
		if GetLevel( sceneId, selfId ) < 40 then
			CallScriptFunction( x600026_g_CityMissionScript, "NotifyFailTips", sceneId, selfId, "KhÙng ¸ ∆ng c§p" )
			return
		end

		--º”»Î»ŒŒÒµΩÕÊº“¡–±Ì
		AddMission( sceneId, selfId, x600026_g_MissionId, x600026_g_ScriptId, 0, 0, 0 )	-- kill°¢area°¢item
		if IsHaveMission( sceneId, selfId, x600026_g_MissionId ) <= 0 then
			return
		end

		SetMissionEvent( sceneId, selfId, x600026_g_MissionId, 4 ) -- ◊¢≤· x600026_OnLockedTarget  ¬º˛
		CallScriptFunction( x600026_g_ExpandScript, "OnAccept", sceneId, selfId, targetId, x600026_g_ScriptId )
		local misIndex = GetMissionIndexByID( sceneId, selfId, x600026_g_MissionId )

		-- ÀÊª˙“ª∏ˆ√≈≈…
		local MenpaiIndex = random( 0, getn(x600026_g_MenpaiInfo) )
		local MenpaiInfo = x600026_g_MenpaiInfo[MenpaiIndex]
		if not MenpaiInfo then
			x600026_NotifyFailTips( sceneId, selfId, "Sai sÛt nghiÍm tr˜ng!" )
			return
		end

		SetMissionByIndex( sceneId, selfId, misIndex, x600026_g_MissionParam_Phase, 1 )
		SetMissionByIndex( sceneId, selfId, misIndex, x600026_g_MissionParam_MasterId, MenpaiInfo.NpcId )
		SetMissionByIndex( sceneId, selfId, misIndex, x600026_g_MissionParam_MenpaiIndex, MenpaiIndex )

		local _, strNpcName, strNpcSceneDesc, nPosX, nPosZ = GetNpcInfoByNpcId(sceneId, MenpaiInfo.NpcId )

		--œ‘ æƒ⁄»›∏ÊÀﬂÕÊº““—æ≠Ω” ‹¡À»ŒŒÒ
		BeginEvent( sceneId )
			AddText( sceneId, x600026_g_MissionName )
			local missionInfo = format( "    %s g£p n’n, ra lÆnh cho c·c h’ c§p tØc tÏm %s %s (%d, %d) ¨ c—u viÆn, nh¢m dﬂΩng uy danh cho b±n bang",
				MenpaiInfo.Name, strNpcSceneDesc, strNpcName, nPosX, nPosZ )

			AddText( sceneId, missionInfo )
			AddText( sceneId, "#rC·c h’ „ nhßn " .. x600026_g_MissionName )
		EndEvent( sceneId )
		DispatchEventList( sceneId, selfId, targetId )
	end
end

--**********************************
--µ±À¯∂®“ª∏ˆ∂‘œÛ
--**********************************
function x600026_OnLockedTarget( sceneId, selfId, objId )
	if IsHaveMission( sceneId, selfId, x600026_g_MissionId ) < 1 then
		return		-- √ª”–∏√»ŒŒÒ
	end

	local misIndex = GetMissionIndexByID( sceneId, selfId, x600026_g_MissionId )
	local MenpaiIndex = GetMissionParam( sceneId, selfId, misIndex, x600026_g_MissionParam_MenpaiIndex )
	local MenpaiInfo = x600026_g_MenpaiInfo[MenpaiIndex]
	if not MenpaiInfo then
		x600026_NotifyFailTips( sceneId, selfId, "Sai sÛt nghiÍm tr˜ng!" )
		return
	end

	local _, strNpcName = GetNpcInfoByNpcId( sceneId, MenpaiInfo.NpcId )

	if GetName( sceneId, objId ) == strNpcName then							-- ’∆√≈
		local missionInfo = format( "    Mµt ·m ngﬂ∂i khÙng rı th‚n phßn x‚m ph’m v‡o v˘ng c§m ∏a, v‚y h„m Æ tÿ c¸a mÙn ph·i ch˙ng ta, ´ ngh∏ c—u viÆn mÙn ph·i ch˙ng ta" )

		TAddText( sceneId, missionInfo )
		TAddNumText( sceneId, x600026_g_ScriptId, "V‡o v˘ng c§m ∏a", 10, 1, x600026_g_ScriptId )
		return
	end

	-- «∑Ò «∏±±æ
	--local sceneType = LuaFnGetSceneType( sceneId )
	--if sceneType ~= 1 then
		--return
	--end

	local fubentype = LuaFnGetCopySceneData_Param( sceneId, 0 )
	if fubentype == MenpaiInfo.Type then
		local GroupID = GetMonsterGroupID( sceneId, objId )
		-- “ÚŒ™—≤¬ﬂ NPC ±ªµ„÷–“‘∫Û≤ªª·‘Ÿ¥ŒœÏ”¶µ„ª˜ ¬º˛£¨À˘“‘’‚¿Ô≤ª◊˜∂ÓÕ‚¥¶¿Ì
		if GroupID == x600026_g_ProtegeGroup then
			local PlayerGender = GetSex( sceneId, selfId )
			local rank

			if PlayerGender == 0 then
				rank = "NÊ hiÆp"
			else
				rank = " c·c h’"
			end

			local missionInfo = format( "    –a t’ %s c—u viÆn tﬂΩng tr˛, ’i nghÓa c¸a qu˝ bang ™n ch™t c˚ng khÙng quÍn", rank )

			TAddText( sceneId, missionInfo )
			TAddNumText( sceneId, x600026_g_ScriptId, "H„y theo t’i h’ ph· v‚y", 10, 2, x600026_g_ScriptId )
			return
		end
	end
end

--**********************************
--ÕÊº“Õ¨“‚Ω¯»Î∏±±æ
--**********************************
function x600026_AcceptEnterCopyScene( sceneId, selfId )
	if IsHaveMission( sceneId, selfId, x600026_g_MissionId ) > 0 then					--”–»ŒŒÒ≤≈ø…“‘◊ﬂ’‚¿Ô
		local misIndex = GetMissionIndexByID( sceneId, selfId, x600026_g_MissionId )

		-- ’‚¿Ô≤ª∞—ÕÊº“¥´µΩ…œ“ª∏ˆ≥°æ∞£¨“ÚŒ™ª§ÀÕ»ŒŒÒ÷–£¨ÕÊº““ªµ©¿Îø™≥°æ∞
		-- ±ªª§ÀÕµƒ NPC ø…ƒ‹À¿Õˆ£¨“≤ø…ƒ‹◊ﬂµΩ÷’µ„£¨“≤ø…ƒ‹∏±±æ“—æ≠…Ë÷√Œ™πÿ±’±Íº«
		-- ∂ºø…ƒ‹µº÷¬ÕÊº“Œﬁ“‚“Âµ√Ω¯»Î£¨À˘“‘“ªµ©Õ¨“‚Ω¯»Î∏±±æ£¨“ª¬…Ω¯»Î–¬∏±±æ

		SetMissionByIndex( sceneId, selfId, misIndex, x600026_g_IsMissionOkFail, 0 )	--Ω´»ŒŒÒµƒµ⁄0∫≈ ˝æ›…Ë÷√Œ™0,±Ì æŒ¥ÕÍ≥…µƒ»ŒŒÒ
		SetMissionByIndex( sceneId, selfId, misIndex, x600026_g_Param_sceneid, -1 )		--Ω´»ŒŒÒµƒµ⁄2∫≈ ˝æ›…Ë÷√Œ™-1, ”√”⁄±£¥Ê∏±±æµƒ≥°æ∞∫≈
		x600026_MakeCopyScene( sceneId, selfId )
	end
end

--**********************************
--ø™ ºΩ¯»Îª§ÀÕπ˝≥Ã
--**********************************
function x600026_StartPatrol( sceneId, selfId, targetId )
	local flag = LuaFnGetCopySceneData_Param( sceneId, 8 )
	if flag == 1 then															-- “—æ≠ø™ ºª§ÀÕ
		return
	end

	local GroupID = GetMonsterGroupID( sceneId, targetId )
	if GroupID == x600026_g_ProtegeGroup then
		--∆Ù∂Ø∏√»ŒŒÒµƒ»ŒŒÒ ±÷”∆˜
		StartMissionTimer( sceneId, selfId, x600026_g_MissionId )
		SetMissionEvent( sceneId, selfId, x600026_g_MissionId, 5 )
		SetPatrolId( sceneId, targetId, x600026_g_PatrolId )							-- …Ë÷√—≤¬ﬂ¬∑æ∂
		LuaFnSetCopySceneData_Param( sceneId, 8, 1 )							--±Í æ“—æ≠ø™ ºª§ÀÕ
		SetUnitReputationID( sceneId, selfId, targetId, GetUnitReputationID( sceneId, selfId, selfId ) )
		SetMonsterFightWithNpcFlag( sceneId, targetId, 1 )				-- ¥Úø™‘ –Ìπ÷ŒÔ∫Õπ÷ŒÔ’Ω∂∑µƒ±Íº«
		-- GetMonsterFightWithNpcFlag
	end
end

--**********************************
--¥¥Ω®∏±±æ
--**********************************
function x600026_MakeCopyScene( sceneId, selfId )
	local misIndex = GetMissionIndexByID( sceneId, selfId, x600026_g_MissionId )
	local MenpaiIndex = GetMissionParam( sceneId, selfId, misIndex, x600026_g_MissionParam_MenpaiIndex )
	local MenpaiInfo = x600026_g_MenpaiInfo[MenpaiIndex]
	if not MenpaiInfo then
		x600026_NotifyFailTips( sceneId, selfId, "Sai sÛt nghiÍm tr˜ng!" )
		return
	end

	local leaderguid = LuaFnObjId2Guid( sceneId, selfId )
	LuaFnSetSceneLoad_Map( sceneId, MenpaiInfo.Map )						--µÿÕº «±ÿ–Î—°»°µƒ£¨∂¯«“±ÿ–Î‘⁄Config/SceneInfo.ini¿Ô≈‰÷√∫√
	LuaFnSetCopySceneData_TeamLeader( sceneId, leaderguid )
	LuaFnSetCopySceneData_NoUserCloseTime( sceneId, x600026_g_NoUserTime * 1000 )
	LuaFnSetCopySceneData_Timer( sceneId, x600026_g_TickTime * 1000 )
	LuaFnSetCopySceneData_Param( sceneId, 0, MenpaiInfo.Type )				--…Ë÷√∏±±æ ˝æ›£¨’‚¿ÔΩ´0∫≈À˜“˝µƒ ˝æ›…Ë÷√Œ™999£¨”√”⁄±Ì æ∏±±æ∫≈999( ˝◊÷◊‘∂®“Â)
	LuaFnSetCopySceneData_Param( sceneId, 1, x600026_g_ScriptId )					--Ω´1∫≈ ˝æ›…Ë÷√Œ™∏±±æ≥°æ∞ ¬º˛Ω≈±æ∫≈
	LuaFnSetCopySceneData_Param( sceneId, 2, 0 )							--…Ë÷√∂® ±∆˜µ˜”√¥Œ ˝
	LuaFnSetCopySceneData_Param( sceneId, 3, -1 )							--…Ë÷√∏±±æ»Îø⁄≥°æ∞∫≈, ≥ı ºªØ
	LuaFnSetCopySceneData_Param( sceneId, 4, 0 )							--…Ë÷√∏±±æπÿ±’±Í÷æ, 0ø™∑≈£¨1πÿ±’
	LuaFnSetCopySceneData_Param( sceneId, 5, 0 )							--…Ë÷√¿Îø™µπº∆ ±¥Œ ˝
	LuaFnSetCopySceneData_Param( sceneId, 6, 0 )							--µ„ª˜±ªª§ÀÕ’ﬂµƒ¥Œ ˝
	LuaFnSetCopySceneData_Param( sceneId, 7, MenpaiIndex )					--±Í æ’‚ «µ⁄º∏∏ˆ≥°æ∞
	LuaFnSetCopySceneData_Param( sceneId, 8, 0 )							--±Í æ «∑Ò“—æ≠ø™ ºª§ÀÕ
	
	local PlayerMaxLevel = GetHumanMaxLevelLimit() --modi:lby20071127

	local mylevel = GetLevel( sceneId, selfId )
	local iniLevel
	if mylevel < 10 then
		iniLevel = 10
	elseif mylevel < PlayerMaxLevel then
		iniLevel = floor( mylevel/10 ) * 10
	else
		iniLevel = PlayerMaxLevel
	end

	LuaFnSetSceneLoad_Area( sceneId, MenpaiInfo.Exit )
	LuaFnSetSceneLoad_Monster( sceneId, format( MenpaiInfo.Monster, iniLevel ) )

	LuaFnSetCopySceneData_Param( sceneId, CopyScene_LevelGap, mylevel - iniLevel ) --º∂±≤Ó£¨CopyScene_LevelGap ‘⁄ scene.lua ÷–∏≥÷µ

	local bRetSceneID = LuaFnCreateCopyScene( sceneId )						--≥ı ºªØÕÍ≥…∫Ûµ˜”√¥¥Ω®∏±±æ∫Ø ˝
	if bRetSceneID > 0 then
		x600026_NotifyFailTips( sceneId, selfId, "D∏ch chuy¨n th‡nh cÙng!" )
	else
		x600026_NotifyFailTips( sceneId, selfId, "SØ lﬂ˛ng b‰n sao „ ™n giæi h’n, ´ ngh∏ l·t nÊa thÿ l’i!" )
	end

end

--**********************************
--∏±±æ ¬º˛
--**********************************
function x600026_OnCopySceneReady( sceneId, destsceneId )
	LuaFnSetCopySceneData_Param( destsceneId, 3, sceneId )					--…Ë÷√∏±±æ»Îø⁄≥°æ∞∫≈
	local leaderguid = LuaFnGetCopySceneData_TeamLeader( destsceneId )
	local leaderObjId = LuaFnGuid2ObjId( sceneId, leaderguid )

	if leaderObjId == -1 then
		return
	end

	if LuaFnIsCanDoScriptLogic( sceneId, leaderObjId ) ~= 1 then			-- ¥¶”⁄Œﬁ∑®÷¥––¬ﬂº≠µƒ◊¥Ã¨
		return
	end

	if IsHaveMission( sceneId, leaderObjId, x600026_g_MissionId ) > 0 then			--”–»ŒŒÒ≤≈ø…“‘◊ﬂ’‚¿Ô
		local misIndex = GetMissionIndexByID( sceneId, leaderObjId, x600026_g_MissionId )
		local MenpaiIndex = GetMissionParam( sceneId, leaderObjId, misIndex, x600026_g_MissionParam_MenpaiIndex )
		local MenpaiInfo = x600026_g_MenpaiInfo[MenpaiIndex]
		if not MenpaiInfo then
			x600026_NotifyFailTips( sceneId, leaderObjId, "Sai sÛt nghiÍm tr˜ng!" )
			return
		end

		--Ω´»ŒŒÒµƒµ⁄2∫≈ ˝æ›…Ë÷√Œ™∏±±æµƒ≥°æ∞∫≈
		SetMissionByIndex( sceneId, leaderObjId, misIndex, x600026_g_Param_sceneid, destsceneId )
		NewWorld( sceneId, leaderObjId, destsceneId, MenpaiInfo.EntrancePos.x, MenpaiInfo.EntrancePos.z )
	end
end

--**********************************
--”–ÕÊº“Ω¯»Î∏±±æ ¬º˛
--**********************************
function x600026_OnPlayerEnter( sceneId, selfId )
	local MenpaiIndex = LuaFnGetCopySceneData_Param( sceneId, 7 )
	local MenpaiInfo = x600026_g_MenpaiInfo[MenpaiIndex]
	if not MenpaiInfo then
		x600026_NotifyFailTips( sceneId, selfId, "Sai sÛt nghiÍm tr˜ng!" )
		return
	end

	if IsHaveMission( sceneId, selfId, x600026_g_MissionId ) == 0 then				-- »Áπ˚Ω¯»Î∏±±æ«∞…æ≥˝»ŒŒÒ£¨‘Ú÷±Ω”¥´ÀÕªÿ
		x600026_NotifyFailTips( sceneId, selfId, "C·c h’ „ khÙng nhßn nhiÆm v¯ n‡y t◊ trﬂæc" )
		x600026_BackToCity( sceneId, selfId )
		return
	end
end

--**********************************
--”–ÕÊº“‘⁄∏±±æ÷–À¿Õˆ ¬º˛
--**********************************
function x600026_OnHumanDie( sceneId, selfId, killerId )
end

--**********************************
--∑≈∆˙
--**********************************
function x600026_OnAbandon( sceneId, selfId )
	local misIndex = GetMissionIndexByID( sceneId, selfId, x600026_g_MissionId )
	local copyscene = GetMissionParam( sceneId, selfId, misIndex, x600026_g_Param_sceneid )

	--…æ≥˝ÕÊº“»ŒŒÒ¡–±Ì÷–∂‘”¶µƒ»ŒŒÒ
	CallScriptFunction( x600026_g_ExpandScript, "OnAbandon", sceneId, selfId )

	if sceneId == copyscene then											--»Áπ˚‘⁄∏±±æ¿Ô…æ≥˝»ŒŒÒ£¨‘Ú÷±Ω”¥´ÀÕªÿ
		x600026_NotifyFailTips( sceneId, selfId, "NhiÆm v¯ th§t b’i!" )
		x600026_BackToCity( sceneId, selfId )
	end
end

--**********************************
-- ªÿ≥«£¨÷ª”–≥« –»ŒŒÒ∏±±æø…“‘µ˜”√¥ÀΩ”ø⁄
--**********************************
function x600026_BackToCity( sceneId, selfId )
	local MenpaiIndex = LuaFnGetCopySceneData_Param( sceneId, 7 )
	local MenpaiInfo = x600026_g_MenpaiInfo[MenpaiIndex]
	if not MenpaiInfo then
		x600026_NotifyFailTips( sceneId, selfId, "Sai sÛt nghiÍm tr˜ng!" )
		return
	end

	local oldsceneId = LuaFnGetCopySceneData_Param( sceneId, 3 )					--»°µ√∏±±æ»Îø⁄≥°æ∞∫≈
	NewWorld( sceneId, selfId, oldsceneId, MenpaiInfo.BackPos.x, MenpaiInfo.BackPos.z )
end

--**********************************
--ºÃ–¯
--**********************************
function x600026_OnContinue( sceneId, selfId, targetId )
	BeginEvent( sceneId )
		AddText( sceneId, x600026_g_MissionName )
		AddText( sceneId, x600026_g_MissionComplete )
	EndEvent( )
	DispatchMissionContinueInfo( sceneId, selfId, targetId, x600026_g_ScriptId, x600026_g_MissionId )
end

--**********************************
--ºÏ≤‚ «∑Òø…“‘Ã·Ωª
--**********************************
function x600026_CheckSubmit( sceneId, selfId, selectRadioId )
	--≈–∂œ»ŒŒÒ «∑Ò“—æ≠ÕÍ≥…
	local ret = CallScriptFunction( x600026_g_ExpandScript, "CheckSubmit", sceneId, selfId )
	return ret
end

--**********************************
--Ã·Ωª
--**********************************
function x600026_OnSubmit( sceneId, selfId, targetId, selectRadioId )
	if GetName( sceneId, targetId ) ~= x600026_g_Name then		--≈–∂œ∏√npc «∑Ò «∂‘”¶»ŒŒÒµƒnpc
		return
	end

	if x600026_CheckSubmit( sceneId, selfId ) == 1 then
		CallScriptFunction( x600026_g_ExpandScript, "OnSubmit", sceneId, selfId, targetId, selectRadioId )
	end
end

--**********************************
--…±À¿π÷ŒÔªÚÕÊº“
--**********************************
function x600026_OnKillObject( sceneId, selfId, objdataId, objId )
end

--**********************************
--Ω¯»Î«¯”Ú ¬º˛
--**********************************
function x600026_OnEnterZone( sceneId, selfId, zoneId )
end

--**********************************
--µ¿æﬂ∏ƒ±‰
--**********************************
function x600026_OnItemChanged( sceneId, selfId, itemdataId )
end

--**********************************
--∏±±æ≥°æ∞∂® ±∆˜ ¬º˛
--**********************************
function x600026_OnCopySceneTimer( sceneId, nowTime )

	--∏±±æ ±÷”∂¡»°º∞…Ë÷√
	local TickCount = LuaFnGetCopySceneData_Param( sceneId, 2 )						--»°µ√“—æ≠÷¥––µƒ∂® ±¥Œ ˝
	TickCount = TickCount + 1
	LuaFnSetCopySceneData_Param( sceneId, 2, TickCount )							--…Ë÷√–¬µƒ∂® ±∆˜µ˜”√¥Œ ˝

	--∏±±æπÿ±’±Í÷æ
	local leaveFlag = LuaFnGetCopySceneData_Param( sceneId, 4 )

	local membercount = LuaFnGetCopyScene_HumanCount( sceneId )
	local mems = {}
	local i

	for i=0, membercount-1 do
		mems[i] = LuaFnGetCopyScene_HumanObjId( sceneId, i )
	end

	if leaveFlag == 1 then															--–Ë“™¿Îø™
		--¿Îø™µπº∆ ±º‰µƒ∂¡»°∫Õ…Ë÷√
		local leaveTickCount = LuaFnGetCopySceneData_Param( sceneId, 5 )
		leaveTickCount = leaveTickCount + 1
		LuaFnSetCopySceneData_Param( sceneId, 5, leaveTickCount )

		if leaveTickCount >= x600026_g_CloseTick then										--µπº∆ ±º‰µΩ£¨¥Ûº“∂º≥ˆ»•∞…
			--Ω´µ±«∞∏±±æ≥°æ∞¿ÔµƒÀ˘”–»À¥´ÀÕªÿ‘≠¿¥Ω¯»Î ±∫Úµƒ≥°æ∞
			for i=0, membercount-1 do
				if LuaFnIsObjValid( sceneId, mems[i] ) == 1 then
					x600026_BackToCity( sceneId, mems[i] )
				end
			end
		else
			--Õ®÷™µ±«∞∏±±æ≥°æ∞¿ÔµƒÀ˘”–»À£¨≥°æ∞πÿ±’µπº∆ ±º‰
			local strText = format( "C·c h’ s® r∂i khˆi nΩi n‡y trong vÚng %d gi‚y nÊa", ( x600026_g_CloseTick - leaveTickCount ) * x600026_g_TickTime )

			for i=0, membercount-1 do
				if LuaFnIsObjValid( sceneId, mems[i] ) == 1 then
					x600026_NotifyFailTips( sceneId, mems[i], strText )
				end
			end
		end
	end
end

--**********************************
--∂® ± ¬º˛
--**********************************
function x600026_OnTimer( sceneId, selfId )
	if IsHaveMission( sceneId, selfId, x600026_g_MissionId ) < 1 then
		return		-- √ª”–∏√»ŒŒÒ
	end

	local misIndex = GetMissionIndexByID( sceneId, selfId, x600026_g_MissionId )

	local MenpaiIndex = LuaFnGetCopySceneData_Param( sceneId, 7 )
	local MenpaiInfo = x600026_g_MenpaiInfo[MenpaiIndex]
	if not MenpaiInfo then
		x600026_NotifyFailTips( sceneId, selfId, "Sai sÛt nghiÍm tr˜ng!" )
		return
	end

	-- «∑Ò «∏±±æ
	local sceneType = LuaFnGetSceneType( sceneId )
	if sceneType ~= 1 then
		ResetMissionEvent( sceneId, selfId, x600026_g_MissionId, 5 )			-- ≤ª‘Ÿ◊ﬂ¥À–ƒÃ¯
		return
	end

	-- «∑Ò «À˘–Ë“™µƒ∏±±æ
	local fubentype = LuaFnGetCopySceneData_Param( sceneId, 0 )
	if fubentype == MenpaiInfo.Type then
		local monstercount = GetMonsterCount( sceneId )
		local i, monsterId, GroupID

		for i = 0, monstercount - 1 do
			monsterId = GetMonsterObjID( sceneId, i )
			GroupID = GetMonsterGroupID( sceneId, monsterId )
			-- “ÚŒ™—≤¬ﬂ NPC ±ªµ„÷–“‘∫Û≤ªª·‘Ÿ¥ŒœÏ”¶µ„ª˜ ¬º˛£¨À˘“‘’‚¿Ô≤ª◊˜∂ÓÕ‚¥¶¿Ì
			if GroupID == x600026_g_ProtegeGroup then
				local x, z = GetLastPatrolPoint( sceneId, 0 )
				local npcX, npcZ = GetWorldPos( sceneId, monsterId )

				if (x - npcX) * (x - npcX) + (z - npcZ) * (z - npcZ) < 4 then	-- ¿Î÷’µ„≤ªµΩ 2 √◊
					SetMissionByIndex( sceneId, selfId, misIndex, x600026_g_IsMissionOkFail, 1 )
					ResetMissionEvent( sceneId, selfId, x600026_g_MissionId, 5 )		-- ≤ª‘Ÿ◊ﬂ¥À–ƒÃ¯
					ResetMissionEvent( sceneId, selfId, x600026_g_MissionId, 4 )		-- ≤ª‘Ÿ»√µ„ª˜
					LuaFnDeleteMonster( sceneId, monsterId )
					LuaFnSetCopySceneData_Param( sceneId, 4, 1 )				-- ∏±±æπÿ±’±Íº«
					x600026_NotifyFailTips( sceneId, selfId, "NhiÆm v¯ ho‡n th‡nh, h„y quay v´ th‡nh ph¯c mÆnh" )
				end

				return
			end
		end

		-- ±ªª§ÀÕµƒ NPC À¿Õˆ
		x600026_NotifyFailTips( sceneId, selfId, "NhiÆm v¯ th§t b’i!" )
		SetMissionByIndex( sceneId, selfId, misIndex, x600026_g_IsMissionOkFail, 2 )	-- »ŒŒÒ ß∞‹
		LuaFnSetCopySceneData_Param( sceneId, 4, 1 )
	end

	-- ¿Îø™¡À∏±±æªÚ’ﬂ±ªª§ÀÕµƒ NPC À¿Õˆ∂ºÕ£÷π◊ﬂº∆ ±∆˜
	ResetMissionEvent( sceneId, selfId, x600026_g_MissionId, 5 )						-- ≤ª‘Ÿ◊ﬂ¥À–ƒÃ¯
end

function x600026_NotifyFailTips( sceneId, selfId, Tip )
	BeginEvent( sceneId )
		AddText( sceneId, Tip )
	EndEvent( sceneId )
	DispatchMissionTips( sceneId, selfId )
end

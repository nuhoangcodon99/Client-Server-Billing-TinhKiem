--Thiªu Th¤t S½n
--Ðinh Xuân Thu
--Author: Hoàng Steven

--******************--


x910165_Item_ttpx ={
50131001, --Bång Lam Lßu Vân (C¤p 1)
50131002,--TØ Vi Tinh Quang (C¤p 1)
50131003,--Thuý Ng÷c Tinh Tr¥n (C¤p 1)
50131004,--Tranh Änh Nhß Mµng (C¤p 1)
50131005,--Hoa LÕc H°ng Tr¥n (C¤p 1)
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
}

x910165_Item_ttpx_vip ={

30501361,--Công lñc ðan
30503134, --kim thoa (duc lo)
30503135, --Th¶i trang ph¯i sÑc ði¬m xuyªt phù
30503136, --Th¶i trang ph¯i sÑc thanh tr× phù
30503137, --Th¶i trang ph¯i sÑc gia công phù

30501361,--Công lñc ðan
30503134, --kim thoa (duc lo)
30503135, --Th¶i trang ph¯i sÑc ði¬m xuyªt phù
30503136, --Th¶i trang ph¯i sÑc thanh tr× phù
30503137, --Th¶i trang ph¯i sÑc gia công phù

30501361,--Công lñc ðan
30503134, --kim thoa (duc lo)
30503135, --Th¶i trang ph¯i sÑc ði¬m xuyªt phù
30503136, --Th¶i trang ph¯i sÑc thanh tr× phù
30503137, --Th¶i trang ph¯i sÑc gia công phù
30501361,--Công lñc ðan
30503134, --kim thoa (duc lo)
30503135, --Th¶i trang ph¯i sÑc ði¬m xuyªt phù
30503136, --Th¶i trang ph¯i sÑc thanh tr× phù
30503137, --Th¶i trang ph¯i sÑc gia công phù

30501361,--Công lñc ðan
30503134, --kim thoa (duc lo)
30503135, --Th¶i trang ph¯i sÑc ði¬m xuyªt phù
30503136, --Th¶i trang ph¯i sÑc thanh tr× phù
30503137, --Th¶i trang ph¯i sÑc gia công phù
30501361,--Công lñc ðan
30503134, --kim thoa (duc lo)
30503135, --Th¶i trang ph¯i sÑc ði¬m xuyªt phù
30503136, --Th¶i trang ph¯i sÑc thanh tr× phù
30503137, --Th¶i trang ph¯i sÑc gia công phù

20503061, --Trang b¸ Tinh thông phù
20503061, --Trang b¸ Tinh thông phù
20503061, --Trang b¸ Tinh thông phù

30010080, --Chân Nguyên Phách

}
x910165_Item_ttpx_vip_rate = 40 -- ty le rot x910165_Item_ttpx_vip


--******************--

--******************--
x910165_g_ScriptId=910165
--******************--
x910165_g_Boss_Name="Ðinh Xuân Thu"																--Tên cüa BOSS
--******************--
x910165_g_Skill_Index_1=1329																	--KÛ nång Tam Tiªu Tiêu Dao Tán
x910165_g_Skill_Index_2=1330																	--KÛ nång Hàm Tiªu Bán Bµ Diên
x910165_g_Skill_1_2_CD=20000																	--Th¶i gian lãnh khß¾c Tam Tiªu Tiêu Dao Tán và Hàm Tiªu Bán Bµ Diên
x910165_g_Skill_Index_3=1331																	--KÛ nång Hóa Công ÐÕi Pháp
x910165_g_Skill_3_CD=30000																		--Th¶i gian lãnh khß¾c Hóa Công ÐÕi Pháp
--******************--
x910165_g_Skill_1_2_Timer=1																		--Th¶i gian kÛ nång Ð¦u Chuy¬n Tinh Di
x910165_g_Skill_3_Timer=2																		--Th¶i gian kÛ nång Tham Hþp Chï
x910165_g_Victim_Index=3																		--NÕn nhân cüa Tam Tiªu Tiêu Dao Tán và Hàm Tiªu Bán Bµ Diên
x910165_g_Poison_Timer=4																		--Th¶i gian phát tác ðµc công cüa Tam Tiªu Tiêu Dao Tán và Hàm Tiªu Bán Bµ Diên
x910165_g_AttackMode=5																			--TrÕng thái chiªn ð¤u
--******************--
x910165_g_Healing_Impact=9781																	--Hi®u Ñng phøc h°i máu
x910165_g_GuangBao_Impact=9483																	--Hi®u Ñng cu°ng bÕo
--******************--
x910165_g_Impact_1=9782																			--Hi®u Ñng Tam Tiªu Tiêu Dao Tán
x910165_g_Impact_2=9783																			--Hi®u Ñng Hàm Tiªu Bán Bµ Diên
x910165_g_Impact_3=9784																			--Hi®u Ñng Hóa Công ÐÕi Pháp
x910165_g_Impact_4=9785																			--Hi®u Ñng trúng ðµc do Tam Tiªu Tiêu Dao Tán và Hàm Tiªu Bán Bµ Diên
x910165_g_Impact_5=9477																			--Hi®u Ñng trúng ðµc 5000 máu/s cho nÕn nhân
--******************--
x910165_g_Monster_Dialogue=
{																								--L¶i nói cüa Boss
	[1]=x910165_g_Boss_Name.." ðã xu¤t hi®n!",
	[2]="Ð¬ Tinh Túc Lão Tiên dÕy cho các ngß½i mµt bài h÷c, lû con nít mi®ng còn hôi sæa!",
	[3]="Các ngß½i hãy ðÑng g¥n và chia së thß½ng ðau cùng %s ði...",
	[4]="Các ngß½i hãy tránh xa %s ra, nó ðang dính mµt loÕi k¸ch ðµc cüa ta, nªu ðÑng g¥n coi ch×ng tính mÕng...",
	[5]="Hãy nªm thØ tuy®t kÛ Hóa Công ÐÕi Pháp cüa phái Tinh Túc ta...",
	[6]="Ðã giªt chªt "..x910165_g_Boss_Name..": 1/1",
	[7]="Nhi®m vø hoàn thành!",
}
--******************--
x910165_g_My_Trap="Huyªt Chú Vu C±"
--******************--

--**********************************--
--*             On Init            *-- 
--**********************************--
function x910165_OnInit(sceneId,selfId)

	--******************--
	MonsterTalk(sceneId,selfId,"",x910165_g_Monster_Dialogue[2])								--Câu nói khai chiªn cüa Boss
	x910165_GlobalNews(sceneId,x910165_g_Monster_Dialogue[1])									--Thông báo Boss ðã vào chiªn ð¤u cho toàn th¬ ngß¶i ch½i
	x910165_ResetMyAI(sceneId,selfId)															--Set lÕi các thuµc tính cho Boss														--Kh·i tÕo NPC
	--******************--

end
--**********************************--
--*         On Heart Beat          *--
--**********************************--
function x910165_OnHeartBeat(sceneId,selfId,nTick)												--Hàm này s¨ check liên tøc m²i mili giây khi nào Boss còn s¯ng

	--******************--
	if LuaFnIsCharacterLiving(sceneId,selfId)~=1 then											--Nªu Boss ðã chªt thì ng×ng hoÕt ðµng cüa Script
		return
	end
	--******************--
	if MonsterAI_GetIntParamByIndex(sceneId,selfId,x910165_g_AttackMode)==0 then
		return
	end
	--******************--
	x910165_ActiveMyTrap(sceneId,selfId)														--H°i phøc và cu°ng bÕo nªu ðÑng g¥n Huyªt Chú Vu C±
	--******************--	
	x910165_ActiveMySkill(sceneId,selfId,nTick)													--Kích hoÕt kÛ nång
	--******************--
	x910165_UseMySkill(sceneId,selfId,nTick)													--SØ døng kÛ nång
	--******************--

end
--**********************************--
--*        On Enter Combat         *--
--**********************************--
function x910165_OnEnterCombat(sceneId,selfId,enmeyId)

	--******************--
	x910165_ResetMyAI(sceneId,selfId)															--Set lÕi các thuµc tính cho Boss
	--******************--
	LuaFnSendSpecificImpactToUnit(sceneId,selfId,selfId,selfId,x910165_g_Impact_5,0)
	--******************--
	MonsterAI_SetIntParamByIndex(sceneId,selfId,x910165_g_AttackMode,1)
	--******************--
	
end
--**********************************--
--*        On Leave Combat         *--
--**********************************--
function x910165_OnLeaveCombat(sceneId,selfId)

	--******************--
	x910165_ResetMyAI(sceneId,selfId)															--Set lÕi các thuµc tính cho Boss
	--******************--

end
--**********************************--
--*       On Kill Character        *--
--**********************************--
function x910165_OnKillCharacter(sceneId,selfId,targetId)
	
	--******************--
	local nHumanCount = LuaFnGetCopyScene_HumanCount(sceneId)
	for i=0,nHumanCount-1 do
		local nHumanId = LuaFnGetCopyScene_HumanObjId(sceneId,i)
		if nHumanId==targetId then
			local PlayerName=GetName(sceneId,targetId)
			MonsterTalk(sceneId,selfId,"","Nªu hôm nay lão phu tha cho ngß½i thì không biªt sau này ngß½i có biªt ½n không, "..GetName(sceneId,targetId)..". Ð¬ cho ch¡c ån thì ngß½i chªt là t¯t nh¤t... Ha ha...")		--Boss chª di­u ngß¶i ch½i b¸ giªt
		end
	end
	--******************--
	
end
--**********************************--
--*             On Die             *--
--**********************************--
function x910165_OnDie(sceneId,selfId,killerId)

	--******************--
	LuaFnSetCopySceneData_Param(sceneId,8,6)													--C§p nh§t thao tác trên phø bän
	--******************--
	x910165_GlobalNews(sceneId,x910165_g_Monster_Dialogue[6])
	x910165_GlobalNews(sceneId,x910165_g_Monster_Dialogue[7])
	--******************--
	for i=0,GetNearTeamCount(sceneId,killerId)-1  do
		AddMonsterDropItem(sceneId,selfId,GetNearTeamMember(sceneId,killerId,i),x910165_Item_ttpx[random(getn(x910165_Item_ttpx))])
		local ran = random(100)
		if ran < x910165_Item_ttpx_vip_rate then
			AddMonsterDropItem(sceneId,selfId,GetNearTeamMember(sceneId,killerId,i),x910165_Item_ttpx_vip[random(getn(x910165_Item_ttpx_vip))])
		end
		local nPlayerId=GetNearTeamMember(sceneId,killerId,i)
		local Current_Activity_Point=GetMissionData(sceneId,nPlayerId,MD_CURRENT_ACTIVITY_POINT)
		SetMissionData(sceneId,nPlayerId,MD_CURRENT_ACTIVITY_POINT,Current_Activity_Point+30)
		BeginEvent(sceneId)
			AddText(sceneId,"Các hÕ ðã gia tång 30 ði¬m hoÕt ðµng!")
		EndEvent(sceneId)
		DispatchMissionTips(sceneId,nPlayerId)
	end
	--******************--
	
end
--**********************************--
--*          Reset My AI           *--
--**********************************--
function x910165_ResetMyAI(sceneId,selfId)

	--******************--
	MonsterAI_SetIntParamByIndex(sceneId,selfId,x910165_g_Skill_1_2_Timer,x910165_g_Skill_1_2_CD)--Th¶i gian kÛ nång 1+2
	MonsterAI_SetIntParamByIndex(sceneId,selfId,x910165_g_Skill_3_Timer,x910165_g_Skill_3_CD)	--Th¶i gian kÛ nång 3
	MonsterAI_SetIntParamByIndex(sceneId,selfId,x910165_g_Victim_Index,-1)						--Kh·i tÕo lÕi ID nÕn nhân
	--******************--
	LuaFnCancelSpecificImpact(sceneId,selfId,x910165_g_Impact_5)
	--******************--
	MonsterAI_SetIntParamByIndex(sceneId,selfId,x910165_g_AttackMode,0)
	--******************--
	
end
--**********************************--
--*         Active My Trap         *--
--**********************************--
function x910165_ActiveMyTrap(sceneId,selfId)

	--******************--
	local Pos_X,Pos_Y=GetWorldPos(sceneId,selfId)
	--******************--
	local nMonsterNum=GetMonsterCount(sceneId)
	for i=0,nMonsterNum-1 do
		local MonsterId=GetMonsterObjID(sceneId,i)
		local x,y=GetWorldPos(sceneId,MonsterId)
		if LuaFnIsCharacterLiving(sceneId,MonsterId)==1 and GetName(sceneId,MonsterId)==x910165_g_My_Trap 
		and floor(sqrt((x-Pos_X)*(x-Pos_X)+(y-Pos_Y)*(y-Pos_Y)))<=3 then
			LuaFnSendSpecificImpactToUnit(sceneId,selfId,selfId,selfId,x910165_g_Healing_Impact,0)
			if LuaFnHaveImpactOfSpecificDataIndex(sceneId,selfId,x910165_g_GuangBao_Impact)<1 then
				LuaFnSendSpecificImpactToUnit(sceneId,selfId,selfId,selfId,x910165_g_GuangBao_Impact,0)
			end
		end
	end
	--******************--
	
end
--**********************************--
--*        Active My Skill         *--
--**********************************--
function x910165_ActiveMySkill(sceneId,selfId,nTick)

	--******************--
	local nTime=MonsterAI_GetIntParamByIndex(sceneId,selfId,x910165_g_Poison_Timer)
	MonsterAI_SetIntParamByIndex(sceneId,selfId,x910165_g_Poison_Timer,nTime-nTick)
	if nTime>0 then
		return
	end
	--******************--
	MonsterAI_SetIntParamByIndex(sceneId,selfId,x910165_g_Poison_Timer,1000)
	--******************--
	local Victim=MonsterAI_GetIntParamByIndex(sceneId,selfId,x910165_g_Victim_Index)			--L¤y ID nÕn nhân
	--******************--
	if LuaFnHaveImpactOfSpecificDataIndex(sceneId,Victim,x910165_g_Impact_1)>0 then				--NÕn nhân b¸ dính Tam Tiªu Tiêu Dao Tán
		local x,y=GetWorldPos(sceneId,Victim)
		local nHumanList={}
		local nDec=1
		nHumanList[1]=Victim
		local nHumanCount = LuaFnGetCopyScene_HumanCount(sceneId)
		for i=0,nHumanCount-1 do
			local nHumanId = LuaFnGetCopyScene_HumanObjId(sceneId,i)
			local x1,y1=GetWorldPos(sceneId,nHumanId)
			if LuaFnIsObjValid(sceneId,nHumanId)==1 and LuaFnIsCanDoScriptLogic(sceneId,nHumanId)==1 and LuaFnIsCharacterLiving(sceneId,nHumanId)==1 
			and floor(sqrt((x-x1)*(x-x1)+(y-y1)*(y-y1)))<=5 and Victim~=nHumanId then
				nDec=nDec+1
				nHumanList[nDec]=nHumanId
			end
		end
		for i=1,nDec do
			for j=1,nDec do
				LuaFnSendSpecificImpactToUnit(sceneId,selfId,selfId,nHumanList[i],x910165_g_Impact_4,0)
				for k=0,9 do																		--Ki¬m tra các ô trân thú cüa ngß¶i ch½i xem có trân thú nào ðang xu¤t chiªn
					local High,Low=LuaFnGetPetGUID(sceneId,nHumanList[i],k)
					local Pet_Index=LuaFnGetPetObjIdByGUID(sceneId,nHumanList[i],High,Low)								
					if Pet_Index~=-1 and Pet_Index then												--Nªu trân thú này ðang xu¤t chiªn
						LuaFnSendSpecificImpactToUnit(sceneId,selfId,selfId,Pet_Index,x910165_g_Impact_4,0)--Nh§n hi®u Ñng công kích kÛ nång
						break
					end
				end
			end
		end
	elseif LuaFnHaveImpactOfSpecificDataIndex(sceneId,Victim,x910165_g_Impact_2)>0 then				--NÕn nhân b¸ dính Hàm Tiªu Bán Bµ Diên
		local x,y=GetWorldPos(sceneId,Victim)
		local nHumanList={}
		local nDec=1
		nHumanList[1]=Victim
		local nHumanCount = LuaFnGetCopyScene_HumanCount(sceneId)
		for i=0,nHumanCount-1 do
			local nHumanId = LuaFnGetCopyScene_HumanObjId(sceneId,i)
			local x1,y1=GetWorldPos(sceneId,nHumanId)
			if LuaFnIsObjValid(sceneId,nHumanId)==1 and LuaFnIsCanDoScriptLogic(sceneId,nHumanId)==1 and LuaFnIsCharacterLiving(sceneId,nHumanId)==1 
			and floor(sqrt((x-x1)*(x-x1)+(y-y1)*(y-y1)))<=5 and Victim~=nHumanId  then
				nDec=nDec+1
				nHumanList[nDec]=nHumanId
			end
		end
		for i=1,nDec do
			for j=1,7-nDec do
				LuaFnSendSpecificImpactToUnit(sceneId,selfId,selfId,nHumanList[i],x910165_g_Impact_4,0)
				for k=0,9 do																		--Ki¬m tra các ô trân thú cüa ngß¶i ch½i xem có trân thú nào ðang xu¤t chiªn
					local High,Low=LuaFnGetPetGUID(sceneId,nHumanList[i],k)
					local Pet_Index=LuaFnGetPetObjIdByGUID(sceneId,nHumanList[i],High,Low)								
					if Pet_Index~=-1 and Pet_Index then												--Nªu trân thú này ðang xu¤t chiªn
						LuaFnSendSpecificImpactToUnit(sceneId,selfId,selfId,Pet_Index,x910165_g_Impact_4,0)--Nh§n hi®u Ñng công kích kÛ nång
						break
					end
				end
			end
		end
	end
	--******************--
	
end
--**********************************--
--*          Use My Skill          *--
--**********************************--
function x910165_UseMySkill(sceneId,selfId,nTick)

	--******************--
	local Time_Skill_1_2=MonsterAI_GetIntParamByIndex(sceneId,selfId,x910165_g_Skill_1_2_Timer)	--L¤y th¶i gian lãnh khß¾c kÛ nång 1+2 cüa Boss
	local Time_Skill_3=MonsterAI_GetIntParamByIndex(sceneId,selfId,x910165_g_Skill_3_Timer)		--L¤y th¶i gian lãnh khß¾c kÛ nång 3 cüa Boss
	MonsterAI_SetIntParamByIndex(sceneId,selfId,x910165_g_Skill_1_2_Timer,Time_Skill_1_2-nTick)	--C§p nh§t th¶i gian lãnh khß¾c cüa kÛ nång 1+2
	MonsterAI_SetIntParamByIndex(sceneId,selfId,x910165_g_Skill_3_Timer,Time_Skill_3-nTick)		--C§p nh§t th¶i gian lãnh khß¾c cüa kÛ nång 3
	--******************--
	if Time_Skill_1_2<=0 then																	--Ðã ðªn gi¶ dùng kÛ nång
		MonsterAI_SetIntParamByIndex(sceneId,selfId,x910165_g_Skill_1_2_Timer,x910165_g_Skill_1_2_CD)--C§p nh§t lÕi th¶i gian lãnh khß¾c cüa kÛ nång 1+2
		x910165_UseSkill12(sceneId,selfId)														--SØ døng kÛ nång 1+2
	end
	--******************--
	if Time_Skill_3<=0 then																		--Ðã ðªn gi¶ dùng kÛ nång
		MonsterAI_SetIntParamByIndex(sceneId,selfId,x910165_g_Skill_3_Timer,x910165_g_Skill_3_CD)--C§p nh§t lÕi th¶i gian lãnh khß¾c cüa kÛ nång 3
		local x,y=GetWorldPos(sceneId,selfId)
		LuaFnUnitUseSkill(sceneId,selfId,x910165_g_Skill_Index_3,x,y,0,1)							--Boss sØ døng kÛ nång 3
	end
	--******************--
	
end
--**********************************--
--*         Use Skill 1+2          *--
--**********************************--
function x910165_UseSkill12(sceneId,selfId)

	--******************--
	local x,y=GetWorldPos(sceneId,selfId)
	--******************--
	local nHumanList={}
	local nDec=0
	local nHumanCount = LuaFnGetCopyScene_HumanCount(sceneId)
	for i=0,nHumanCount-1 do
		local nHumanId = LuaFnGetCopyScene_HumanObjId(sceneId,i)
		local x1,y1=GetWorldPos(sceneId,nHumanId)
		if LuaFnIsObjValid(sceneId,nHumanId)==1 and LuaFnIsCanDoScriptLogic(sceneId,nHumanId)==1 and LuaFnIsCharacterLiving(sceneId,nHumanId)==1 
		and floor(sqrt((x-x1)*(x-x1)+(y-y1)*(y-y1)))<=20 then
			nDec=nDec+1
			nHumanList[nDec]=nHumanId
		end
	end
	--******************--
	local Victim=random(nDec)
	--******************--
	MonsterAI_SetIntParamByIndex(sceneId,selfId,x910165_g_Victim_Index,nHumanList[Victim])
	--******************--
	local Ran=random(2)
	--******************--
	if Ran==1 then
		local str=format(x910165_g_Monster_Dialogue[3],GetName(sceneId,nHumanList[Victim]))
		MonsterTalk(sceneId,selfId,"",str)
		LuaFnUnitUseSkill(sceneId,selfId,x910165_g_Skill_Index_1,x,y,0,1)						--Boss sØ døng kÛ nång 1
		LuaFnSendSpecificImpactToUnit(sceneId,selfId,selfId,nHumanList[Victim],x910165_g_Impact_1,0)
	else
		local str=format(x910165_g_Monster_Dialogue[4],GetName(sceneId,nHumanList[Victim]))
		MonsterTalk(sceneId,selfId,"",str)
		LuaFnUnitUseSkill(sceneId,selfId,x910165_g_Skill_Index_2,x,y,0,1)						--Boss sØ døng kÛ nång 2
		LuaFnSendSpecificImpactToUnit(sceneId,selfId,selfId,nHumanList[Victim],x910165_g_Impact_2,0)
	end
	--******************--
	MonsterAI_SetIntParamByIndex(sceneId,selfId,x910165_g_Poison_Timer,0)
	--******************--
	
end
--**********************************--
--*           Global News          *--
--**********************************--
function x910165_GlobalNews(sceneId,Tips)

	--******************--
	local nHumanCount = LuaFnGetCopyScene_HumanCount(sceneId)
	for i=0,nHumanCount-1 do
		local nHumanId = LuaFnGetCopyScene_HumanObjId(sceneId,i)
		if LuaFnIsObjValid(sceneId,nHumanId)==1 and LuaFnIsCanDoScriptLogic(sceneId,nHumanId)==1 and LuaFnIsCharacterLiving(sceneId,nHumanId)==1 then
			BeginEvent(sceneId)
				AddText(sceneId,Tips)
			EndEvent(sceneId)
			DispatchMissionTips(sceneId,nHumanId)
		end
	end
	--******************--

end

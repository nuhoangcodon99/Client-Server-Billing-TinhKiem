--Phø bän TÑ Tuy®t Trang
--T¥n V§n
--Author: Hoàng Steven

--******************--



x910175_Item_ttpx ={
50131001, --Bång Lam Lßu Vân (C¤p 1)
50131002,--TØ Vi Tinh Quang (C¤p 1)
50131003,--Thuý Ng÷c Tinh Tr¥n (C¤p 1)
50131004,--Tranh Änh Nhß Mµng (C¤p 1)
50131005,--Hoa LÕc H°ng Tr¥n (C¤p 1)
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
20503062,--Ly Höa
}

x910175_Item_ttpx_vip ={

30501361,--Công lñc ðan
30503134, --kim thoa (duc lo)
30503135, --Th¶i trang ph¯i sÑc ði¬m xuyªt phù
30503136, --Th¶i trang ph¯i sÑc thanh tr× phù
30503137, --Th¶i trang ph¯i sÑc gia công phù

30501361,--Công lñc ðan
30503134, --kim thoa (duc lo)
30503135, --Th¶i trang ph¯i sÑc ði¬m xuyªt phù
30503136, --Th¶i trang ph¯i sÑc thanh tr× phù
30503137, --Th¶i trang ph¯i sÑc gia công phù

30501361,--Công lñc ðan
30503134, --kim thoa (duc lo)
30503135, --Th¶i trang ph¯i sÑc ði¬m xuyªt phù
30503136, --Th¶i trang ph¯i sÑc thanh tr× phù
30503137, --Th¶i trang ph¯i sÑc gia công phù

30501361,--Công lñc ðan
30503134, --kim thoa (duc lo)
30503135, --Th¶i trang ph¯i sÑc ði¬m xuyªt phù
30503136, --Th¶i trang ph¯i sÑc thanh tr× phù
30503137, --Th¶i trang ph¯i sÑc gia công phù

30501361,--Công lñc ðan
30503134, --kim thoa (duc lo)
30503135, --Th¶i trang ph¯i sÑc ði¬m xuyªt phù
30503136, --Th¶i trang ph¯i sÑc thanh tr× phù
30503137, --Th¶i trang ph¯i sÑc gia công phù

30501361,--Công lñc ðan
30503134, --kim thoa (duc lo)
30503135, --Th¶i trang ph¯i sÑc ði¬m xuyªt phù
30503136, --Th¶i trang ph¯i sÑc thanh tr× phù
30503137, --Th¶i trang ph¯i sÑc gia công phù

20503061, --Trang b¸ Tinh thông phù
20503061, --Trang b¸ Tinh thông phù
20503061, --Trang b¸ Tinh thông phù

30010080, --Chân Nguyên Phách
}
x910175_Item_ttpx_vip_rate = 40 -- ty le rot x910175_Item_ttpx_vip


--******************--

--******************--
x910175_g_ScriptId=910175
--******************--
x910175_g_Boss_Name="T¥n V§n"																	--Tên cüa BOSS
--******************--
x910175_g_Skill_Index_1=1672																	--KÛ nång Chúc Änh Dao H°ng (Ð½n th¬ mù)
x910175_g_Skill_1_CD=30000																		--Th¶i gian lãnh khß¾c Chúc Änh Dao H°ng
x910175_g_Skill_Index_2=1671																	--KÛ nång Nhi­u Lß½ng Tam Nh§t (Ð½n th¬ công kích)
x910175_g_Skill_2_CD=40000																		--Th¶i gian lãnh khß¾c Nhi­u Lß½ng Tam Nh§t
x910175_g_Skill_Index_3=1670																	--KÛ nång Huy«n NgoÕi Chi Âm (Qu¥n th¬ công kích)
x910175_g_Skill_3_CD=32000																		--Th¶i gian lãnh khß¾c Huy«n NgoÕi Chi Âm
--******************--
x910175_g_Skill_Imba=1673																		--KÛ nång Kim S¡c Cu°ng Vû
--******************--
x910175_g_Trap_Active_Time=5000																	--Th¶i gian kích n± H°i âm phiên
--******************--
x910175_g_Trap_Impact=9771																		--Hi®u Ñng kích n± H°i âm phiên
x910175_g_KuangBao_Impact=9789																	--Hi®u Ñng cu°ng bÕo x13 dame trong 5s
--******************--
x910175_g_Skill_1_Timer=1																		--Th¶i gian kÛ nång 1
x910175_g_Skill_2_Timer=2																		--Th¶i gian kÛ nång 2
x910175_g_Skill_3_Timer=3																		--Th¶i gian kÛ nång 3
x910175_g_Skill_Imba_Step=4																		--Th¶i gian kÛ nång Imba
x910175_g_Trap_Timer=5																			--Th¶i gian kích n± H°i âm phiên
x910175_g_AttackMode=6																			--TrÕng thái chiªn ð¤u
--******************--
x910175_g_Monster_Dialogue=
{																								--L¶i nói cüa Boss
	[1]=x910175_g_Boss_Name.." ðã xu¤t hi®n!",
	[2]="Kim...Vû...Tú...Linh...Thiên...Ngøc...Nhßþc...Vu...Quý...",
	[3]="Ðã giªt chªt "..x910175_g_Boss_Name..": 1/1",
	[4]="Bí bäo...Th¡ng ngã...C¥m t¤u...#r...#r...Nhßþc...#r...Phiên...Lai...#r...Vû...Kh·i...#r...Cß¶ng...#r...Liên...Vû...#r...BÕi...Tinh la ðàn...Báng Xí...",
	[5]="T¥n V§n chÆng nhæng có th¬ dùng tiªng ðàn ð¬ nói chuy®n mà công phu thì lÕi r¤t cao cß¶ng, quä th§t lþi hÕi. Xem câu hát cüa mø trß¾c khi chªt th§t khiªn ta ð± m° hôi lÕnh. Xem ra mø ta ðã ðoán ðßþc chúng ta ðªn ðây là ð¬ tìm Tinh La Ðàn - Bàng Xí...",
	[6]="T¥n V§n ðang ngày càng ð¦y nhanh ðµc tác gäy ðàn, xem ra mø ta ð¸nh tri®u t§p H°i âm phiên khuªch ðÕi âm thanh. M÷i ngß¶i phäi chú ý c¦n th§n, hãy dø mø ta tránh xa các H°i âm phiên này!",
}
--******************--
x910175_g_Trap={	Index=14126,	Name="H°i âm phiên"		}
--******************--

--**********************************--
--*             On Init            *-- 
--**********************************--
function x910175_OnInit(sceneId,selfId)

	--******************--
	MonsterTalk(sceneId,selfId,"TÑ Tuy®t Trang",x910175_g_Monster_Dialogue[2])					--Câu nói khai chiªn cüa Boss
	x910175_GlobalNews(sceneId,x910175_g_Monster_Dialogue[1])									--Thông báo Boss ðã vào chiªn ð¤u cho toàn th¬ ngß¶i ch½i
	x910175_ResetMyAI(sceneId,selfId)															--Set lÕi các thuµc tính cho Boss
	--******************--

end
--**********************************--
--*         On Heart Beat          *--
--**********************************--
function x910175_OnHeartBeat(sceneId,selfId,nTick)												--Hàm này s¨ check liên tøc m²i mili giây khi nào Boss còn s¯ng

	--******************--
	if LuaFnIsCharacterLiving(sceneId,selfId)~=1 then											--Nªu Boss ðã chªt thì ng×ng hoÕt ðµng cüa Script
		return
	end
	--******************--
	if MonsterAI_GetIntParamByIndex(sceneId,selfId,x910175_g_AttackMode)==0 then
		return
	end
	--******************--
	x910175_UseMyTrap(sceneId,selfId)															--G÷i ra H°i âm phiên nªu dß¾i 50% máu
	--******************--
	x910175_ActiveMyTrap(sceneId,selfId,nTick)													--Ki¬m tra có H°i âm phiên xung quanh không
	--******************--
	x910175_UseMySkill(sceneId,selfId,nTick)													--SØ døng kÛ nång
	--******************--

end
--**********************************--
--*        On Enter Combat         *--
--**********************************--
function x910175_OnEnterCombat(sceneId,selfId,enmeyId)

	--******************--
	x910175_ResetMyAI(sceneId,selfId)															--Set lÕi các thuµc tính cho Boss
	--******************--
	MonsterAI_SetIntParamByIndex(sceneId,selfId,x910175_g_AttackMode,1)
	--******************--

end
--**********************************--
--*        On Leave Combat         *--
--**********************************--
function x910175_OnLeaveCombat(sceneId,selfId)

	--******************--
	x910175_ResetMyAI(sceneId,selfId)															--Set lÕi các thuµc tính cho Boss
	--******************--

end
--**********************************--
--*       On Kill Character        *--
--**********************************--
function x910175_OnKillCharacter(sceneId,selfId,targetId)
	
	--******************--
	--******************--
	
end
--**********************************--
--*             On Die             *--
--**********************************--
function x910175_OnDie(sceneId,selfId,killerId)

	--******************--
	x910175_GlobalNews(sceneId,x910175_g_Monster_Dialogue[3])
	x910175_GlobalNews(sceneId,x910175_g_Monster_Dialogue[5])
	--******************--
	LuaFnSetCopySceneData_Param(sceneId,8,4)
	--******************--
	x910175_DeleteMyTrap(sceneId)																--Xóa H°i âm phiên
	--******************--
	for i=0,GetNearTeamCount(sceneId,killerId)-1  do
		AddMonsterDropItem(sceneId,selfId,GetNearTeamMember(sceneId,killerId,i),x910175_Item_ttpx[random(getn(x910175_Item_ttpx))])
		local ran = random(100)
		if ran < x910175_Item_ttpx_vip_rate then
			AddMonsterDropItem(sceneId,selfId,GetNearTeamMember(sceneId,killerId,i),x910175_Item_ttpx_vip[random(getn(x910175_Item_ttpx_vip))])
		end
		local Current_Activity_Point=GetMissionData(sceneId,GetNearTeamMember(sceneId,killerId,i),MD_CURRENT_ACTIVITY_POINT)
		SetMissionData(sceneId,GetNearTeamMember(sceneId,killerId,i),MD_CURRENT_ACTIVITY_POINT,Current_Activity_Point+30)
		BeginEvent(sceneId)
			AddText(sceneId,"Các hÕ ðã gia tång 30 ði¬m hoÕt ðµng!")
		EndEvent(sceneId)
		DispatchMissionTips(sceneId,GetNearTeamMember(sceneId,killerId,i))
	end
	--******************--

end
--**********************************--
--*          Reset My AI           *--
--**********************************--
function x910175_ResetMyAI(sceneId,selfId)

	--******************--
	MonsterAI_SetIntParamByIndex(sceneId,selfId,x910175_g_Skill_1_Timer,x910175_g_Skill_1_CD)	--Th¶i gian kÛ nång 1
	MonsterAI_SetIntParamByIndex(sceneId,selfId,x910175_g_Skill_2_Timer,x910175_g_Skill_2_CD)	--Th¶i gian kÛ nång 2
	MonsterAI_SetIntParamByIndex(sceneId,selfId,x910175_g_Skill_3_Timer,x910175_g_Skill_3_CD)	--Th¶i gian kÛ nång 3
	MonsterAI_SetIntParamByIndex(sceneId,selfId,x910175_g_Skill_Imba_Step,0)					--Th¶i gian kÛ nång Imba
	MonsterAI_SetIntParamByIndex(sceneId,selfId,x910175_g_Trap_Timer,x910175_g_Trap_Active_Time)--Th¶i gian kích n± H°i âm phiên
	--******************--
	x910175_DeleteMyTrap(sceneId)																--Xóa H°i âm phiên
	--******************--
	MonsterAI_SetIntParamByIndex(sceneId,selfId,x910175_g_AttackMode,0)
	--******************--
	
end
--**********************************--
--*         Delete My Trap         *--
--**********************************--
function x910175_DeleteMyTrap(sceneId)

	--******************--
	local nMonsterNum=GetMonsterCount(sceneId)
	for i=0,nMonsterNum-1 do
		local MonsterId=GetMonsterObjID(sceneId,i)
		if LuaFnIsCharacterLiving(sceneId,MonsterId)==1 and GetName(sceneId,MonsterId)==x910175_g_Trap.Name then
			SetCharacterDieTime(sceneId,MonsterId,100)
		end
	end
	--******************--
	
end
--**********************************--
--*          Use My Trap           *--
--**********************************--
function x910175_UseMyTrap(sceneId,selfId)

	--******************--
	local Current_HP=GetHp(sceneId,selfId)
	local Max_HP=GetMaxHp(sceneId,selfId)
	local Percent_Left=floor((Current_HP/Max_HP)*100)
	local Actived=MonsterAI_GetIntParamByIndex(sceneId,selfId,x910175_g_Skill_Imba_Step)
	--******************--
	if Percent_Left>50 or Actived~=0 then
		return
	end
	--******************--
	local x,y=GetWorldPos(sceneId,selfId)
	--******************--
	LuaFnUnitUseSkill(sceneId,selfId,x910175_g_Skill_Imba,x,y,0,1)							--Boss sØ døng kÛ nång Imba
	local dd={-3,-3, 3, 3}
	local dc={-3, 3, 3,-3}
	--******************--
	for i=1,4 do
		local Trap_Index=LuaFnCreateMonster(sceneId,x910175_g_Trap.Index,x+dd[i],y+dc[i],3,0,-1)
		SetCharacterName(sceneId,Trap_Index,x910175_g_Trap.Name)
	end
	--******************--
	MonsterAI_SetIntParamByIndex(sceneId,selfId,x910175_g_Skill_Imba_Step,1)
	--******************--
	x910175_GlobalNews(sceneId,x910175_g_Monster_Dialogue[6])
	--******************--
	
end
--**********************************--
--*         Active My Trap         *--
--**********************************--
function x910175_ActiveMyTrap(sceneId,selfId,nTick)

	--******************--
	local nTrap=0
	local x,y=GetWorldPos(sceneId,selfId)
	--******************--
	local nMonsterNum=GetMonsterCount(sceneId)
	for i=0,nMonsterNum-1 do
		local MonsterId=GetMonsterObjID(sceneId,i)
		local x1,y1=GetWorldPos(sceneId,MonsterId)
		if LuaFnIsCharacterLiving(sceneId,MonsterId)==1 and GetName(sceneId,MonsterId)==x910175_g_Trap.Name 
		and floor(sqrt((x-x1)*(x-x1)+(y-y1)*(y-y1)))<=5 then
			LuaFnSendSpecificImpactToUnit(sceneId,selfId,selfId,selfId,x910175_g_KuangBao_Impact,0)
			nTrap=1
			break
		end
	end
	--******************--
	if nTrap==0 then
		MonsterAI_SetIntParamByIndex(sceneId,selfId,x910175_g_Trap_Timer,x910175_g_Trap_Active_Time)
		return
	end
	--******************--
	local nActive=MonsterAI_GetIntParamByIndex(sceneId,selfId,x910175_g_Trap_Timer)
	MonsterAI_SetIntParamByIndex(sceneId,selfId,x910175_g_Trap_Timer,nActive-nTick)
	--******************--
	if nActive<=0 then
		local nHumanCount = LuaFnGetCopyScene_HumanCount(sceneId)
		for i=0,nHumanCount-1 do
			local nHumanId = LuaFnGetCopyScene_HumanObjId(sceneId,i)
			local x1,y1=GetWorldPos(sceneId,nHumanId)
			if LuaFnIsObjValid(sceneId,nHumanId)==1 and LuaFnIsCanDoScriptLogic(sceneId,nHumanId)==1 and LuaFnIsCharacterLiving(sceneId,nHumanId)==1 
			and floor(sqrt((x-x1)*(x-x1)+(y-y1)*(y-y1)))<=15 then
				LuaFnSendSpecificImpactToUnit(sceneId,selfId,selfId,nHumanId,x910175_g_Trap_Impact,0)
				for k=0,9 do																
					local High,Low=LuaFnGetPetGUID(sceneId,nHumanId,k)
					local Pet_Index=LuaFnGetPetObjIdByGUID(sceneId,nHumanId,High,Low)								
					if Pet_Index~=-1 and Pet_Index then											
						LuaFnSendSpecificImpactToUnit(sceneId,selfId,selfId,Pet_Index,x910175_g_Trap_Impact,0)
						break
					end
				end
			end
		end
		MonsterAI_SetIntParamByIndex(sceneId,selfId,x910175_g_Trap_Timer,x910175_g_Trap_Active_Time)
	end
	--******************--
	
end
--**********************************--
--*          Use My Skill          *--
--**********************************--
function x910175_UseMySkill(sceneId,selfId,nTick)

	--******************--
	local Time_Skill_1=MonsterAI_GetIntParamByIndex(sceneId,selfId,x910175_g_Skill_1_Timer)		--L¤y th¶i gian lãnh khß¾c kÛ nång 1 cüa Boss
	local Time_Skill_2=MonsterAI_GetIntParamByIndex(sceneId,selfId,x910175_g_Skill_2_Timer)		--L¤y th¶i gian lãnh khß¾c kÛ nång 2 cüa Boss
	local Time_Skill_3=MonsterAI_GetIntParamByIndex(sceneId,selfId,x910175_g_Skill_3_Timer)		--L¤y th¶i gian lãnh khß¾c kÛ nång 3 cüa Boss
	MonsterAI_SetIntParamByIndex(sceneId,selfId,x910175_g_Skill_1_Timer,Time_Skill_1-nTick)		--C§p nh§t th¶i gian lãnh khß¾c cüa kÛ nång 1
	MonsterAI_SetIntParamByIndex(sceneId,selfId,x910175_g_Skill_2_Timer,Time_Skill_2-nTick)		--C§p nh§t th¶i gian lãnh khß¾c cüa kÛ nång 2
	MonsterAI_SetIntParamByIndex(sceneId,selfId,x910175_g_Skill_3_Timer,Time_Skill_3-nTick)		--C§p nh§t th¶i gian lãnh khß¾c cüa kÛ nång 3
	--******************--
	if Time_Skill_1<=0 then																		--Ðã ðªn gi¶ dùng kÛ nång 1
		local x,y=GetWorldPos(sceneId,selfId)													--L¤y t÷a ðµ Boss
		LuaFnUnitUseSkill(sceneId,selfId,x910175_g_Skill_Index_1,x,y,0,1)						--Boss sØ døng kÛ nång 1
		MonsterAI_SetIntParamByIndex(sceneId,selfId,x910175_g_Skill_1_Timer,x910175_g_Skill_1_CD)--C§p nh§t lÕi th¶i gian lãnh khß¾c cüa kÛ nång
	end
	--******************--
	if Time_Skill_2<=0 then																		--Ðã ðªn gi¶ dùng kÛ nång 2
		local x,y=GetWorldPos(sceneId,selfId)													--L¤y t÷a ðµ Boss
		LuaFnUnitUseSkill(sceneId,selfId,x910175_g_Skill_Index_2,x,y,0,1)						--Boss sØ døng kÛ nång 2
		MonsterAI_SetIntParamByIndex(sceneId,selfId,x910175_g_Skill_2_Timer,x910175_g_Skill_2_CD)--C§p nh§t lÕi th¶i gian lãnh khß¾c cüa kÛ nång
	end
	--******************--
	if Time_Skill_3<=0 then																		--Ðã ðªn gi¶ dùng kÛ nång 3
		local x,y=GetWorldPos(sceneId,selfId)													--L¤y t÷a ðµ Boss
		LuaFnUnitUseSkill(sceneId,selfId,x910175_g_Skill_Index_3,x,y,0,1)						--Boss sØ døng kÛ nång 3
		MonsterAI_SetIntParamByIndex(sceneId,selfId,x910175_g_Skill_3_Timer,x910175_g_Skill_3_CD)--C§p nh§t lÕi th¶i gian lãnh khß¾c cüa kÛ nång
	end
	--******************--
	
end
--**********************************--
--*           Global News          *--
--**********************************--
function x910175_GlobalNews(sceneId,Tips)

	--******************--
	local nHumanCount = LuaFnGetCopyScene_HumanCount(sceneId)
	for i=0,nHumanCount-1 do
		local nHumanId = LuaFnGetCopyScene_HumanObjId(sceneId,i)
		if LuaFnIsObjValid(sceneId,nHumanId)==1 and LuaFnIsCanDoScriptLogic(sceneId,nHumanId)==1 and LuaFnIsCharacterLiving(sceneId,nHumanId)==1 then
			BeginEvent(sceneId)
				AddText(sceneId,Tips)
			EndEvent(sceneId)
			DispatchMissionTips(sceneId,nHumanId)
		end
	end
	--******************--

end
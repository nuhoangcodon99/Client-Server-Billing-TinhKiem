--NPC Truy«n võ công Mµ Dung
--Author: mrhong@2gvn
--Date: 1/3/2012

x000502_g_scriptId = 000502
XinfaList={
		{name="Giang Nam Kiªm Quyªt", id=64, exp = 200, money=50},
		{name="Sát Tr§n Quyªt", id=65, exp = 300, money=100},
		{name="Viêm Dß½ng Tâm Pháp", id=66, exp = 400, money=150},
		{name="Thanh Vân Bí T¸ch", id=67, exp = 500, money=200},
		{name="Sß½ng Lînh Kiªm Thu§t", id=68, exp = 600, money=250},
		{name="Tinh Nguy®t Yêu Thu§t", id=69, exp = 700, money=300},
		{name="Tham Hþp Công", id=70, exp = 800, money=350},
--		{name="Ðµn Dân Ði¬n Bí", id=71, exp = 900, money=400},
}
TableExpMoney={}
TableExpMoney[164]={exp = 2841, money =325}
TableExpMoney[264]={exp = 13545, money =1043}
TableExpMoney[364]={exp = 66109, money =10060}
TableExpMoney[464]={exp = 246916, money =30934}
TableExpMoney[564]={exp = 609924, money =85769}
TableExpMoney[664]={exp = 1225993, money =159301}
TableExpMoney[764]={exp = 2207606, money =280465}
TableExpMoney[864]={exp = 4387275, money =483428}
TableExpMoney[964]={exp = 27178860, money =769457}
TableExpMoney[1064]={exp = 174465300, money =1138546}
TableExpMoney[1164]={exp = 285625860, money =1967319}
TableExpMoney[1264]={exp = 267299868, money =3407302}

TableExpMoney[165]={exp = 8519, money =1820}
TableExpMoney[265]={exp = 40632, money =7852}
TableExpMoney[365]={exp = 198325, money =56326}
TableExpMoney[465]={exp = 740745, money =173227}
TableExpMoney[565]={exp = 1829770, money =480296}
TableExpMoney[665]={exp = 3677977, money =892076}
TableExpMoney[765]={exp = 6622813, money =1570601}
TableExpMoney[865]={exp = 13161820, money =2707198}
TableExpMoney[965]={exp = 81536575, money =4308951}
TableExpMoney[1065]={exp = 523393895, money =6375854}
TableExpMoney[1165]={exp = 856877575, money =10016968}
TableExpMoney[1265]={exp = 801899600, money =19080857}

TableExpMoney[166]={exp = 8519, money =1820}
TableExpMoney[266]={exp = 40632, money =7852}
TableExpMoney[366]={exp = 198325, money =56326}
TableExpMoney[466]={exp = 740745, money =173227}
TableExpMoney[566]={exp = 1829770, money =480296}
TableExpMoney[666]={exp = 3677977, money =892076}
TableExpMoney[766]={exp = 6622813, money =1570601}
TableExpMoney[866]={exp = 13161820, money =2707198}
TableExpMoney[966]={exp = 81536575, money =4308951}
TableExpMoney[1066]={exp = 523393895, money =6375854}
TableExpMoney[1166]={exp = 856877575, money =10016968}
TableExpMoney[1266]={exp = 801899600, money =19080857}

TableExpMoney[167]={exp = 4260, money =490}
TableExpMoney[267]={exp = 20316, money =2105}
TableExpMoney[367]={exp = 99164, money =15089}
TableExpMoney[467]={exp = 370373, money =46400}
TableExpMoney[567]={exp = 914886, money =128652}
TableExpMoney[667]={exp = 1838990, money =238950}
TableExpMoney[767]={exp = 3311406, money =420698}
TableExpMoney[867]={exp = 6580919, money =725144}
TableExpMoney[967]={exp = 40768287, money =1154184}
TableExpMoney[1067]={exp = 261697947, money =1707820}
TableExpMoney[1167]={exp = 428438788, money =2950979}
TableExpMoney[1267]={exp = 400949800, money =5110946}

TableExpMoney[168]={exp = 4260, money =490}
TableExpMoney[268]={exp = 20316, money =2105}
TableExpMoney[368]={exp = 99164, money =15089}
TableExpMoney[468]={exp = 370373, money =46400}
TableExpMoney[568]={exp = 914886, money =128652}
TableExpMoney[668]={exp = 1838990, money =238950}
TableExpMoney[768]={exp = 3311406, money =420698}
TableExpMoney[868]={exp = 6580919, money =725144}
TableExpMoney[968]={exp = 40768287, money =1154184}
TableExpMoney[1068]={exp = 261697947, money =1707820}
TableExpMoney[1168]={exp = 428438788, money =2950979}
TableExpMoney[1268]={exp = 400949800, money =5110946}

TableExpMoney[169]={exp = 8519, money =1820}
TableExpMoney[269]={exp = 40632, money =7852}
TableExpMoney[369]={exp = 198325, money =56326}
TableExpMoney[469]={exp = 740745, money =173227}
TableExpMoney[569]={exp = 1829770, money =480296}
TableExpMoney[669]={exp = 3677977, money =892076}
TableExpMoney[769]={exp = 6622813, money =1570601}
TableExpMoney[869]={exp = 13161820, money =2707198}
TableExpMoney[969]={exp = 81536575, money =4308951}
TableExpMoney[1069]={exp = 523393895, money =6375854}
TableExpMoney[1169]={exp = 856877575, money =10016968}
TableExpMoney[1269]={exp = 801899600, money =19080857}

TableExpMoney[170]={exp = 11356, money =1950}
TableExpMoney[270]={exp = 54174, money =8414}
TableExpMoney[370]={exp = 264432, money =60349}
TableExpMoney[470]={exp = 987658, money =185601}
TableExpMoney[570]={exp = 2439692, money =514603}
TableExpMoney[670]={exp = 4903968, money =955798}
TableExpMoney[770]={exp = 8830414, money =1682787}
TableExpMoney[870]={exp = 17549090, money =2900571}
TableExpMoney[970]={exp = 108715430, money =4616733}
TableExpMoney[1070]={exp = 697861190, money =6831273}
TableExpMoney[1170]={exp = 1142503430, money =11803899}
TableExpMoney[1270]={exp = 1069199464, money =20443776}

function x000502_OnDefaultEvent( sceneId, selfId,targetId )

	BeginEvent(sceneId)
		if GetMenPai(sceneId, selfId) == 9 and GetHumanMenpaiPoint(sceneId, selfId) ~= 0 then
			AddText(sceneId,"Ðßþc chß·ng môn tr÷ng døng, ta lo vi®c chï dÕy các ð® tØ m¾i nh§p môn")
			AddNumText(sceneId, x000502_g_scriptId, "KÛ nång h÷c t§p",12,1)
			AddNumText(sceneId, x000502_g_scriptId, "Gi¾i thi®u v« tâm pháp",11,2)
		else
			AddText(sceneId,"Ðßþc chß·ng môn tr÷ng døng, ta lo vi®c chï dÕy các ð® tØ m¾i nh§p môn")
		end
	EndEvent(sceneId)
	DispatchEventList(sceneId,selfId,targetId)
end

function x000502_OnEventRequest( sceneId, selfId, targetId, eventId )
	if 	GetNumText()==2	then
		x000502_AddMsg( sceneId, selfId, targeId, "#{function_xinfajieshao_001}")
		return
	end

	if	GetNumText()==1	then
		if GetMenPai(sceneId, selfId) == 9 and GetHumanMenpaiPoint(sceneId, selfId) ~= 0 then
			BeginEvent(sceneId)
				AddText(sceneId,"Ch÷n cu¯n bí t¸ch mu¯n nâng tâm pháp:")
				for i = 1, getn( XinfaList ) do
					AddNumText( sceneId, x000502_g_scriptId, XinfaList[i].name, 12, XinfaList[i].id )
				end
			EndEvent(sceneId)
			DispatchEventList(sceneId,selfId,targetId)
		else
			BeginEvent(sceneId)
				AddText(sceneId,"Các hÕ không thuµc phái Mµ Dung")
			EndEvent(sceneId)
			DispatchEventList(sceneId,selfId,targetId)
			return
		end

	end

	for i = 1, getn( XinfaList ) do
		if GetNumText()==XinfaList[i].id then
			local XinfaLevel = LuaFnGetXinFaLevel(sceneId, selfId, XinfaList[i].id)
			local GetTableExpMoney = TableExpMoney[floor(XinfaLevel/10)*100+XinfaList[i].id+100]
			local NeedEXP = GetTableExpMoney.exp
			local NeedVang,NeedBac,NeedDong = x000502_ShowMoney(sceneId, selfId, GetTableExpMoney.money)
			local GetVang,GetBac,GetDong = x000502_ShowMoney(sceneId, selfId, GetMoney(sceneId, selfId))
			if XinfaLevel <= 0 then
				x000502_AddMsg( sceneId, selfId, targeId, "Các hÕ chßa h÷c Bí t¸ch này.")
				return
			end
			BeginEvent(sceneId)
				AddText(sceneId,"#cffcc00Bí t¸ch:#G "..XinfaList[i].name.."\n ")
				AddText(sceneId,"#cffcc00Tâm pháp hi®n tÕi:      #W"..XinfaLevel.."        \n#cffcc00Tâm pháp tiªp theo:#W   "..(XinfaLevel+10).."\n ")
				AddText(sceneId,"#cffcc00EXP có:                     #W"..GetExp(sceneId, selfId).."                    \n#cffcc00EXP c¥n:#W                   "..NeedEXP.."\n ")
				AddText(sceneId,"#cffcc00Ti«n vàng có:#W            "..GetVang.."#-02"..GetBac.."#-03"..GetDong.."#-04  \n#cffcc00Ti«n vàng c¥n:#W           "..NeedVang.."#-02"..NeedBac.."#-03"..NeedDong.."#-04")
				AddNumText( sceneId, x000502_g_scriptId, "H÷c", 5, XinfaList[i].id*10 )
			EndEvent(sceneId)
			DispatchEventList(sceneId,selfId,targetId)
		end
	end
	for i = 1, getn( XinfaList ) do
		if GetNumText()==XinfaList[i].id*10 then
			local XinfaLevel =LuaFnGetXinFaLevel(sceneId, selfId, XinfaList[i].id)
			local GetTableExpMoney = TableExpMoney[floor(XinfaLevel/10)*100+XinfaList[i].id+100]
			if XinfaLevel >= 119 then
				x000502_AddTips( sceneId, selfId, "Tâm pháp cüa các hÕ ðã ðÕt mÑc gi¾i hÕn!")
				return
			end
			if GetExp(sceneId, selfId) < GetTableExpMoney.exp then
				x000502_AddTips( sceneId, selfId, "Không ðü kinh nghi®m ð¬ thång c¤p")
				return
			end
			if GetMoney(sceneId, selfId) < GetTableExpMoney.money then
				x000502_AddTips( sceneId, selfId, "Không ðü ti«n ð¬ thång c¤p")
				return
			end
			if XinfaLevel - GetLevel(sceneId, selfId) >= 5 then
				x000502_AddTips( sceneId, selfId, "ÐÆng c¤p tâm pháp ðã ð£t t¾i c¤p cao nh¤t")
				x000502_AddTips( sceneId, selfId, "Xin nâng cao ðÆng c¤p nhân v§t")
				return
			end
			local reply = CostMoney(sceneId,selfId,GetTableExpMoney.money)
			if reply == -1 then
				x000502_AddTips( sceneId, selfId, "Không ðü ti«n ð¬ thång c¤p")
				return
			end
			AddExp(sceneId, selfId, -GetTableExpMoney.exp)
			if 119 - XinfaLevel < 10 then 
				LuaFnSetXinFaLevel(sceneId, selfId, XinfaList[i].id, 119)
			else 
				LuaFnSetXinFaLevel(sceneId, selfId, XinfaList[i].id, XinfaLevel+10)
			end
			LuaFnSendSpecificImpactToUnit(sceneId,selfId,selfId,selfId,18,0)
			x000502_AddMsg( sceneId, selfId, targeId, "Tång c¤p tâm pháp thành công.")
			return
		end
	end

end
function x000502_ShowMoney(sceneId, selfId, money)
	local vang = floor(money/10000)
	local bac = floor((money - vang*10000)/100)
	local dong = money - vang*10000 - bac*100
	return vang,bac,dong
end
function x000502_AddMsg( sceneId, selfId, targetId, msg)
	BeginEvent(sceneId)
		AddText(sceneId, msg)
	EndEvent(sceneId)
	DispatchEventList(sceneId, selfId, targetId)
end

function x000502_AddTips( sceneId, selfId, tips)
	BeginEvent(sceneId)
		AddText(sceneId, tips)
	EndEvent(sceneId)
	DispatchMissionTips(sceneId, selfId)
end
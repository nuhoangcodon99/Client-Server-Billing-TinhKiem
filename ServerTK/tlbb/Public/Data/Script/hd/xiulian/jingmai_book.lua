--Ê¹ÓÃÅä·½µÄ½Å±¾

--½Å±¾ºÅ
x840005_g_scriptId = 840005

x840005_g_SkillBooks = {}

-- ItemTable ºÅÎªË÷Òý

-- type: ÊéµÄÀàÐÍ£¬1 ±íÊ¾ÐÄ·¨£¬2 ±íÊ¾¼¼ÄÜ
-- menpaiId: Ñ§Ï°µÄ¶ÔÓ¦Åä·½ºÅ
-- MP_SHAOLIN	= 0
-- MP_MINGJIAO	= 1
-- MP_GAIBANG	= 2
-- MP_WUDANG	= 3
-- MP_EMEI		= 4
-- MP_XINGSU	= 5
-- MP_DALI		= 6
-- MP_TIANSHAN	= 7
-- MP_XIAOYAO	= 8
-- MP_WUMENPAI	= 9


x840005_g_SkillBooks[30310001] = { mp = 0	, id = 1950	,huyet = 0 }
x840005_g_SkillBooks[30310010] = { mp = 1	,id = 1959	,huyet = 0 }
x840005_g_SkillBooks[30310019] = { mp = 2	,id = 1968	,huyet = 0 }
x840005_g_SkillBooks[30310028] = { mp = 3	,id = 1977	,huyet = 0 }
x840005_g_SkillBooks[30310037] = { mp = 4	,id = 1986	,huyet = 0 }
x840005_g_SkillBooks[30310046] = { mp = 5	,id = 1995	,huyet = 0 }
x840005_g_SkillBooks[30310055] = { mp = 6	,id = 2004	,huyet = 0 }
x840005_g_SkillBooks[30310064] = { mp = 7	,id = 2013	,huyet = 0 }
x840005_g_SkillBooks[30310073] = { mp = 8	,id = 2022	,huyet = 0 }
x840005_g_SkillBooks[30310082] = { mp = 10	,id = 2031	,huyet = 0 }

x840005_g_SkillBooks[30310002] = { mp = 	0	, id = 1951	,huyet = 1 }
x840005_g_SkillBooks[30310003] = { mp = 	0	, id = 1952	,huyet = 1 }
x840005_g_SkillBooks[30310011] = { mp = 	1	, id = 1960	,huyet = 1 }
x840005_g_SkillBooks[30310012] = { mp = 	1	, id = 1961	,huyet = 1 }
x840005_g_SkillBooks[30310020] = { mp = 	2	, id = 1969	,huyet = 1 }
x840005_g_SkillBooks[30310021] = { mp = 	2	, id = 1970	,huyet = 1 }
x840005_g_SkillBooks[30310029] = { mp = 	3	, id = 1978	,huyet = 1 }
x840005_g_SkillBooks[30310030] = { mp = 	3	, id = 1979	,huyet = 1 }
x840005_g_SkillBooks[30310038] = { mp = 	4	, id = 1987	,huyet = 1 }
x840005_g_SkillBooks[30310039] = { mp = 	4	, id = 1988	,huyet = 1 }
x840005_g_SkillBooks[30310047] = { mp = 	5	, id = 1996	,huyet = 1 }
x840005_g_SkillBooks[30310048] = { mp = 	5	, id = 1997	,huyet = 1 }
x840005_g_SkillBooks[30310056] = { mp = 	6	, id = 2005	,huyet = 1 }
x840005_g_SkillBooks[30310057] = { mp = 	6	, id = 2006	,huyet = 1 }
x840005_g_SkillBooks[30310065] = { mp = 	7	, id = 2014	,huyet = 1 }
x840005_g_SkillBooks[30310066] = { mp = 	7	, id = 2015	,huyet = 1 }
x840005_g_SkillBooks[30310074] = { mp = 	8	, id = 2023	,huyet = 1 }
x840005_g_SkillBooks[30310075] = { mp = 	8	, id = 2024	,huyet = 1 }
x840005_g_SkillBooks[30310083] = { mp = 	10	, id = 2032	,huyet = 1 }
x840005_g_SkillBooks[30310084] = { mp = 	10	, id = 2033	,huyet = 1 }
x840005_g_SkillBooks[30310093] = { mp = 	1	, id = 2042	,huyet = 1 }
x840005_g_SkillBooks[30310095] = { mp = 	10	, id = 2044	,huyet = 1 }

x840005_g_SkillBooks[30310006] = { mp = 	-1	, id = 1955	,huyet = 2 }
x840005_g_SkillBooks[30310007] = { mp = 	-1	, id = 1956	,huyet = 2 }
x840005_g_SkillBooks[30310015] = { mp = 	-1	, id = 1964	,huyet = 2 }
x840005_g_SkillBooks[30310016] = { mp = 	-1	, id = 1965	,huyet = 2 }
x840005_g_SkillBooks[30310024] = { mp = 	-1	, id = 1973	,huyet = 2 }
x840005_g_SkillBooks[30310025] = { mp = 	-1	, id = 1974	,huyet = 2 }
x840005_g_SkillBooks[30310033] = { mp = 	-1	, id = 1982	,huyet = 2 }
x840005_g_SkillBooks[30310034] = { mp = 	-1	, id = 1983	,huyet = 2 }
x840005_g_SkillBooks[30310042] = { mp = 	-1	, id = 1991	,huyet = 2 }
x840005_g_SkillBooks[30310043] = { mp = 	-1	, id = 1992	,huyet = 2 }
x840005_g_SkillBooks[30310051] = { mp = 	-1	, id = 2000	,huyet = 2 }
x840005_g_SkillBooks[30310052] = { mp = 	-1	, id = 2001	,huyet = 2 }
x840005_g_SkillBooks[30310060] = { mp = 	-1	, id = 2009	,huyet = 2 }
x840005_g_SkillBooks[30310061] = { mp = 	-1	, id = 2010	,huyet = 2 }
x840005_g_SkillBooks[30310069] = { mp = 	-1	, id = 2018	,huyet = 2 }
x840005_g_SkillBooks[30310070] = { mp = 	-1	, id = 2019	,huyet = 2 }
x840005_g_SkillBooks[30310078] = { mp = 	-1	, id = 2027	,huyet = 2 }
x840005_g_SkillBooks[30310079] = { mp = 	-1	, id = 2028	,huyet = 2 }
x840005_g_SkillBooks[30310087] = { mp = 	-1	, id = 2036	,huyet = 2 }
x840005_g_SkillBooks[30310088] = { mp = 	-1	, id = 2037	,huyet = 2 }
x840005_g_SkillBooks[30310094] = { mp = 	-1	, id = 2043	,huyet = 2 }
x840005_g_SkillBooks[30310096] = { mp = 	-1	, id = 2045	,huyet = 2 }

x840005_g_SkillBooks[30310004] = { mp = 	0	, id = 1953	,huyet = 4 }
x840005_g_SkillBooks[30310005] = { mp = 	0	, id = 1954	,huyet = 4 }
x840005_g_SkillBooks[30310013] = { mp = 	1	, id = 1962	,huyet = 4 }
x840005_g_SkillBooks[30310014] = { mp = 	1	, id = 1963	,huyet = 4 }
x840005_g_SkillBooks[30310022] = { mp = 	2	, id = 1971	,huyet = 4 }
x840005_g_SkillBooks[30310023] = { mp = 	2	, id = 1972	,huyet = 4 }
x840005_g_SkillBooks[30310031] = { mp = 	3	, id = 1980	,huyet = 4 }
x840005_g_SkillBooks[30310032] = { mp = 	3	, id = 1981	,huyet = 4 }
x840005_g_SkillBooks[30310040] = { mp = 	4	, id = 1989	,huyet = 4 }
x840005_g_SkillBooks[30310041] = { mp = 	4	, id = 1990	,huyet = 4 }
x840005_g_SkillBooks[30310049] = { mp = 	5	, id = 1998	,huyet = 4 }
x840005_g_SkillBooks[30310050] = { mp = 	5	, id = 1999	,huyet = 4 }
x840005_g_SkillBooks[30310058] = { mp = 	6	, id = 2007	,huyet = 4 }
x840005_g_SkillBooks[30310059] = { mp = 	6	, id = 2008	,huyet = 4 }
x840005_g_SkillBooks[30310067] = { mp = 	7	, id = 2016	,huyet = 4 }
x840005_g_SkillBooks[30310068] = { mp = 	7	, id = 2017	,huyet = 4 }
x840005_g_SkillBooks[30310076] = { mp = 	8	, id = 2025	,huyet = 4 }
x840005_g_SkillBooks[30310077] = { mp = 	8	, id = 2026	,huyet = 4 }
x840005_g_SkillBooks[30310085] = { mp = 	10	, id = 2034	,huyet = 4 }
x840005_g_SkillBooks[30310086] = { mp = 	10	, id = 2035	,huyet = 4 }
x840005_g_SkillBooks[30310091] = { mp = 	0	, id = 2040	,huyet = 4 }

x840005_g_SkillBooks[30310008] = { mp = 	-1	, id = 1957	,huyet = 5 }
x840005_g_SkillBooks[30310009] = { mp = 	-1	, id = 1958	,huyet = 5 }
x840005_g_SkillBooks[30310017] = { mp = 	-1	, id = 1966	,huyet = 5 }
x840005_g_SkillBooks[30310018] = { mp = 	-1	, id = 1967	,huyet = 5 }
x840005_g_SkillBooks[30310026] = { mp = 	-1	, id = 1975	,huyet = 5 }
x840005_g_SkillBooks[30310027] = { mp = 	-1	, id = 1976	,huyet = 5 }
x840005_g_SkillBooks[30310035] = { mp = 	-1	, id = 1984	,huyet = 5 }
x840005_g_SkillBooks[30310036] = { mp = 	-1	, id = 1985	,huyet = 5 }
x840005_g_SkillBooks[30310044] = { mp = 	-1	, id = 1993	,huyet = 5 }
x840005_g_SkillBooks[30310045] = { mp = 	-1	, id = 1994	,huyet = 5 }
x840005_g_SkillBooks[30310053] = { mp = 	-1	, id = 2002	,huyet = 5 }
x840005_g_SkillBooks[30310054] = { mp = 	-1	, id = 2003	,huyet = 5 }
x840005_g_SkillBooks[30310062] = { mp = 	-1	, id = 2011	,huyet = 5 }
x840005_g_SkillBooks[30310063] = { mp = 	-1	, id = 2012	,huyet = 5 }
x840005_g_SkillBooks[30310071] = { mp = 	-1	, id = 2020	,huyet = 5 }
x840005_g_SkillBooks[30310072] = { mp = 	-1	, id = 2021	,huyet = 5 }
x840005_g_SkillBooks[30310080] = { mp = 	-1	, id = 2029	,huyet = 5 }
x840005_g_SkillBooks[30310081] = { mp = 	-1	, id = 2030	,huyet = 5 }
x840005_g_SkillBooks[30310089] = { mp = 	-1	, id = 2038	,huyet = 5 }
x840005_g_SkillBooks[30310090] = { mp = 	-1	, id = 2039	,huyet = 5 }
x840005_g_SkillBooks[30310092] = { mp = 	-1	, id = 2041	,huyet = 5 }


x840005_g_TypeNames = {}
x840005_g_TypeNames[1] = "Bí T¸ch"
x840005_g_TypeNames[2] = "Yªu Quyªt"


function x840005_IsSkillLikeScript( sceneId, selfId )
	return 1
end


function x840005_CancelImpacts( sceneId, selfId )
	return 0
end


function x840005_OnConditionCheck( sceneId, selfId )
	-- Ð£ÑéÊ¹ÓÃµÄÎïÆ·
	if LuaFnVerifyUsedItem( sceneId, selfId ) ~= 1 then
		return 0
	end

	-- ÕÒµ½ÏàÓ¦ÌõÄ¿
	local itemTblIndex = LuaFnGetItemIndexOfUsedItem( sceneId, selfId )
	local skillBook = x840005_g_SkillBooks[itemTblIndex]
	if not skillBook then
		return 0
	end
	local Info_Skill2 ={}
	local Skill2 ={}
	local Skill2_Active = {0,0,0,0,0,0} 
	Skill2_Active[0] = 0
	Info_Skill2[1] = GetMissionData(sceneId,selfId,MD_XL2_SKILL1) -- save thong tin item
	Info_Skill2[2] = GetMissionData(sceneId,selfId,MD_XL2_SKILL2) -- save thong tin item
	Info_Skill2[3] = GetMissionData(sceneId,selfId,MD_XL2_SKILL3) -- save thong tin item
	Info_Skill2[4] = GetMissionData(sceneId,selfId,MD_XL2_SKILL4) -- save thong tin item
	for i=1,4 do	-- Tách thông tin quy¬n bí t¸ch 2
		Skill2[i] = mod(Info_Skill2[i],1000)
	end
		--x840005_NotifyFailTips( sceneId, selfId, "Ngß"..Skill2_Active[0])
	if Skill2[1] >= 0 then
		Skill2_Active[0] = 1
	end
	if Skill2[1] >= 10 then
		Skill2_Active[1] = 1
		Skill2_Active[2] = 1
		Skill2_Active[3] = 1
	end
	if Skill2[1] >= 20 and Skill2[2] >= 20 then 
		Skill2_Active[4] = 1
		Skill2_Active[5] = 1
		Skill2_Active[6] = 1
	end

	local menpai = GetMenPai( sceneId, selfId )
	if -1~=skillBook.mp then
		 if menpai ~= skillBook.mp then
			  x840005_NotifyFailTips( sceneId, selfId, "Ngß½i không phäi là #{_MENPAI" .. skillBook.mp .. "} ð® tØ." )
			return 0
		 end
	end

	if GetLevel( sceneId, selfId ) < 90 then
		x840005_NotifyFailTips( sceneId, selfId, "Không ðü c¤p ðµ, không th¬ h÷c " .. x840005_g_TypeNames[skillBook.type] .. "." )
		return 0
	end
	local hName = ""
	if skillBook.huyet == 0 then hName = "Thiên Tình" 
	elseif skillBook.huyet == 1 then hName = "Dß½ng Tri" 
	elseif skillBook.huyet == 2 then hName = "Huyªt Häi ho£c C½ Môn" 
	elseif skillBook.huyet == 3 then hName = "C½ Môn" 
	elseif skillBook.huyet == 4 then hName = "Khí Häi" 
	elseif skillBook.huyet == 5 then hName = "Chí Dß½ng ho£c Th¥n Ðinh" 
	elseif skillBook.huyet == 6 then hName = "Th¥n Ðinh" end

	if Skill2_Active[skillBook.huyet] < 1 then
		x840005_NotifyFailTips( sceneId, selfId, "Huy®t v¸ "..hName.." chßa ðßþc kích hoÕt, không th¬ h÷c." )
		return 0
	end

	if HaveSkill( sceneId, selfId, skillBook.id ) == 1 then
		x840005_NotifyFailTips( sceneId, selfId, "Huy®t v¸ "..hName.." ðã ðßþc ðä thông kÛ nång này. Không th¬ h÷c tiªp." )
		return 0
	end

	local CheckAllSkill = 0
	for i = 30310001, 30310096 do
		if HaveSkill( sceneId, selfId, x840005_g_SkillBooks[i].id ) == 1 and skillBook.huyet == x840005_g_SkillBooks[i].huyet then
			CheckAllSkill = CheckAllSkill+1
		end
	end
 	
	if skillBook.mp == -1 then
		if CheckAllSkill > 1 then
			x840005_NotifyFailTips( sceneId, selfId, "Huy®t v¸ "..hName.." ðã ðßþc ðä thông kÛ nång khác. Không th¬ h÷c tiªp." )
			return 0
		end
	else
		if  CheckAllSkill > 0 then 
			x840005_NotifyFailTips( sceneId, selfId, "Huy®t v¸ "..hName.." ðã ðßþc ðä thông kÛ nång khác. Không th¬ h÷c tiªp." )
			return 0
		end
	end
	return 1
end


function x840005_OnDeplete( sceneId, selfId )
	if LuaFnDepletingUsedItem( sceneId, selfId ) > 0 then
		return 1
	end

	return 0
end


function x840005_OnActivateOnce( sceneId, selfId )

	local itemTblIndex = LuaFnGetItemIndexOfUsedItem( sceneId, selfId )
	local skillBook = x840005_g_SkillBooks[itemTblIndex]
	if not skillBook then
		return 0
	end
	if HaveSkill( sceneId, selfId, skillBook.id ) == 1 then
		x840005_NotifyFailTips( sceneId, selfId, "Huy®t v¸ ðã ðßþc ðä thông kÛ nång này. Không th¬ h÷c tiªp." )
		return 0
	else
			AddSkill( sceneId, selfId, skillBook.id )
	end
	local Info_Skill2 ={}
	Info_Skill2[1] = GetMissionData(sceneId,selfId,MD_XL2_SKILL1) -- save thong tin item
	Info_Skill2[2] = GetMissionData(sceneId,selfId,MD_XL2_SKILL2) -- save thong tin item
	Info_Skill2[3] = GetMissionData(sceneId,selfId,MD_XL2_SKILL3) -- save thong tin item
	Info_Skill2[4] = GetMissionData(sceneId,selfId,MD_XL2_SKILL4) -- save thong tin item
		local MySex = LuaFnGetSex(sceneId, selfId)
		BeginUICommand( sceneId )
			UICommand_AddInt( sceneId, MySex ) -- Tra ve client chi so cong luc
			for i=1,4 do
				UICommand_AddInt( sceneId, Info_Skill2[i] )
			end
		EndUICommand( sceneId )
		DispatchUICommand( sceneId, selfId, 3000001 )
		--x000560_Notice(sceneId,selfId,"sv--"..MySex)

	LuaFnSendSpecificImpactToUnit( sceneId, selfId, selfId, selfId, skillBook.specialEffectID, 0 )
	return 1
end


function x840005_OnActivateEachTick( sceneId, selfId )
	return 1
end


function x840005_NotifyFailTips( sceneId, selfId, Tip )
	BeginEvent( sceneId )
		AddText( sceneId, Tip )
	EndEvent( sceneId )
	DispatchMissionTips( sceneId, selfId )
end

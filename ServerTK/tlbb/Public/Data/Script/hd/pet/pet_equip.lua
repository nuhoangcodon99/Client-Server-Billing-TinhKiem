--Pet Equip
--Author: phihong
--Date: 2/10

x000203_g_scriptId = 000203
x000203_g_Item = {}
x000203_g_Item[30000501] = { type = 1, skill = 1801, obj1 = 9801, obj2 = 9806, obj3 = -1}
x000203_g_Item[30000502] = { type = 2, skill = 1802, obj1 = 9802, obj2 = 9807, obj3 = -1}
x000203_g_Item[30000503] = { type = 3, skill = 1803, obj1 = 9803, obj2 = 9808, obj3 = -1}
x000203_g_Item[30000504] = { type = 4, skill = 1804, obj1 = 9804, obj2 = 9809, obj3 = -1}
x000203_g_Item[30000505] = { type = 5, skill = 1805, obj1 = 9805, obj2 = 9810, obj3 = -1}

x000203_g_Item[30000506] = { type = 1, skill = 1806, obj1 = 9811, obj2 = 9816, obj3 = -1}
x000203_g_Item[30000507] = { type = 2, skill = 1807, obj1 = 9812, obj2 = 9817, obj3 = -1}
x000203_g_Item[30000508] = { type = 3, skill = 1808, obj1 = 9813, obj2 = 9818, obj3 = -1}
x000203_g_Item[30000509] = { type = 4, skill = 1809, obj1 = 9814, obj2 = 9819, obj3 = -1}
x000203_g_Item[30000510] = { type = 5, skill = 1810, obj1 = 9815, obj2 = 9820, obj3 = -1}

x000203_g_Item[30000511] = { type = 1, skill = 1811, obj1 = 9821, obj2 = 9826, obj3 = -1}
x000203_g_Item[30000512] = { type = 2, skill = 1812, obj1 = 9822, obj2 = 9827, obj3 = -1}
x000203_g_Item[30000513] = { type = 3, skill = 1813, obj1 = 9823, obj2 = 9828, obj3 = -1}
x000203_g_Item[30000514] = { type = 4, skill = 1814, obj1 = 9824, obj2 = 9829, obj3 = -1}
x000203_g_Item[30000515] = { type = 5, skill = 1815, obj1 = 9825, obj2 = 9830, obj3 = -1}

x000203_g_Item[30000516] = { type = 1, skill = 1816, obj1 = 9831, obj2 = 9836, obj3 = 9841}
x000203_g_Item[30000517] = { type = 2, skill = 1817, obj1 = 9832, obj2 = 9837, obj3 = 9842}
x000203_g_Item[30000518] = { type = 3, skill = 1818, obj1 = 9833, obj2 = 9838, obj3 = 9843}
x000203_g_Item[30000519] = { type = 4, skill = 1819, obj1 = 9834, obj2 = 9839, obj3 = -1}
x000203_g_Item[30000520] = { type = 5, skill = 1820, obj1 = 9835, obj2 = 9840, obj3 = 9844}

x000203_g_Item[30000521] = { type = 1, skill = 1821, obj1 = 9851, obj2 = 9856, obj3 = -1}
x000203_g_Item[30000522] = { type = 2, skill = 1822, obj1 = 9852, obj2 = 9857, obj3 = -1}
x000203_g_Item[30000523] = { type = 3, skill = 1823, obj1 = 9853, obj2 = 9858, obj3 = -1}
x000203_g_Item[30000524] = { type = 4, skill = 1824, obj1 = 9854, obj2 = 9859, obj3 = -1}
x000203_g_Item[30000525] = { type = 5, skill = 1825, obj1 = 9855, obj2 = 9860, obj3 = -1}

x000203_g_Item[30000526] = { type = 1, skill = 1826, obj1 = 9861, obj2 = 9866, obj3 = -1}
x000203_g_Item[30000527] = { type = 2, skill = 1827, obj1 = 9862, obj2 = 9867, obj3 = -1}
x000203_g_Item[30000528] = { type = 3, skill = 1828, obj1 = 9863, obj2 = 9868, obj3 = -1}
x000203_g_Item[30000529] = { type = 4, skill = 1829, obj1 = 9864, obj2 = 9869, obj3 = -1}
x000203_g_Item[30000530] = { type = 5, skill = 1830, obj1 = 9865, obj2 = 9870, obj3 = -1}

x000203_g_Item[30000531] = { type = 1, skill = 1831, obj1 = 9871, obj2 = 9876, obj3 = 9881}
x000203_g_Item[30000532] = { type = 2, skill = 1832, obj1 = 9872, obj2 = 9877, obj3 = 9882}
x000203_g_Item[30000533] = { type = 3, skill = 1833, obj1 = 9873, obj2 = 9878, obj3 = 9883}
x000203_g_Item[30000534] = { type = 4, skill = 1834, obj1 = 9874, obj2 = 9879, obj3 = -1}
x000203_g_Item[30000535] = { type = 5, skill = 1835, obj1 = 9875, obj2 = 9880, obj3 = 9884}

x000203_g_Item[30000536] = { type = 1, skill = 1836, obj1 = 9891, obj2 = 9896, obj3 = -1}
x000203_g_Item[30000537] = { type = 2, skill = 1837, obj1 = 9892, obj2 = 9897, obj3 = -1}
x000203_g_Item[30000538] = { type = 3, skill = 1838, obj1 = 9893, obj2 = 9898, obj3 = -1}
x000203_g_Item[30000539] = { type = 4, skill = 1839, obj1 = 9894, obj2 = 9899, obj3 = -1}
x000203_g_Item[30000540] = { type = 5, skill = 1840, obj1 = 9895, obj2 = 9900, obj3 = -1}

x000203_g_Item[30000541] = { type = 1, skill = 1841, obj1 = 9901, obj2 = 9906, obj3 = -1}
x000203_g_Item[30000542] = { type = 2, skill = 1842, obj1 = 9902, obj2 = 9907, obj3 = -1}
x000203_g_Item[30000543] = { type = 3, skill = 1843, obj1 = 9903, obj2 = 9908, obj3 = -1}
x000203_g_Item[30000544] = { type = 4, skill = 1844, obj1 = 9904, obj2 = 9909, obj3 = -1}
x000203_g_Item[30000545] = { type = 5, skill = 1845, obj1 = 9905, obj2 = 9910, obj3 = -1}

x000203_g_Item[30000546] = { type = 1, skill = 1846, obj1 = 9911, obj2 = 9916, obj3 = 9921}
x000203_g_Item[30000547] = { type = 2, skill = 1847, obj1 = 9912, obj2 = 9917, obj3 = 9922}
x000203_g_Item[30000548] = { type = 3, skill = 1848, obj1 = 9913, obj2 = 9918, obj3 = 9923}
x000203_g_Item[30000549] = { type = 4, skill = 1849, obj1 = 9914, obj2 = 9919, obj3 = -1}
x000203_g_Item[30000550] = { type = 5, skill = 1850, obj1 = 9915, obj2 = 9920, obj3 = 9924}

function x000203_OnDefaultEvent( sceneId, selfId )
end
function x000203_IsSkillLikeScript( sceneId, selfId)
	return 1;
end
function x000203_CancelImpacts( sceneId, selfId )
	return 0;
end
function x000203_OnConditionCheck( sceneId, selfId )
	if(1~=LuaFnVerifyUsedItem(sceneId, selfId)) then
		return 0
	end
	local itemTblIndex = LuaFnGetItemIndexOfUsedItem( sceneId, selfId )
	local x000203_g_EquipId = x000203_g_Item[itemTblIndex]
	if not x000203_g_EquipId then
		return 0
	end
	local objPet = x000203_FightingPet( sceneId, selfId )
	local DelItem = 0
	for i=30000501,30000550 do
		local EquipItem = x000203_g_Item[i]
		if x000203_g_EquipId.type == EquipItem.type then
			if HaveSkill( sceneId, selfId, EquipItem.skill ) == 1 then
				if LuaFnGetPropertyBagSpace( sceneId, selfId ) < 1 then
					x000203_Notice( sceneId, selfId, "C¥n 1 ô tr¯ng trong Tay näi.")
					return
				end
				DelSkill( sceneId, selfId, EquipItem.skill )
				DelItem = i
			--	break
			end
		end
	end
	if HaveSkill( sceneId, selfId, x000203_g_EquipId.skill ) ~= 1 then 
		AddSkill( sceneId, selfId, x000203_g_EquipId.skill )
	end
	if DelItem ~= 0 then
		TryRecieveItem( sceneId, selfId, DelItem, 1 )
		if objPet > 0 then
			if LuaFnHaveImpactOfSpecificDataIndex(sceneId, objPet, x000203_g_Item[DelItem].obj1) == 1 then
				LuaFnCancelSpecificImpact(sceneId,objPet,x000203_g_Item[DelItem].obj1)
			end
			if LuaFnHaveImpactOfSpecificDataIndex(sceneId, objPet, x000203_g_Item[DelItem].obj2) == 1 then
				LuaFnCancelSpecificImpact(sceneId,objPet,x000203_g_Item[DelItem].obj2)
			end
			if LuaFnHaveImpactOfSpecificDataIndex(sceneId, objPet, x000203_g_Item[DelItem].obj3) == 1 then
				LuaFnCancelSpecificImpact(sceneId,objPet,x000203_g_Item[DelItem].obj3)
			end
		end
	end
	if objPet > 0 then 
		if LuaFnHaveImpactOfSpecificDataIndex(sceneId, objPet, x000203_g_EquipId.obj1) ~= 1 then
			LuaFnSendSpecificImpactToUnit( sceneId, objPet, objPet, objPet, x000203_g_EquipId.obj1, 0 )
		end
		if LuaFnHaveImpactOfSpecificDataIndex(sceneId, objPet, x000203_g_EquipId.obj2) ~= 1 then
			LuaFnSendSpecificImpactToUnit( sceneId, objPet, objPet, objPet, x000203_g_EquipId.obj2, 0 )
		end
		if (LuaFnHaveImpactOfSpecificDataIndex(sceneId, objPet, x000203_g_EquipId.obj3) ~= 1 and x000203_g_EquipId.obj3 ~= -1) then
			LuaFnSendSpecificImpactToUnit( sceneId, objPet, objPet, objPet, x000203_g_EquipId.obj3, 0 )
		end
	end
	return 1;
end

function x000203_OnDeplete( sceneId, selfId )
	if(0<LuaFnDepletingUsedItem(sceneId, selfId)) then
		return 1;
	end
	return 0;
end

function x000203_OnActivateOnce( sceneId, selfId )
	return 1;
end

function x000203_OnActivateEachTick( sceneId, selfId)
	return 1;
end

function x000203_UnEquipPet(sceneId, selfId, typeId)
	return --hd disbale test fix crash
	local objPet = x000203_FightingPet( sceneId, selfId )
	if typeId == 0 then
		if objPet == -1 then 
			x000203_Notice( sceneId, selfId, "Không có trân thú xu¤t chiªn.")
			return
		end
		for i=30000501,30000550 do
			local ItemId = x000203_g_Item[i]
			if HaveSkill( sceneId, selfId, ItemId.skill ) == 1 then 
				if LuaFnHaveImpactOfSpecificDataIndex(sceneId, objPet, ItemId.obj1) ~= 1 then
					LuaFnSendSpecificImpactToUnit( sceneId, objPet, objPet, objPet, ItemId.obj1, 0 )
				end
				if LuaFnHaveImpactOfSpecificDataIndex(sceneId, objPet, ItemId.obj2) ~= 1 then
					LuaFnSendSpecificImpactToUnit( sceneId, objPet, objPet, objPet, ItemId.obj2, 0 )
				end
				if (LuaFnHaveImpactOfSpecificDataIndex(sceneId, objPet, ItemId.obj3) ~= 1 and ItemId.obj3 ~= -1) then
					LuaFnSendSpecificImpactToUnit( sceneId, objPet, objPet, objPet, ItemId.obj3, 0 )
				end
			end
		end
		--x000203_Notice( sceneId, selfId, "G¡n trang b¸ trân thú thành công.")
		return
	else
		if LuaFnGetPropertyBagSpace( sceneId, selfId ) < 1 then
			x000203_Notice( sceneId, selfId, "C¥n 1 ô tr¯ng trong Tay näi.")
			return
		end
		for i=30000501,30000550 do
			local EquipId = x000203_g_Item[i]
			if typeId == EquipId.type then
				if HaveSkill( sceneId, selfId, EquipId.skill ) == 1 then 
					DelSkill( sceneId, selfId, EquipId.skill ) 
					TryRecieveItem( sceneId, selfId, i, 1 )
					if objPet >= 0 then 
						if LuaFnHaveImpactOfSpecificDataIndex(sceneId, objPet, EquipId.obj1) == 1 then
							LuaFnCancelSpecificImpact(sceneId,objPet,EquipId.obj1)
						end
						if LuaFnHaveImpactOfSpecificDataIndex(sceneId, objPet, EquipId.obj2) == 1 then
							LuaFnCancelSpecificImpact(sceneId,objPet,EquipId.obj2)
						end
						if LuaFnHaveImpactOfSpecificDataIndex(sceneId, objPet, EquipId.obj3) == 1 then
							LuaFnCancelSpecificImpact(sceneId,objPet,EquipId.obj3)
						end
					end
				end
			end
		end
	end

end

function x000203_FightingPet( sceneId, selfId )
	local	PetNum	= LuaFnGetPetCount( sceneId, selfId )
	local	i
	local	PetID_H, PetID_L
	local	objId
	if PetNum <= 0 then
		return -1
	end
	
	for i=0, PetNum-1, 1 do
		PetID_H, PetID_L = LuaFnGetPetGUID( sceneId, selfId, i )
		objId	= LuaFnGetPetObjIdByGUID( sceneId, selfId, PetID_H, PetID_L )
		
		if objId >= 0 then
			return objId
		end
	end
	return -1
end

function x000203_Notice( sceneId, selfId, strNotice)
	BeginEvent( sceneId )
		AddText( sceneId, strNotice )
	EndEvent( sceneId )
	DispatchMissionTips( sceneId, selfId )    
end